!function t(e,n,i){function r(s,a){if(!n[s]){if(!e[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);throw new Error("Cannot find module '"+s+"'")}var h=n[s]={exports:{}};e[s][0].call(h.exports,function(t){var n=e[s][1][t];return r(n?n:t)},h,h.exports,t,e,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t){window.Substance=t("./src/substance")},{"./src/substance":207}],2:[function(t,e){"use strict";var n=t("./outline");e.exports=n},{"./outline":3}],3:[function(t,e){"use strict";var n=t("substance-application").View,i=t("substance-application").$$,r=t("underscore"),o=function(t){n.call(this),this.surface=t,this.state={selectedNode:null,highlightedNodes:[]},this.$el.addClass("lens-outline"),r.bindAll(this,"mouseDown","mouseUp","mouseMove","updateVisibleArea"),this.$el.mousedown(this.mouseDown),$(window).mousemove(this.mouseMove),$(window).mouseup(this.mouseUp)};o.Prototype=function(){this.render=function(){var t=this,e=0,n=document.createDocumentFragment();this.visibleArea=i(".visible-area"),n.appendChild(this.visibleArea);var o=this.surface.$(".nodes").height(),s=this.surface.$el.height(),a=o/s;if(this.factor=a,s>=o)return this.$el.addClass("needless"),this.el.innerHTML="",void 0;var c=this.surface.getContainer(),h=c.getNodes();r.each(h,function(t){var i=this.surface.$("#"+t.id),r=i.outerHeight(!0)/a,o=$('<div class="node">').attr({id:"outline_"+t.id}).css({position:"absolute",height:r-1,top:e}).addClass(t.type).append('<div class="arrow">');n.appendChild(o[0]),e+=r},this);var u=t.surface.$el.scrollTop();return t.el.innerHTML="",t.el.appendChild(n),t.updateVisibleArea(u),this},this.updateVisibleArea=function(t){$(this.visibleArea).css({top:t/this.factor,height:this.surface.$el.height()/this.factor})},this.update=function(t){this.render(),this.state=t,this.$(".node").removeClass("selected").removeClass("highlighted"),this.$el.removeClass("figures").removeClass("citations").removeClass("errors").removeClass("remarks"),this.$el.addClass(t.context),this.$("#outline_"+t.selectedNode).addClass("selected"),r.each(t.highlightedNodes,function(t){this.$("#outline_"+t).addClass("highlighted")},this)},this.mouseDown=function(t){this._mouseDown=!0;var e=t.pageY;return t.target!==this.visibleArea?(this.offset=$(this.visibleArea).height()/2,this.mouseMove(t)):this.offset=e-$(this.visibleArea).position().top,!1},this.mouseUp=function(){this._mouseDown=!1},this.mouseMove=function(t){if(this._mouseDown){var e=t.pageY,n=(e-this.offset)*this.factor;this.surface.$el.scrollTop(n)}}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"substance-application":4,underscore:151}],4:[function(t,e){"use strict";var n=t("./src/application");n.View=t("./src/view"),n.Router=t("./src/router"),n.Controller=t("./src/controller"),n.ElementRenderer=t("./src/renderers/element_renderer"),n.$$=n.ElementRenderer.$$,e.exports=n},{"./src/application":5,"./src/controller":6,"./src/renderers/element_renderer":7,"./src/router":8,"./src/view":9}],5:[function(t,e){"use strict";var n=t("./view"),i=t("substance-util"),r=t("underscore"),o=function(t){n.call(this),this.config=t,this.__controller__=null};o.Prototype=function(){this.setRouter=function(t){this.router=t},this.start=function(t){t=t||{},t.el?(this.el=t.el,this.$el=$(this.el)):(this.$el=$("body"),this.el=this.$el[0]),this.initialize&&this.initialize(),this.render(),this.router&&this.router.start()};var t={updateRoute:!0,replace:!1};this.switchState=function(e,n,o){var s=this;n=r.extend(t,n||{});var a=this.getState();this.controller.__switchState__(e,n,function(t){if(t)return o?o(t):(console.error(t.message),i.printStackTrace(t)),void 0;if(n.updateRoute&&s.updateRoute(n),s.afterTransition)try{s.afterTransition(e,a)}catch(r){return o?o(r):(console.error(r.message),i.printStackTrace(r)),void 0}o&&o(null)})},this.stateFromFragment=function(t){function e(t){for(var e=[],n=0;n<t.length;n++)e.push({id:t[n]});return e}var n,i,r,o=t.split(";"),s=[];for(i=0;i<o.length;i++){r=o[i].split("=");var a=r[0],c=r[1];if(a&&void 0!==c)if("state"===a){var h=c.split(".");n=e(h)}else r=a.split("."),s.push({state:r[0],key:r[1],value:c})}for(i=0;i<s.length;i++){var u=s[i],l=n[u.state];l[u.key]=u.value}return n},this.getState=function(){if(!this.controller.state)return null;for(var t=[],e=this.controller;e;)t.push(e.state),e=e.childController;return t},this.updateRoute=function(t){if(this.router){t=t||{};for(var e=this.getState(),n=[],i=[],o=0;o<e.length;o++){var s=e[o];if(s){n.push(s.id);for(var a in s){var c=s[a];"id"!==a&&"__id__"!==a&&"options"!==a&&(r.isString(c)?i.push(o+"."+a+"="+c):console.error("Only String state variables are allowed"))}}}var h="state="+n.join(".")+";"+i.join(";");this.router.navigate(h,{trigger:!1,replace:t.replace})}},this.stateChanged=function(t,e,n){n.updateRoute&&this.updateRoute(n)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,Object.defineProperty(o.prototype,"controller",{set:function(t){t.setChangeListener(this),this.__controller__=t},get:function(){return this.__controller__}}),e.exports=o},{"./view":9,"substance-util":144,underscore:151}],6:[function(t,e){"use strict";var n=t("substance-util"),i=t("underscore"),r=function(){this.changeListener=null,this.state=null,this.__childController__=null};r.Prototype=function(){this.intitialize=function(){},this.dispose=function(){this.__childController__&&this.__childController__.dispose(),this.__childController__=null,this.state=null},this.transition=function(t,e){e(null)},this.switchState=function(t,e,r){!r&&i.isFunction(e)&&(r=e);var o=this;1===arguments.length&&i.isFunction(e)&&(r=e,e={}),e=e||{updateRoute:!0,replace:!1},r=r||function(i){if(i)throw console.error("Error during switch state",t,e),n.printStackTrace(i),new Error(i)};var s=this.state;this.__switchState__(t,e,function(t){return t?r(t):(o.changeListener&&o.changeListener.stateChanged(this,s,e),r(null),void 0)})},this.__switchState__=function(t,e,n){var r=this;n=n||function(t){if(t)throw new Error(t)},i.isArray(t)||(t=[t]);var o=t.shift();o.options=e;var s,a=function(){if(!s){var t=r.state;r.state=o,r.afterTransition(t)}n(null)},c=function(){try{r.transition(o,function(i,o){if(i)return n(i);if(s=o,r.childController)if(t.length>0)r.childController.__switchState__(t,e,function(t){return t?n(t):(a(),void 0)});else{if(!r.childController.AUTO_INIT)return n("Unsufficient state data provided! Child controller needs a transition!");r.childController.initialize(null,function(t){return t?n(t):(a(),void 0)})}else a()})}catch(i){n(i)}};this.state?c():this.initialize(o,function(t){return t?n(t):(r.state={id:"initialized"},c(),void 0)})},this.afterTransition=function(){},this.setChildController=function(t){this.__childController__&&this.__childController__.state&&(console.error("The child controller has not been disposed. Call 'disposeChildController()' first. However, let me do this for you once more..."),this.__childController__.dispose()),t&&(this.changeListener?t.changeListener=this.changeListener:console.error("This controller does not have a changeListener attached, so the child controller will not trigger corresponding application state changes."),this.__childController__=t)},this.disposeChildController=function(){this.__childController__&&(this.__childController__.dispose(),this.__childController__=null)},this.setChangeListener=function(t){this.changeListener=t}},r.Prototype.prototype=n.Events,r.prototype=new r.Prototype,r.State=function(t){if(i.isString(t))this.__id__=t;else{var e=arguments[0];this.__id__=e.id,i.each(e,function(t,e){"id"!==e&&(this[e]=t)},this)}},Object.defineProperty(r.State.prototype,"id",{set:function(){throw new Error("Property 'id' is immutable")},get:function(){return this.__id__}}),Object.defineProperty(r.prototype,"childController",{set:function(t){this.setChildController(t)},get:function(){return this.__childController__}}),e.exports=r},{"substance-util":144,underscore:151}],7:[function(t,e){"use strict";var n=t("substance-util"),i=t("substance-regexp"),r=function(t){return this.attributes=t,this.tagName=t.tag,this.children=t.children||[],this.text=t.text||"",this.html=t.html,delete t.children,delete t.text,delete t.html,delete t.tag,this.render()};r.Prototype=function(){this.render=function(){var t=document.createElement(this.tagName);this.html?t.innerHTML=this.html:t.textContent=this.text;for(var e in this.attributes){var n=this.attributes[e];t.setAttribute(e,n)}for(var i=0;i<this.children.length;i++){var r=this.children[i];t.appendChild(r)}return this.el=t,t}};var o=function(t,e){var e=e||{},n=/^([a-zA-Z0-9]*)/.exec(t);e.tag=n&&n[1]?n[1]:"div";var o=/#([a-zA-Z0-9_]*)/.exec(t);o&&o[1]&&(e.id=o[1]);var s=new i(/\.([a-zA-Z0-9_-]*)/g);return e.class||(e.class=s.match(t).map(function(t){return t.match[1]}).join(" ")),new r(e)};r.$$=o,r.Prototype.prototype=n.Events,r.prototype=new r.Prototype,e.exports=r},{"substance-regexp":137,"substance-util":144}],8:[function(t,e){"use strict";var n=t("substance-util"),i=t("underscore"),r=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},o=/\((.*?)\)/g,s=/(\(\?)?:\w+/g,a=/\*\w+/g,c=/[\-{}\[\]+?.,\\\^$|#\s]/g;i.extend(r.prototype,n.Events,{initialize:function(){},route:function(t,e,n){i.isRegExp(t)||(t=this._routeToRegExp(t)),i.isFunction(e)&&(n=e,e=""),n||(n=this[e]);var o=this;return r.history.route(t,function(i){var s=o._extractParameters(t,i);n&&n.apply(o,s),o.trigger.apply(o,["route:"+e].concat(s)),o.trigger("route",e,s),r.history.trigger("route",o,e,s)}),this},navigate:function(t,e){return r.history.navigate(t,e),this},_bindRoutes:function(){if(this.routes){this.routes=i.result(this,"routes");for(var t,e=i.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(c,"\\$&").replace(o,"(?:$1)?").replace(s,function(t,e){return e?t:"([^/]+)"}).replace(a,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return i.map(n,function(t){return t?decodeURIComponent(t):null})}});var h=r.History=function(){this.handlers=[],i.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},u=/^[#\/]|\s+$/g,l=/^\/+|\/+$/g,p=/msie [\w.]+/,d=/\/$/;h.started=!1,i.extend(h.prototype,n.Events,{interval:50,getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var n=this.root.replace(d,"");t.indexOf(n)||(t=t.substr(n.length))}else t=this.getHash();return t.replace(u,"")},start:function(t){if(h.started)throw new Error("Router.history has already been started");h.started=!0,this.options=i.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment(),n=document.documentMode,r=p.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);this.root=("/"+this.root+"/").replace(l,"/"),r&&this._wantsHashChange&&(this.iframe=$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e;var o=this.location,s=o.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&s&&o.hash&&(this.fragment=this.getHash().replace(u,""),this.history.replaceState({},document.title,this.root+this.fragment+o.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),h.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=i.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e),!0):void 0});return n},navigate:function(t,e){if(!h.started)return!1;if(e&&e!==!0||(e={trigger:e}),t=this.getFragment(t||""),this.fragment!==t){this.fragment=t;var n=this.root+t;if(this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}e.trigger&&this.loadUrl(t)}},_updateHash:function(t,e,n){if(n){var i=t.href.replace(/(javascript:|#).*$/,"");t.replace(i+"#"+e)}else t.hash="#"+e}}),r.history=new h,e.exports=r},{"substance-util":144,underscore:151}],9:[function(t,e){"use strict";var n=t("substance-util"),i=function(){this.$el=$("<div/>"),this.el=this.$el[0],this.dispatchDOMEvents()};i.Prototype=function(){this.dispose=function(){this.stopListening()},this.$=function(t){return this.$el.find(t)},this.dispatchDOMEvents=function(){function t(t){var e=/(\w+)\((.*)\)/.exec(t);if(!e)throw new Error("Invalid click handler '"+t+"'");return{method:e[1],args:e[2].split(",")}}var e=this;this.$el.delegate("[sbs-click]","click",function(n){var i=t($(n.currentTarget).attr("sbs-click")),r=e[i.method];return r?(r.apply(e,i.args),!1):void 0})},this.updateTitle=function(t){document.title=t,window.history.replaceState({},document.title,window.location.href)}},i.Prototype.prototype=n.Events,i.prototype=new i.Prototype,e.exports=i},{"substance-util":144}],10:[function(t,e){"use strict";var n=t("./src/article");n.Renderer=t("./src/renderer"),n.ViewFactory=t("./src/view_factory"),e.exports=n},{"./src/article":12,"./src/renderer":13,"./src/view_factory":14}],11:[function(t,e){"use strict";var n=t("underscore"),i={};n.each(t("substance-nodes"),function(t,e){i[e]=n.clone(t)}),e.exports=i},{"substance-nodes":48,underscore:151}],12:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=t("substance-document"),o=r.Annotator,s=function(t){t=t||{},t.schema=i.deepclone(r.schema),t.schema.id="substance-article",t.schema.version="0.3.0";var e=t.types||s.types;n.each(e,function(e,n){t.schema.types[n]=e});var o=t.nodeTypes||s.nodeTypes;n.each(o,function(e,n){t.schema.types[n]=e.Model.type});var a=t.indexes||s.indexes;n.each(a,function(e,n){t.schema.indexes[n]=e});var c=t.views||s.views;r.call(this,t),this.nodeTypes=o,void 0===t.seed&&(this.create({id:"document",type:"document",guid:t.id,creator:t.creator,created_at:t.created_at,views:["content"],title:"","abstract":""}),n.each(c,function(t){this.create({id:t,type:"view",nodes:[]})},this))};s.Prototype=function(){this.fromSnapshot=function(t,e){return s.fromSnapshot(t,e)},this.getAuthorNames=function(){return n.map(this.getAuthors(),function(t){return t.name})},this.getAuthors=function(){return n.map(this.authors,function(t){return this.get(t)},this)},this.setPublishedOn=function(t){this.set(["document","published_on"],t)},this.setId=function(t){this.set(["document","guid"],t)},this.setTitle=function(t){this.set(["document","title"],t)},this.setAuthors=function(t){this.set(["document","authors"],t)},this.createRenderer=function(t){return new s.Renderer(this,t)},this.getAnnotationBehavior=function(){return s.annotationBehavior}},s.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new s(e)},s.views=["content","figures","citations","info"],s.nodeTypes=t("../nodes"),s.annotationBehavior={groups:{emphasis:"style",strong:"style",link:"style",math:"style",issue:"marker"},expansion:{emphasis:{left:o.isOnNodeStart},strong:{left:o.isOnNodeStart}},split:["emphasis","strong"],levels:{idea:1,question:1,remark:1,error:1,issue:1,link:1,math:1,strong:2,emphasis:2,code:2,subscript:2,superscript:2,underline:2,cross_reference:1,figure_reference:1,person_reference:1,contributor_reference:1,citation_reference:1,remark_reference:1,error_reference:1}},s.types={document:{properties:{views:["array","view"],guid:"string",creator:"string",authors:["array","contributor"],title:"string","abstract":"string",created_at:"date",updated_at:"date",published_on:"date",meta:"object"}}},s.indexes={comments:{type:"comment",properties:["node"]}};var a={id:"article",nodes:{document:{type:"document",id:"document",views:["content","info"],title:"The Anatomy of a Substance Article",authors:["contributor_1","contributor_2"],guid:"lens_article"},content:{type:"view",id:"content",nodes:["cover"]},cover:{id:"cover",type:"cover"},contributor_1:{id:"contributor_1",type:"contributor",name:"Michael Aufreiter"},contributor_2:{id:"contributor_2",type:"contributor",name:"Oliver Buchtala"}}};s.describe=function(){var t=new s({seed:a}),e=0;return n.each(s.nodeTypes,function(i,r){if("composite"!==r){i=i.Model;var o="heading_"+i.type.id;t.create({id:o,type:"heading",content:i.description.name,level:1});var s=i.description.remarks.join(" "),a="text_"+i.type.id+"_intro";t.create({id:a,type:"text",content:s}),t.show("content",[o,a],-1),t.create({id:o+"_properties",type:"text",content:i.description.name+" uses the following properties:"}),t.show("content",[o+"_properties"],-1);var c=[];n.each(i.description.properties,function(n,i){var r="text_"+ ++e;t.create({id:r,type:"text",content:i+": "+n}),t.create({id:e+"_annotation",type:"code",path:[r,"content"],range:[0,i.length]}),c.push(r)}),t.create({id:o+"_property_list",type:"list",items:c,ordered:!1}),t.show("content",[o+"_property_list"],-1),i.example&&(t.create({id:o+"_example",type:"text",content:"Here's an example:"}),t.create({id:o+"_example_codeblock",type:"codeblock",content:JSON.stringify(i.example,null,"  ")}),t.show("content",[o+"_example",o+"_example_codeblock"],-1))}}),t},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,Object.defineProperties(s.prototype,{id:{get:function(){return this.get("document").guid},set:function(){throw new Error("This is a read-only property alias.")}},creator:{get:function(){return this.get("document").creator},set:function(){this.get("document").creator=creator}},authors:{get:function(){return this.get("document").authors},set:function(){throw new Error("This is a read-only property alias.")}},updated_at:{get:function(){return this.get("document").updated_at},set:function(t){this.get("document").updated_at=t}},created_at:{get:function(){return this.get("document").created_at},set:function(){throw new Error("This is a read-only property alias.")}},published_on:{get:function(){return this.get("document").published_on},set:function(){throw new Error("This is a read-only property alias.")}},title:{get:function(){return this.get("document").title},set:function(){throw new Error("This is a read-only property alias.")}},"abstract":{get:function(){return this.get("document").abstract},set:function(){throw new Error("This is a read-only property alias.")}},views:{get:function(){return this.get("document").views.slice(0)},set:function(){throw new Error("This is a read-only property alias.")}}}),e.exports=s},{"../nodes":11,"substance-document":35,"substance-util":144,underscore:151}],13:[function(t,e){"use strict";var n=t("./view_factory"),i=t("underscore"),r=function(t,e,i){n.call(this,t),this.viewName=e,this.options=i||{},this.nodeViews={}};r.Prototype=function(){var t=n.prototype;this.createView=function(e,n){if(this.nodeViews[e.id]&&!n)return this.nodeViews[e.id];this.nodeViews[e.id]&&n&&this.nodeViews[e.id].dispose();var i=t.createView.call(this,e);return this.nodeViews[e.id]=i,i},this.render=function(){i.each(this.nodeViews,function(t){t.dispose()});var t=document.createDocumentFragment(),e=this.document.get(this.viewName).nodes;return i.each(e,function(e){var n=this.document.get(e),i=this.createView(n);t.appendChild(i.render().el),this.options.afterRender&&this.options.afterRender(this.document,i)},this),t}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"./view_factory":14,underscore:151}],14:[function(t,e){"use strict";var n=function(t){this.document=t,this.nodeTypes=t.nodeTypes};n.Prototype=function(){this.createView=function(t){var e=this.nodeTypes[t.type].View;if(!e)throw new Error('Node type "'+t.type+'" not supported');var n=new e(t,this);return n.listenTo(this.document,"operation:applied",n.onGraphUpdate),n}},n.prototype=new n.Prototype,e.exports=n},{}],15:[function(t,e){"use strict";var n=t("./src/chronicle");n.IndexImpl=t("./src/index_impl"),n.ChronicleImpl=t("./src/chronicle_impl"),n.DiffImpl=t("./src/diff_impl"),n.TmpIndex=t("./src/tmp_index"),n.create=n.ChronicleImpl.create,n.Index.create=n.IndexImpl.create,n.Diff.create=n.DiffImpl.create,n.ArrayOperationAdapter=t("./src/array_adapter"),n.TextOperationAdapter=t("./src/text_adapter"),n.IndexedDBBackend=t("./src/backends/indexeddb_backend"),e.exports=n},{"./src/array_adapter":16,"./src/backends/indexeddb_backend":17,"./src/chronicle":18,"./src/chronicle_impl":19,"./src/diff_impl":20,"./src/index_impl":21,"./src/text_adapter":22,"./src/tmp_index":23}],16:[function(t,e){"use strict";var n=t("substance-util"),i=t("./chronicle"),r=t("substance-operator").ArrayOperation,o=function(t,e){i.Versioned.call(this,t),this.array=e};o.Prototype=function(){var t=n.prototype(this);this.apply=function(t){r.fromJSON(t).apply(this.array)},this.invert=function(t){return r.fromJSON(t).invert()},this.transform=function(t,e,n){return r.transform(t,e,n)},this.reset=function(){for(t.reset.call(this);this.array.length>0;)this.array.shift()}},o.Prototype.prototype=i.Versioned.prototype,o.prototype=new o.Prototype,e.exports=o},{"./chronicle":18,"substance-operator":130,"substance-util":144}],17:[function(t,e){"use strict";var n=t("substance-util"),i=t("underscore"),r=t("../chronicle"),o=r.Index,s=function(t,e){this.name=t,this.index=e,this.db=null};s.Prototype=function(){this.delete=function(t){var e=this;this.clear(function(){window.indexedDB.deleteDatabase(e.name),t(null)})};var t=function(t,e,n){var i=t.transaction([e],"readwrite"),r=i.objectStore(e),o=r.clear();o.onsuccess=function(){n(null)},o.onerror=function(t){n(t)}};this.clear=function(e){var i=this.db,r=["changes","snapshots","refs"];n.async.each({items:r,iterator:function(e,n){t(i,e,n)}},e)},this.open=function(t){var e=this;this.db=null;var n=window.indexedDB.open(this.name,1);n.onupgradeneeded=function(t){var e=t.target.result;e.createObjectStore("changes",{keyPath:"id"});var n=e.createObjectStore("snapshots",{keyPath:"sha"});n.createIndex("sha","sha",{unique:!0});var i=e.createObjectStore("refs",{keyPath:"name"});i.createIndex("name","name",{unique:!0})},n.onerror=function(n){console.error("Could not open database",e.name),t(n)},n.onsuccess=function(n){e.db=n.target.result,t(null)}},this.close=function(t){this.db.close(),t&&t(null)},this.load=function(t){var e=this,n=this.db.transaction(["changes","refs"]),i=n.objectStore("changes"),r=i.openCursor(),s={};r.onsuccess=function(i){var a=i.target.result;if(a)return s[a.key]=a.value,a.continue(),void 0;e.index.import(o.adapt(s));var c=n.objectStore("refs");r=c.openCursor(),r.onsuccess=function(n){var i=n.target.result;return i?(e.index.setRef(i.key,i.value.sha),i.continue(),void 0):(t(null),void 0)},r.onerror=function(e){console.error("Error during loading...",e),t(e)}},r.onerror=function(e){console.error("Error during loading...",e),t(e)}};var e=function(t,e){var n=t.db.transaction(["changes"],"readwrite");n.onerror=function(t){console.error("Error while saving changes."),e&&e(t)},n.oncomplete=function(){e&&e(null)};var i=n.objectStore("changes");t.index.foreach(function(t){var e=t;t instanceof r.Change&&(e=t.toJSON());var n=i.put(e);n.onerror=function(e){console.error("Could not add change: ",t.id,e)}})},s=function(t,e){var n=t.db.transaction(["refs"],"readwrite");n.onerror=function(t){console.error("Error while saving refs."),e&&e(t)},n.oncomplete=function(){e&&e(null)};var r=n.objectStore("refs");i.each(t.index.listRefs(),function(e){var n={name:e,sha:t.index.getRef(e)},i=r.put(n);i.onerror=function(t){console.error("Could not store ref: ",n,t)}})};this.save=function(t){var n=this;e(n,function(e){return e?t(e):(s(n,t),void 0)})},this.saveSnapshot=function(t,e,n){var i=this.db.transaction(["snapshots"],"readwrite");i.oncomplete=function(){n(null)},i.onerror=function(t){console.error("Error while saving snapshot."),n(t)};var r=i.objectStore("snapshots"),o=e;o.toJSON&&(o=o.toJSON()),o.sha=t;var s=r.put(o);s.onerror=function(t){console.error("Could not add snapshot: ",o,t)}},this.listSnapshots=function(t){var e=this.db.transaction(["snapshots"],"readonly"),n=e.objectStore("snapshots"),i=n.index("sha"),r=i.openCursor(),o=[];r.onsuccess=function(e){var n=e.target.result;return n?(o.push(n.key),n.continue(),void 0):(t(null,o),void 0)},r.onerror=function(e){console.error("Error during loading...",e),t(e)}},this.getSnapshot=function(t,e){var n=this.db.transaction(["snapshots"],"readonly"),i=n.objectStore("snapshots"),r=i.get(t);r.onsuccess=function(t){var n=t.target.result;e(null,n)},r.onerror=function(n){console.error("Error: could not load snapshot for sha",t),e(n)}}},s.prototype=new s.Prototype,e.exports=s},{"../chronicle":18,"substance-util":144,underscore:151}],18:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=i.errors;r.define("ChronicleError",-1),r.define("ChangeError",-1);var o=function(t,e,n){if(this.type="change",!t)throw new r.ChangeError("Every change needs a unique id.");if(this.id=t,!e)throw new r.ChangeError("Every change needs a parent.");this.parent=e,this.data=n,this.uuid=i.uuid};o.prototype={toJSON:function(){return{type:this.type,id:this.id,parent:this.parent,data:this.data}}},o.fromJSON=function(t){return t.type===c.TYPE?new c(t):t.type===h.TYPE?new h(t):new o(t.parent,t.data,t)};var s="ROOT",a=new o(s,!0,null);a.parent=s;var c=function(t,e,n){if(o.call(this,t,e),this.type=c.TYPE,!n)throw new r.ChangeError("Missing branches.");this.branches=n};c.Prototype=function(){var t=i.prototype(this);this.toJSON=function(){var e=t.toJSON.call(this);return e.type=c.TYPE,e.branches=this.branches,e}},c.Prototype.prototype=o.prototype,c.prototype=new c.Prototype,c.TYPE="merge",c.fromJSON=function(t){if(t.type!==c.TYPE)throw new r.ChangeError("Illegal data for deserializing a Merge node.");return new c(t.parent,t.branches,t)};var h=function(t,e,n,i){o.call(this,t,e,n),this.type=h.TYPE,this.original=i};h.Prototype=function(){var t=i.prototype(this);this.toJSON=function(){var e=t.toJSON.call(this);return e.type=h.TYPE,e.original=this.original,e}},h.TYPE="transformed",h.fromJSON=function(t){if(t.type!==h.TYPE)throw new r.ChangeError("Illegal data for deserializing a Transformed node.");return new h(t.parent,t.data,t.original,t)},h.Prototype.prototype=o.prototype,h.prototype=new h.Prototype;var u=function(){};u.prototype={hasReverts:function(){throw new r.SubstanceError("Not implemented.")},reverts:function(){throw new r.SubstanceError("Not implemented.")},hasApplies:function(){throw new r.SubstanceError("Not implemented.")},applies:function(){throw new r.SubstanceError("Not implemented.")},sequence:function(){throw new r.SubstanceError("Not implemented.")},mine:function(){throw new r.SubstanceError("Not implemented.")},theirs:function(){throw new r.SubstanceError("Not implemented.")},root:function(){throw new r.SubstanceError("Not implemented.")},start:function(){throw new r.SubstanceError("Not implemented.")},end:function(){throw new r.SubstanceError("Not implemented.")},inverted:function(){throw new r.SubstanceError("Not implemented.")}},u.create=function(){throw new r.SubstanceError("Not implemented.")};var l=function(t,e){e=e||{},this.index=t,this.versioned=null,this.__mode__=e.mode||l.DEFAULT_MODE};l.Prototype=function(){this.record=function(){throw new r.SubstanceError("Not implemented.")},this.open=function(){throw new r.SubstanceError("Not implemented.")},this.step=function(){throw new r.SubstanceError("Not implemented.")},this.forward=function(t){var e=this.versioned.getState();if(e!==t){var n=this.index.children[e];if(0!==n.length){var i;if(1===n.length)i=n[0];else if(t){var r=this.index.shortestPath(e,t);r.shift(),i=r.shift()}else i=n[n.length-1];return i?this.step(i):void 0}}},this.rewind=function(){var t,e=this.index.get(this.versioned.getState());return e.id===s?null:(t=e.parent,this.step(t))},this.merge=function(){throw new r.SubstanceError("Not implemented.")},this.manage=function(t){this.versioned=t},this.mark=function(t){this.index.setRef(t,this.versioned.getState())},this.find=function(t){return this.index.getRef(t)},this.getState=function(){return this.versioned.getState()},this.getChanges=function(t,e){var i=[],r=this.path(t,e);return n.each(r,function(t){i.push(this.index.get(t))},this),i}},l.prototype=new l.Prototype,l.PEDANTIC_RECORD=2,l.PEDANTIC_IMPORT=4,l.HYSTERICAL=l.PEDANTIC_RECORD|l.PEDANTIC_IMPORT,l.DEFAULT_MODE=l.PEDANTIC_IMPORT,l.create=function(){throw new r.SubstanceError("Not implemented.")};var p=function(){this.__id__=i.uuid(),this.changes={},this.refs={},this.children={},this.changes[s]=a,this.children[s]=[]};p.Prototype=function(){this.add=function(){throw new r.SubstanceError("Not implemented.")},this.remove=function(){throw new r.SubstanceError("Not implemented.")},this.contains=function(){throw new r.SubstanceError("Not implemented.")},this.path=function(){throw new r.SubstanceError("Not implemented.")},this.get=function(){throw new r.SubstanceError("Not implemented.")},this.getChildren=function(){throw new r.SubstanceError("Not implemented.")},this.list=function(){throw new r.SubstanceError("Not implemented.")},this.diff=function(){throw new r.SubstanceError("Not implemented.")},this.setRef=function(t,e){if(void 0===this.changes[e])throw new r.ChronicleError("Unknown change: "+e);this.refs[t]=e},this.getRef=function(t){return this.refs[t]},this.listRefs=function(){return Object.keys(this.refs)},this.import=function(){throw new r.SubstanceError("Not implemented.")}},p.prototype=new p.Prototype,p.INVALID="INVALID",p.ROOT=a,p.create=function(){throw new r.SubstanceError("Not implemented.")},p.adapt=function(t){return{list:function(){return n.keys(t)},get:function(e){return t[e]}}};var d=function(t){this.chronicle=t,this.state=s,t.manage(this)};d.Prototype=function(){this.apply=function(){throw new r.SubstanceError("Not implemented.")},this.revert=function(t){t=this.invert(t),this.apply(t)},this.invert=function(){throw new r.SubstanceError("Not implemented.")},this.transform=function(){throw new r.SubstanceError("Not implemented.")},this.getState=function(){return this.state},this.setState=function(t){this.state=t},this.reset=function(){this.state=s}},d.prototype=new d.Prototype,l.Change=o,l.Merge=c,l.Transformed=h,l.Diff=u,l.Index=p,l.Versioned=d,l.ROOT=s,l.mergeConflict=function(t,e){var n=new r.MergeConflict("Merge conflict: "+JSON.stringify(t)+" vs "+JSON.stringify(e));return n.a=t,n.b=e,n},e.exports=l},{"substance-util":144,underscore:151}],19:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=i.errors,o=t("./chronicle"),s=function(t,e){o.call(this,t,e)};s.Prototype=function(){var t=new s.__private__,e=o.Index.ROOT.id;this.uuid=i.uuid,this.internal_uuid=i.uuid,this.record=function(t){(this.__mode__&o.PEDANTIC_RECORD)>0&&(this.versioned.revert(t),this.versioned.apply(t));var e=this.versioned.getState(),n=this.uuid(),i=new o.Change(n,e,t);
return this.index.add(i),this.versioned.setState(n),n},this.reset=function(e,n){if(n=n||this.index,!n.contains(e))throw new r.ChronicleError("Invalid argument: unknown change "+e);var i=this.versioned.getState(),o=n.shortestPath(i,e);t.applySequence.call(this,o,n)},this.open=this.reset,this.path=function(t,n){if(n){if(!t)throw new r.ChronicleError("Illegal argument: "+t);return this.index.shortestPath(t,n)}var i=this.index.shortestPath(e,t||this.versioned.getState());return i.shift(),i},this.apply=function(e){return n.isArray(e)?t.applySequence.call(this,e):t.applySequence.call(this,arguments)},this.step=function(t){var e=this.index,n=this.versioned.getState();try{var i=e.get(n);if(i.id===t)return null;var o,s=e.get(t);if(i.parent===t)o=this.versioned.invert(i.data);else{if(s.parent!==i.id)throw new r.ChronicleError("Invalid apply sequence: "+t+" is not parent or child of "+i.id);o=s.data}return this.versioned.apply(o),this.versioned.setState(t),o}catch(a){throw this.reset(n,e),a}},this.merge=function(e,n,i){if(!this.index.contains(e))throw new r.ChronicleError("Invalid argument: unknown change "+e);1==arguments.length&&(n="auto",i={}),i=i||{};var s=this.versioned.getState(),a=this.index.diff(s,e);if(!a.hasApplies())return s;if(!a.hasReverts()&&!i.no_ff)return t.applyDiff.call(this,a),this.versioned.getState();var c;if("mine"===n)c=new o.Merge(this.uuid(),s,[s,e]);else if("theirs"===n)c=new o.Merge(this.uuid(),e,[s,e]);else{if("manual"!==n)throw new r.ChronicleError("Unsupported merge strategy: "+n);if(!i.sequence)throw new r.ChronicleError("Invalid argument: sequence is missing for manual merge");var h=i.sequence;c=t.manualMerge.call(this,s,e,a,h,i)}return this.index.add(c),this.reset(c.id),c.id},this.import=function(e){var n=this.index.import(e);(this.__mode__&o.PEDANTIC_IMPORT)>0&&t.importSanityCheck.call(this,n)}},s.__private__=function(){var t=this;this.applyDiff=function(e,n){if(n=n||this.index,e){var i=this.versioned.getState();if(i!==e.start())throw new r.ChronicleError("Diff can not applied on to this state. Expected: "+e.start()+", Actual: "+i);var s=null,a=[],c=[];try{var h,u,l=e.reverts(),p=e.applies();for(h=0;h<l.length;h++)u=l[h],t.revertTo.call(this,u,n),a.push(u);for(h=0;h<p.length;h++)u=p[h],t.apply.call(this,u,n),c.push(u)}catch(d){s=d}if(s&&(a.length>0||c.length>0)){var f=o.Diff.create(e.start(),a,c),g=f.inverted();try{t.applyDiff.call(this,g,n)}catch(d){console.log("Ohohhhh.... could not rollback partially applied diff.","Without bugs and in HYSTERICAL mode this should not happen.","Resetting to original state"),this.versioned.reset(),this.reset(i,n)}}if(s)throw s}},this.applySequence=function(e,i){i=i||this.index;var o=this.versioned.getState();try{var s=i.get(o);n.each(e,function(e){if(s.id!==e){var n=i.get(e);if(s.parent===e)t.revertTo.call(this,e,i);else{if(n.parent!==s.id)throw new r.ChronicleError("Invalid apply sequence: "+e+" is not parent or child of "+s.id);t.apply.call(this,e,i)}s=n}},this)}catch(a){throw this.reset(o,i),a}},this.revertTo=function(t,e){e=e||this.index;var n=this.versioned.getState(),i=e.get(n);if(!i)throw new r.ChangeError("Illegal state. 'head' is unknown: "+n);if(i.parent!==t)throw new r.ChangeError("Can not revert: change is not parent of current");i.data&&this.versioned.revert(i.data),this.versioned.setState(t)},this.apply=function(t,e){e=e||this.index;var n=e.get(t);if(!n)throw new r.ChangeError("Illegal argument. change is unknown: "+t);n.data&&this.versioned.apply(n.data),this.versioned.setState(t)},this.eliminate=function(e,n,i,s,a){if(!(s instanceof o.TmpIndex))throw new r.ChronicleError("'eliminate' must be called on a TmpIndex instance");var c,h,u=s.get(n),l=s.get(e);return c=new o.Change(this.internal_uuid(),n,this.versioned.invert(u.data)),s.add(c),h=t.rebase0.call(this,c.id,l.id,i,s,a,!0),s.reconnect(h,u.parent),l=s.get(h),l.id},this.rebase0=function(t,e,n,i,s,a){i=i||this.index;var c=i.get(t),h=i.get(e);if(c.parent!==h.parent)throw new r.ChronicleError("Illegal arguments: principal rebase can only be applied on siblings.");for(var u,l,p,d,f,g=[[c.data,c.id,h]],v=null,y=[];g.length>0;){u=g.pop(),l=u[0],t=u[1],h=u[2],p=h.data;var m;if(h instanceof o.Merge)m=[l],d=new o.Merge(this.uuid(),t,h.branches),y.push(d);else{m=this.versioned.transform(l,p,{check:a});var w=h instanceof o.Transformed?h.original:h.id;d=new o.Transformed(this.internal_uuid(),t,m[1],w),n[w]=d.id}n[h.id]=d.id,v||(v=d),i.add(d);var b=i.getChildren(h.id);for(f=0;f<b.length;f++){var _=i.get(b[f]);if(s){var x=_ instanceof o.Transformed?_.original:_.id;if(!s[x])continue}g.unshift([m[0],d.id,_])}}for(f=0;f<y.length;f++){for(var C=y[f],P=[],k=0;k<C.branches.length;k++)P.push(n[C.branches[k]]);C.branches=P}return v.id},this.eliminateToSelection=function(e,i,r,s){var a=new o.TmpIndex(s),c=n.intersection(e,i);if(0===c.length)return null;var h=n.difference(e,i).reverse();if(0===h.length)return r[c[0]];for(var u,l,p,d=0,f=0,g=null;d<e.length&&f<h.length;)l=e[e.length-1-d],p=h[f],l===p?(g&&(g=t.eliminate.call(this,g,l,r,a,r)),d++,f++):(g=l,d++);for(u=0;u<c.length;u++)l=c[u],a.save(r[l]);return r[c[0]]},this.manualMerge=function(e,i,s,a,c){if(0===a.length)throw new r.ChronicleError("Nothing selected for merge.");var h=n.intersection(a,s.sequence());if(h.length!==a.length)throw new r.ChronicleError("Illegal merge selection: contains changes that are not contained in the merged branches.");var u=new o.TmpIndex(this.index),l=s.mine(),p=s.theirs(),d=n.object(a,a);t.eliminateToSelection.call(this,l,a,d,u),t.eliminateToSelection.call(this,p,a,d,u),l=n.intersection(l,a),p=n.intersection(p,a);for(var f=0;f<a.length;f++){var g,v,y=a[f];if(0===l.length||0===p.length)break;if(l[0]===y)l.shift(),g=d[y],v=d[p[0]];else{if(p[0]!==y)throw new r.ChronicleError("Reordering of commmits is not supported.");p.shift(),g=d[y],v=d[l[0]]}t.rebase0.call(this,g,v,d,u,null,!c.force)}var m=d[n.last(a)];try{this.reset(m,u)}catch(w){throw this.reset(e,u),w}for(f=0;f<a.length;f++)u.save(d[a[f]]);return new o.Merge(this.uuid(),m,[e,i])},this.importSanityCheck=function(t){var e,n=this.versioned.getState(),i=null;try{for(e=0;e<t.length;e++)this.reset(t[e])}catch(o){i=o,console.log(i.stack)}if(this.reset(n),i){for(t.reverse(),e=0;e<t.length;e++)this.index.remove(t[e]);if(i)throw new r.ChronicleError("Import did not pass sanity check: "+i.toString())}}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,s.create=function(t){t=t||{};var e=o.Index.create(t);return new s(e,t)},e.exports=s},{"./chronicle":18,"substance-util":144,underscore:151}],20:[function(t,e){var n=t("underscore"),i=t("./chronicle"),r=function(t){this.data=t};r.Prototype=function(){this.reverts=function(){return this.data[1].slice(1,this.data[0]+1)},this.applies=function(){return this.data[1].slice(this.data[0]+1)},this.hasReverts=function(){return this.data[0]>0},this.hasApplies=function(){return this.data[1].length-1-this.data[0]>0},this.start=function(){return this.data[1][0]},this.end=function(){return n.last(this.data[1])},this.root=function(){return this.data[1][this.data[0]]},this.sequence=function(){return this.data[1].slice(0)},this.mine=function(){return this.data[1].slice(0,this.data[0]).reverse()},this.theirs=function(){return this.applies()},this.inverted=function(){return new r([this.data[1].length-1-this.data[0],this.data[1].slice(0).reverse()])},this.toJSON=function(){return{data:this.data}}},r.Prototype.prototype=i.Diff.prototype,r.prototype=new r.Prototype,r.create=function(t,e,n){return new r([e.length,[t].concat(e).concat(n)])},e.exports=r},{"./chronicle":18,underscore:151}],21:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=i.errors,o=t("./chronicle"),s=function(){o.Index.call(this)};s.Prototype=function(){var t=new s.__private__,e=o.ROOT;this.add=function(t){t.data=i.freeze(t.data);var e=t.id;if(!t.parent)throw new r.ChronicleError("Change does not have a parent.");if(!this.contains(t.parent))throw new r.ChronicleError("Illegal change: parent is unknown - change="+e+", parent="+t.parent);this.changes[e]=t,this.children[e]=[],this.children[t.parent]||(this.children[t.parent]=[]),this.children[t.parent].push(e)},this.remove=function(t){if(this.children[t].length>0)throw new r.ChronicleError("Can not remove: other changes depend on it.");var e=this.changes[t];delete this.changes[t],delete this.children[t],this.children[e.parent]=n.without(this.children[e.parent],t)},this.contains=function(t){return!!this.changes[t]},this.get=function(t){return this.changes[t]},this.list=function(){return n.keys(this.changes)},this.getChildren=function(t){return this.children[t]},this.diff=function(n,i){var r,s,a=t.getPathToRoot.call(this,n),c=t.getPathToRoot.call(this,i),h=[],u=[],l={};for(s=0;s<c.length;s++)l[c[s]]=!0;for(s=0;s<a.length&&(r=a[s],s>0&&h.push(r),!l[r]);s++);var p=r;for(s=0;s<c.length&&(r=c[s],r!==p&&r!==e);s++)u.unshift(r);return o.Diff.create(n,h,u)},this.shortestPath=function(n,i){if(n===i)return[];if(i===e)return t.getPathToRoot.call(this,n).slice(1);if(n===e)return t.getPathToRoot.call(this,i).reverse().slice(1);for(var o,s,a,c,h,u,l,p={},d=[[n,n]];d.length>0;)if(o=d.shift(),s=o[0],a=o[1],c=this.get(a),!p[a]){if(p[a]=s,a===i){for(var f,g=[];a!==n;)if(g.unshift(a),f=p[a],p[a]=null,a=f,!a)throw new r.SubstanceError("Illegal state: bug in implementation of Index.shortestPath.");return g}for(p[c.parent]||d.push([a,c.parent]),l=this.getChildren(a),h=0;h<l.length;h++)u=l[h],p[u]||d.push([a,u])}throw new r.SubstanceError("Illegal state: no path found.")},this.import=function(e){var i=n.difference(e.list(),this.list());if(0!==i.length){var r=t.computeDependencyOrder.call(this,e,i);i.sort(function(t,e){return r[t]-r[e]});for(var o=0;o<i.length;o++)this.add(e.get(i[o]));return i}},this.foreach=function(t,e){e=e||"ROOT";for(var n,i,r=[e];r.length>0;){n=r.shift(),i=this.get(n),t(i);for(var o=this.children[n],s=0;s<o.length;s++)r.push(o[s])}}},s.__private__=function(){var t=o.ROOT;this.getPathToRoot=function(e){var n=[];if(e===t)return n;var i=this.get(e);if(!i)throw new r.ChronicleError("Unknown change: "+e);for(var o;;){if(n.push(i.id),i.id===t)break;o=i.parent,i=this.get(o)}return n},this.computeDependencyOrder=function(e,n){function i(n){if(r[n])return r[n];if(n===t)return 0;var o=e.get(n),s=i(o.parent)+1;return r[n]=s,s}for(var r={},o=0;o<n.length;o++)i(n[o]);return r}},s.Prototype.prototype=o.Index.prototype,s.prototype=new s.Prototype;var a=function(t,e){t.store=e,t.__changes__=e.hash("changes"),t.__refs__=e.hash("refs"),t.__changes__.list=t.__changes__.keys;var i=t.add;t.add=function(t){i.call(this,t),this.__changes__.set(t.id,t)};var r=t.remove;t.remove=function(t){r.call(this,t),this.__changes__.delete(t)};var o=t.setRef;t.setRef=function(t,e){o.call(this,t,e),this.__refs__.set(t,e)},t.load=function(){this.import(this.__changes__),n.each(this.__refs__.keys(),function(t){this.setRef(t,this.__refs__.get(t))},this)},t.load()};s.create=function(t){t=t||{};var e=new s;return t.store&&a(e,t.store),e},e.exports=s},{"./chronicle":18,"substance-util":144,underscore:151}],22:[function(t,e){"use strict";var n=t("substance-util"),i=t("./chronicle"),r=t("substance-operator").TextOperation,o=function(t,e){i.Versioned.call(this,t),this.doc=e};o.Prototype=function(){var t=n.prototype(this);this.apply=function(t){this.doc.setText(t.apply(this.doc.getText()))},this.invert=function(t){return t.invert()},this.transform=function(t,e,n){return r.transform(t,e,n)},this.reset=function(){t.reset.call(this),this.doc.setText("")}},o.Prototype.prototype=i.Versioned.prototype,o.prototype=new o.Prototype,e.exports=o},{"./chronicle":18,"substance-operator":130,"substance-util":144}],23:[function(t,e){var n=t("underscore"),i=t("substance-util"),r=i.errors,o=t("./index_impl"),s=function(t){o.call(this),this.index=t};s.Prototype=function(){var t=i.prototype(this);this.get=function(e){return t.contains.call(this,e)?t.get.call(this,e):this.index.get(e)},this.contains=function(e){return t.contains.call(this,e)||this.index.contains(e)},this.getChildren=function(e){var n=t.getChildren.call(this,e)||[];return this.index.contains(e)&&(n=n.concat(this.index.getChildren(e))),n},this.list=function(){return t.list.call(this).concat(this.index.list())},this.save=function(t,e){if(e)for(var n,i,r=[t];r.length>0;){n=r.pop(),i=this.changes[n],this.changes[n]&&this.index.add(i);for(var o=0;o<i.children;o++)r.unshift(i.children[o])}else this.changes[t]&&this.index.add(this.changes[t])},this.reconnect=function(t,e){if(!this.changes[t])throw new r.ChronicleError("Change does not exist to this index.");var i=this.get(t);if(!this.contains(e))throw new r.ChronicleError("Illegal change: parent is unknown parent="+e);this.children[i.parent]||(this.children[i.parent]=[]),this.children[i.parent]=n.without(this.children[i.parent],i.id),i.parent=e,this.children[i.parent]||(this.children[i.parent]=[]),this.children[i.parent].push(t)}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,e.exports=s},{"./index_impl":21,"substance-util":144,underscore:151}],24:[function(t,e){"use strict";e.exports={Keyboard:t("./src/keyboard"),ChromeKeyboard:t("./src/chrome_keyboard")}},{"./src/chrome_keyboard":25,"./src/keyboard":27}],25:[function(t,e){"use strict";function n(t,e,n){t.addEventListener?t.addEventListener(e,n,!0):t.attachEvent("on"+e,n)}function i(t,e,n){t.removeEventListener?t.removeEventListener(e,n,!0):t.detachEvent("on"+e,n)}var r=t("underscore"),o=t("substance-util"),s=function(e,n){if(this.keytable=n,this.map=e,this.registry={},!n){var i=t("./default_keytable.js");this.keytable=new i}this.__registeredKeyCodes={keypress:{},keyup:{},keydown:{}},this.defaultHandlers={keypress:this.PASS,keyup:this.BLOCK,keydown:this.PASS}};s.Prototype=function(){this.PASS=function(){},this.BLOCK=function(t){t.preventDefault(),t.stopPropagation()};for(var t=["ctrlKey","metaKey","shiftKey","altKey","altGraphKey"],e={},s=0;s<t.length;s++)e[t[s]]=s;var a={ctrl:"ctrlKey",command:"metaKey",shift:"shiftKey",alt:"altKey","alt-gr":"altGraphKey"},c={};r.each(a,function(t,e){c[t]=e}),this.defaultHandler=function(t){t.preventDefault()};var h=function(e,n,i){if(!i)return null;for(var r=i,o=0;o<t.length;o++){var s=t[o];if(n[s]&&(r=r[s]),!r)return null}if(r){var a=n.keyCode;return"keypress"===n.type&&(a=n.keyCode||e.keytable.table[String.fromCharCode(n.which)]),r[a]}return null};this.handleKeyPress=function(t){var e="keypress";if(String.fromCharCode(t.which)){var n=h(this,t,this.registry[e]);if(n)try{n(t)}catch(i){throw this.BLOCK(t),console.error(i.message),o.printStackTrace(i),i}else this.defaultHandlers[e]&&this.defaultHandlers[e](t)}else{if(!this.defaultHandlers[e])throw new Error("No default handler for: "+e);this.defaultHandlers[e](t)}},this.handleKey=function(t,e){if(this.__registeredKeyCodes[t][e.keyCode]){var n=h(this,e,this.registry[t]);if(n)try{n(e)}catch(i){throw this.BLOCK(e),console.error(i.message),o.printStackTrace(i),i}}else{if(!this.defaultHandlers[t])throw new Error("No default handler for: "+t);this.defaultHandlers[t](e)}},this.connect=function(t){this.el=t,this.__onKeyPress=this.handleKeyPress.bind(this),this.__onKeyUp=this.handleKey.bind(this,"keyup"),this.__onKeyDown=this.handleKey.bind(this,"keydown"),n(t,"keypress",this.__onKeyPress),n(t,"keydown",this.__onKeyDown),n(t,"keyup",this.__onKeyUp)},this.disconnect=function(){i(this.el,"keypress",this.__onKeyPress),i(this.el,"keydown",this.__onKeyDown),i(this.el,"keyup",this.__onKeyUp)},this.setDefaultHandler=function(t,e){1===arguments.length?r.each(this.defaultHandlers,function(t,e){this.defaultHandlers[e]=arguments[0]},this):this.defaultHandlers[t]=e},this.bindSingle=function(t,n,i){if(["keypress","keydown","keyup"].indexOf(n)<0)throw new Error("Expecting keyboard event type as second argument.");if(!r.isFunction(i))throw new Error("Expecting function handler as third argument.");var o,s,c,h=[];for(o=0;o<t.length-1;o++){if(c=t[o],s=a[c],!s)throw new Error("Unknown modifier: "+c);h.push(s)}var u=r.last(t),l=this.keytable.getKeyCode(u);if(r.isArray(l)){for(o=0;o<l.length-1;o++){if(c=l[o],s=a[c],!s)throw new Error("Unknown modifier: "+c);h.push(s)}l=r.last(l)}h.sort(function(t,n){return e[t]-e[n]}),this.registry[n]=this.registry[n]||{};var p=this.registry[n];for(o=0;o<h.length;o++)s=h[o],p[s]=p[s]||{},p=p[s];p[l]=i,this.__registeredKeyCodes[n][l]=!0},this.bindAll=function(t,e,n){for(var i=0;i<t.length;i++)this.bindSingle(t[i],e,n)},this.bind=function(t,e,n){var i;r.isString(t)?(i=this.compileMapping(t),this.bindAll(i,e,n)):this.bindSingle(t,e,n)},this.pass=function(t){var e;e=r.isString(t)?this.compileMapping(t):[t],this.bindAll(e,"keyup",this.PASS),this.bindAll(e,"keydown",this.PASS),this.bindAll(e,"keypress",this.PASS)},this.compileMapping=function(t){for(var e=[],n=this.map[t],i=0;i<n.length;i++){var r=n[i],o=r.split("+");e.push(o)}return e},this.describeEvent=function(e){for(var n=[],i=0;i<t.length;i++){var r=t[i];e[r]===!0&&n.push(c[r])}return n.push(this.keytable.getKeyName(e.keyCode)),n.join("+")}},s.prototype=new s.Prototype,e.exports=s},{"./default_keytable.js":26,"substance-util":144,underscore:151}],26:[function(t,e){"use strict";var n=t("underscore"),i=function(){};i.Prototype=function(){(function(){var t;for(this.table={},t=0;26>t;t++){var e=t+65,i=String.fromCharCode(e).toUpperCase(),r=String.fromCharCode(e).toLowerCase();this.table[i]=e,this.table[r]=e}for(t=0;10>t;t++)this.table[""+t]=48+t;for(t=1;13>t;t++)this.table["f"+t]=111+t;n.extend(this.table,{"*":106,"+":107,"-":109,".":110,"/":111,";":186,"=":187,",":188,"`":192,"[":219,"\\":220,"]":221,'"':222}),n.extend(this.table,{backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,capslock:20,esc:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,ins:45,del:46}),this.inverseTable={},n.each(this.table,function(t,e){this.inverseTable[t]=e},this)}).call(this),this.getKeyCode=function(t){if(void 0!==this.table[t])return this.table[t];throw new Error("Unknown key: "+t)},this.getKeyName=function(t){return void 0!==this.inverseTable[t]?this.inverseTable[t]:"native("+t+")"}},i.prototype=new i.Prototype,e.exports=i},{underscore:151}],27:[function(t,e){"use strict";function n(t,e,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent("on"+e,n)}function i(t,e,n){t.removeEventListener?t.removeEventListener(e,n,!1):t.detachEvent("on"+e,n)}function r(t){if("keypress"==t.type){var e=String.fromCharCode(t.which);return t.shiftKey||(e=e.toLowerCase()),e}return h[t.which]?h[t.which]:u[t.which]?u[t.which]:String.fromCharCode(t.which).toLowerCase()}function o(t,e){return t.sort().join(",")===e.sort().join(",")}function s(t){var e=[];return t.shiftKey&&e.push("shift"),t.altKey&&e.push("alt"),t.ctrlKey&&e.push("ctrl"),t.metaKey&&e.push("meta"),e}function a(t){return"shift"==t||"ctrl"==t||"alt"==t||"meta"==t}function c(t){return"+"===t?["+"]:t.split("+")}for(var h={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},u={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},l={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},p={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},d=1;20>d;++d)h[111+d]="f"+d;for(d=0;9>=d;++d)h[d+96]=d;var f=function(t){this._REVERSE_MAP={},this._callbacks={},this._directMap={},this._sequenceLevels={},this._resetTimer=null,this._ignoreNextKeyup=!1,this._ignoreNextKeypress=!1,this._nextExpectedAction=!1,this._handler=this._handleKeyEvent.bind(this),this.keymap=t};f.Prototype=function(){function t(t){t=t||{};var e,n=!1;for(e in this._sequenceLevels)t[e]?n=!0:this._sequenceLevels[e]=0;n||(this._nextExpectedAction=!1)}function e(t,e,n,i,r,s){var c,h,u=[],l=n.type;if(!this._callbacks[t])return[];for("keyup"==l&&a(t)&&(e=[t]),c=0;c<this._callbacks[t].length;++c)if(h=this._callbacks[t][c],(i||!h.seq||this._sequenceLevels[h.seq]==h.level)&&l==h.action&&("keypress"==l&&!n.metaKey&&!n.ctrlKey||o(e,h.modifiers))){var p=!i&&h.combo==r,d=i&&h.seq==i&&h.level==s;(p||d)&&this._callbacks[t].splice(c,1),u.push(h)}return u}function u(t,e,n){this.NOT_IN_EDITABLES&&this.stopCallback(e,e.target||e.srcElement,n)||t.call(t.self,e,n)===!1&&(e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,e.cancelBubble=!0)}function d(t,e){var n,i,r,o=[];for(n=c(t),r=0;r<n.length;++r)i=n[r],p[i]&&(i=p[i]),e&&"keypress"!=e&&l[i]&&(i=l[i],o.push("shift")),a(i)&&o.push(i);return e=w.call(this,i,o,e),{key:i,modifiers:o,action:e}}function g(t,n,i,r,o){this._directMap[t+":"+i]=n,t=t.replace(/\s+/g," ");var s,a=t.split(" ");return a.length>1?(b.call(this,t,a,n,i),void 0):(s=d.call(this,t,i),this._callbacks[s.key]=this._callbacks[s.key]||[],e.call(this,s.key,s.modifiers,{type:s.action},r,t,o),this._callbacks[s.key][r?"unshift":"push"]({callback:n,modifiers:s.modifiers,action:s.action,seq:r,level:o,combo:t}),void 0)}function v(t,e,n){for(var i=0;i<t.length;++i)g.call(this,t[i],e,n)}function y(){clearTimeout(this._resetTimer),this._resetTimer=setTimeout(t.bind(this),1e3)}function m(){if(!this._REVERSE_MAP){this._REVERSE_MAP={};for(var t in h)t>95&&112>t||h.hasOwnProperty(t)&&(this._REVERSE_MAP[h[t]]=t)}return this._REVERSE_MAP}function w(t,e,n){return n||(n=m.call(this)[t]?"keydown":"keypress"),"keypress"==n&&e.length&&(n="keydown"),n}function b(e,n,i,o){function s(t){return function(){c._nextExpectedAction=t,++c._sequenceLevels[e],y.call(c)}}function a(n){u.call(this,i,n,e),"keyup"!==o&&(this._ignoreNextKeyup=r(n)),setTimeout(t.bind(this),10)}var c=this;this._sequenceLevels[e]=0;for(var h=0;h<n.length;++h){var l=h+1===n.length,p=l?a:s.call(this,o||d(n[h+1]).action);g.call(this,n[h],p,o,e,h)}}this.handleKey=function(n,i,r){var o,s=e.call(this,n,i,r),c={},h=0,l=!1;for(o=0;o<s.length;++o)s[o].seq&&(h=Math.max(h,s[o].level));for(o=0;o<s.length;++o)if(s[o].seq){if(s[o].level!=h)continue;l=!0,c[s[o].seq]=1,u.call(this,s[o].callback,r,s[o].combo)}else f.TRIGGER_PREFIX_COMBOS?u.call(this,s[o].callback,r,s[o].combo):l||u.call(this,s[o].callback,r,s[o].combo);var p="keypress"==r.type&&this._ignoreNextKeypress;return r.type!=this._nextExpectedAction||a(n)||p||t.call(this,c),this._ignoreNextKeypress=l&&"keydown"==r.type,s.length>0},this._handleKeyEvent=function(t){"number"!=typeof t.which&&(t.which=t.keyCode);var e=r(t);if(e)return"keyup"==t.type&&this._ignoreNextKeyup===e?(this._ignoreNextKeyup=!1,void 0):(this.handleKey(e,s(t),t),void 0)},this.bind=function(t,e,n,i){return e.self=i,t=t instanceof Array?t:[t],v.call(this,t,e,n),this},this.bindMapped=function(t,e,n,i){return this.bind(this.keymap[t],e,n,i)},this.trigger=function(t,e){return this._directMap[t+":"+e]&&this._directMap[t+":"+e].call(this,{},t),this},this.reset=function(){return this._callbacks={},this._directMap={},this},this.stopCallback=function(t,e){return(" "+e.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==e.tagName||"SELECT"==e.tagName||"TEXTAREA"==e.tagName||e.contentEditable&&"true"==e.contentEditable},this.connect=function(t){n(t,"keypress",this._handler),n(t,"keydown",this._handler),n(t,"keyup",this._handler)},this.disconnect=function(t){i(t,"keypress",this._handler),i(t,"keydown",this._handler),i(t,"keyup",this._handler)},this.TRIGGER_PREFIX_COMBOS=!1,this.NOT_IN_EDITABLES=!1},f.prototype=new f.Prototype,e.exports=f},{}],28:[function(t,e){"use strict";var n={};n.VERSION="0.8.0",n.Graph=t("./src/graph");var i=t("underscore");n.defineNodeProperties=function(t,e,n){i.each(e,function(e){var i={get:function(){return this.properties[e]}};n||(i.set=function(t){return this.properties[e]=t,this}),Object.defineProperty(t,e,i)})},e.exports=n},{"./src/graph":30,underscore:151}],29:[function(t,e){"use strict";var n=t("substance-chronicle"),i=t("substance-operator"),r=function(t){this.graph=t,this.graph.state="ROOT"};r.Prototype=function(){this.apply=function(t){this.graph.__apply__(t),this.graph.updated_at=new Date(t.timestamp)},this.invert=function(t){return i.ObjectOperation.fromJSON(t).invert()},this.transform=function(t,e,n){return i.ObjectOperation.transform(t,e,n)},this.reset=function(){this.graph.reset()},this.getState=function(){return this.graph.state},this.setState=function(t){this.graph.state=t}},r.Prototype.prototype=n.Versioned.prototype,r.prototype=new r.Prototype,e.exports=r},{"substance-chronicle":15,"substance-operator":130}],30:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=i.errors,o=t("./schema"),s=t("./property"),a=t("substance-chronicle"),c=t("substance-operator"),h=t("./persistence_adapter"),u=t("./chronicle_adapter"),l=t("./graph_index"),p=r.define("GraphError"),d=["object","array","string","number","boolean","date"],f=function(t){return n.isArray(t)&&(t=t[0]),d.indexOf(t)>=0},g=function(t,e){if(e=e||{},this.schema=new o(t),this.schema.id&&e.seed&&e.seed.schema&&!n.isEqual(e.seed.schema,[this.schema.id,this.schema.version]))throw new p(["Graph does not conform to schema. Expected: ",this.schema.id+"@"+this.schema.version," Actual: ",e.seed.schema[0]+"@"+e.seed.schema[1]].join(""));if(this.objectAdapter=new g.ObjectAdapter(this),this.nodes={},this.indexes={},this.__mode__=e.mode||g.DEFAULT_MODE,this.__seed__=e.seed,this.isVersioned=!!e.chronicle,this.isPersistent=!!e.store,this.isVersioned&&(this.chronicle=e.chronicle,this.chronicle.manage(new g.ChronicleAdapter(this))),this.isPersistent){var i=e.store.hash("nodes");this.__store__=e.store,this.__nodes__=i,this.isVersioned&&(this.__version__=e.store.hash("__version__")),this.objectAdapter=new h(this.objectAdapter,i)}e.load?this.load():this.init(),e.graph&&this.merge(e.graph)};g.Prototype=function(){n.extend(this,i.Events);var t=new g.Private;this.create=function(t){var e=c.ObjectOperation.Create([t.id],t);return this.apply(e)},this.delete=function(t){var e=this.get(t);if(void 0===e)throw new p("Could not resolve a node with id "+t);e.toJSON&&(e=e.toJSON());var n=c.ObjectOperation.Delete([t],e);return this.apply(n)},this.update=function(t,e){var i=this.resolve(t);if(!i)throw new p("Could not resolve property with path "+JSON.stringify(t));if(n.isArray(e))if("string"===i.baseType)e=c.TextOperation.fromSequence(i.get(),e);else{if("array"!==i.baseType)throw new p("There is no convenient notation supported for this type: "+i.baseType);e=c.ArrayOperation.create(i.get(),e)}if(e){var r=c.ObjectOperation.Update(t,e,i.baseType);return this.apply(r)}},this.set=function(t,e){var n=this.resolve(t);if(!n)throw new p("Could not resolve property with path "+JSON.stringify(t));var i=n.get(),r=c.ObjectOperation.Set(t,i,e);return this.apply(r)},this.__apply__=function(t){c.Helpers.each(t,function(t){t instanceof c.ObjectOperation||(t=c.ObjectOperation.fromJSON(t)),t.apply(this.objectAdapter),this.updated_at=new Date,this._internalUpdates(t),n.each(this.indexes,function(e){e.onGraphChange(t)},this),this.trigger("operation:applied",t,this)},this)},this._internalUpdates=function(t){c.Helpers.each(t,function(t){n.each(this.indexes,function(e){e.onGraphChange(t)},this)},this)},this.apply=function(t){return this.__apply__(t),!this.__is_initializing__&&this.isVersioned&&(t.timestamp=new Date,this.chronicle.record(i.clone(t))),t},this.get=function(t){if(void 0===t||null===t)throw new p("Invalid argument: provided undefined or null.");if(!n.isArray(t)&&!n.isString(t))throw new p("Invalid argument path. Must be String or Array");if(n.isString(t))return this.nodes[t];var e=this.resolve(t);return e.get()},this.query=function(e){var n=this.resolve(e),i=n.type,r=n.baseType,o=n.get();return"array"===r?t.queryArray.call(this,o,i):f(r)?o:this.get(o)},this.toJSON=function(){return{id:this.id,schema:[this.schema.id,this.schema.version],nodes:i.deepclone(this.nodes)}},this.contains=function(t){return!!this.nodes[t]},this.resolve=function(t){return new s(this,t)},this.reset=function(){this.isPersistent&&this.__nodes__&&this.__nodes__.clear(),this.init(),this.isVersioned&&(this.state=a.ROOT),this.trigger("graph:reset")},this.init=function(){this.__is_initializing__=!0,this.nodes=this.__seed__?i.clone(this.__seed__.nodes):{},n.each(this.indexes,function(t){t.reset()}),this.isPersistent&&n.each(this.nodes,function(t,e){this.__nodes__.set(e,t)},this),delete this.__is_initializing__},this.merge=function(t){return n.each(t.nodes,function(t){this.create(t)},this),this},this.traverse=function(t){return n.map(this.getView(t),function(t){return this.get(t)},this)},this.load=function(){if(!this.isPersistent)return console.log("Graph is not persistent."),void 0;this.__is_initializing__=!0,this.nodes={},this.indexes={};for(var e=this.__nodes__.keys(),n=0;n<e.length;n++)t.create.call(this,this.__nodes__.get(e[n]));return this.isVersioned&&(this.state=this.__version__.get("state")||"ROOT"),delete this.__is_initializing__,this},this.cotransform=function(t,e){if("create"===e.type)t.create(e.val);else if("delete"===e.type)t.delete(e.val);else{var i=this.resolve(e.path);if(void 0===i)throw new Error("Key error: could not find element for path "+JSON.stringify(e.path));var r,o=i.get();if(void 0===o)return;if("set"===e.type)r=e.original;else{var s=c.Helpers.invert(e.diff,i.baseType);r=s.apply(n.clone(o))}t.update(i.node,i.key,o,r)}},this.addIndex=function(t,e){if(this.indexes[t])return this.indexes[t];var n=new l(this,e);return this.indexes[t]=n,n},this.getIndex=function(t){if(!this.indexes[t])throw new p("No index available with name:"+t);return this.indexes[t]},this.removeIndex=function(t){delete this.indexes[t]},this.enableVersioning=function(t){this.isVersioned||(t||(t=a.create()),this.chronicle=t,this.chronicle.manage(new g.ChronicleAdapter(this)),this.isVersioned=!0)}},g.STRICT_INDEXING=2,g.DEFAULT_MODE=g.STRICT_INDEXING,g.Private=function(){var t=this;this.createNode=function(t,e){if(!e.id||!e.type)throw new p("Can not create Node: 'id' and 'type' are mandatory.");var r=t.type(e.type);if(!r)throw new p("Type '"+e.type+"' not found in the schema");var o=t.properties(e.type),s={type:e.type,id:e.id};return n.each(o,function(n,r){var o=t.propertyBaseType(e.type,r),a=void 0!==e[r]?e[r]:t.defaultValue(o);s[r]=i.deepclone(a)}),s},this.create=function(e){var n=t.createNode(this.schema,e);if(this.contains(n.id))throw new p("Node already exists: "+n.id);return this.nodes[n.id]=n,this.trigger("node:created",n),this},this.delete=function(t){delete this.nodes[t.id],this.trigger("node:deleted",t.id)},this.set=function(t,e){var n=this.resolve(t);if(void 0===n)throw new Error("Key error: could not find element for path "+JSON.stringify(t));var r=i.deepclone(n.get());n.set(e),this.trigger("property:updated",t,null,r,e)};var e=function(t,e){c.Helpers.each(e,function(e){this.trigger("property:updated",t,e,this)},this)};this.update=function(t,n,i){var r=this.resolve(t);if(void 0===r)throw new Error("Key error: could not find element for path "+JSON.stringify(t));r.set(n),e.call(this,t,i)},this.queryArray=function(e,i){if(!n.isArray(i))throw new p("Illegal argument: array types must be specified as ['array'(, 'array')*, <type>]");var r,o;if("array"===i[1])for(r=[],o=0;o<e.length;o++)r.push(t.queryArray.call(this,e[o],i.slice(1)));else if(f(i[1]))r=e;else for(r=[],o=0;o<e.length;o++)r.push(this.get(e[o]));return r}},g.prototype=new g.Prototype,g.ObjectAdapter=function(t){this.graph=t},g.ObjectAdapter.Prototype=function(){var t=new g.Private;this.get=function(t){var e=this.graph.resolve(t);if(void 0===e)throw new Error("Key error: could not find element for path "+JSON.stringify(t));return e.get()},this.create=function(e,n){t.create.call(this.graph,n)},this.set=function(e,n){t.set.call(this.graph,e,n)},this.update=function(e,n,i){t.update.call(this.graph,e,n,i)},this.delete=function(e,n){t.delete.call(this.graph,n)
},this.inplace=function(){return!1}},g.ObjectAdapter.Prototype.prototype=c.ObjectOperation.Object.prototype,g.ObjectAdapter.prototype=new g.ObjectAdapter.Prototype,g.Schema=o,g.Property=s,g.PersistenceAdapter=h,g.ChronicleAdapter=u,g.Index=l,e.exports=g},{"./chronicle_adapter":29,"./graph_index":31,"./persistence_adapter":32,"./property":33,"./schema":34,"substance-chronicle":15,"substance-operator":130,"substance-util":144,underscore:151}],31:[function(t,e){var n=t("underscore"),i=t("substance-util"),r=function(t,e){e=e||{},this.graph=t,this.nodes={},this.scopes={},e.filter?this.filter=e.filter:e.types&&(this.filter=r.typeFilter(t.schema,e.types)),e.property&&(this.property=e.property),this.createIndex()};r.Prototype=function(){var t=function(t){var e=this;if(null!==t)for(var n=0;n<t.length;n++){var i=t[n];e.scopes[i]=e.scopes[i]||{nodes:{},scopes:{}},e=e.scopes[i]}return e},e=function(t){if(!this.property)return null;var e=t[this.property]?t[this.property]:null;return n.isString(e)&&(e=[e]),e},i=function(t){var e=n.extend({},t.nodes);return n.each(t.scopes,function(t,r){"nodes"!==r&&n.extend(e,i(t))}),e},r=function(e,n){var i=t.call(this,e);i.nodes[n.id]=n.id},o=function(e,n){var i=t.call(this,e);delete i.nodes[n.id]};this.onGraphChange=function(t){var i=this,s={create:function(t){if(!i.filter||i.filter(t)){var n=e.call(i,t);r.call(i,n,t)}},"delete":function(t){if(!i.filter||i.filter(t)){var n=e.call(i,t);o.call(i,n,t)}},update:function(t,e,s,a){if(i.property===e&&(!i.filter||i.filter(t))){var c=a;n.isString(c)&&(c=[c]),o.call(i,c,t),c=s,n.isString(c)&&(c=[c]),r.call(i,c,t)}}};this.graph.cotransform(s,t)},this.createIndex=function(){this.reset();var t=this.graph.nodes;n.each(t,function(t){if(!this.filter||this.filter(t)){var n=e.call(this,t);r.call(this,n,t)}},this)},this.get=function(e){0===arguments.length?e=null:n.isString(e)&&(e=[e]);var r,o=t.call(this,e);return r=i(o),n.each(r,function(t){r[t]=this.graph.get(t)},this),r},this.reset=function(){this.nodes={},this.scopes={}},this.dispose=function(){this.stopListening()}},r.prototype=n.extend(new r.Prototype,i.Events.Listener),r.typeFilter=function(t,e){return function(n){for(var i=t.typeChain(n.type),r=0;r<e.length;r++)if(i.indexOf(e[r])>=0)return!0;return!1}},e.exports=r},{"substance-util":144,underscore:151}],32:[function(t,e){"use strict";var n=t("substance-operator"),i=function(t,e){this.delegate=t,this.nodes=e};i.Prototype=function(){this.get=function(t){return this.delegate.get(t)},this.create=function(t,e){this.delegate.create(t,e),this.nodes.set(e.id,e)},this.set=function(t,e){this.delegate.set(t,e);var n=t[0],i=this.delegate.get([n]);this.nodes.set(n,i)},this.delete=function(t,e){this.delegate.delete(t,e),this.nodes.delete(e.id)},this.inplace=function(){return!1}},i.Prototype.prototype=n.ObjectOperation.Object.prototype,i.prototype=new i.Prototype,e.exports=i},{"substance-operator":130}],33:[function(t,e){"use strict";var n=t("underscore"),i=function(t,e){if(!e)throw new Error("Illegal argument: path is null/undefined.");this.graph=t,this.schema=t.schema;var i=this.resolve(e);return void 0===i?void 0:(n.extend(this,i),void 0)};i.Prototype=function(){this.resolve=function(t){for(var e,n,i=this.graph,r=i,o="graph",s=0;s<t.length;s++)if("graph"===o||void 0!==this.schema.types[o]){if(r=this.graph.get(t[s]),void 0===r)return void 0;i=r,o=this.schema.properties(r.type),n=i,e=void 0}else{if(void 0===r)return void 0;e=t[s];var a=t[s];o=o[a],n=r[e],s<t.length-1&&(r=r[a])}return{node:i,parent:r,type:o,key:e,value:n}},this.get=function(){return void 0!==this.key?this.parent[this.key]:this.node},this.set=function(t){if(void 0===this.key)throw new Error("'set' is only supported for node properties.");this.parent[this.key]=this.schema.parseValue(this.baseType,t)}},i.prototype=new i.Prototype,Object.defineProperties(i.prototype,{baseType:{get:function(){return n.isArray(this.type)?this.type[0]:this.type}},path:{get:function(){return[this.node.id,this.key]}}}),e.exports=i},{underscore:151}],34:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=function(t){n.extend(this,t)};r.Prototype=function(){this.defaultValue=function(t){return"object"===t?{}:"array"===t?[]:"string"===t?"":"number"===t?0:"boolean"===t?!1:"date"===t?new Date:null},this.parseValue=function(t,e){if(null===e)return e;if(n.isString(e)){if("object"===t)return JSON.parse(e);if("array"===t)return JSON.parse(e);if("string"===t)return e;if("number"===t)return parseInt(e,10);if("boolean"===t){if("true"===e)return!0;if("false"===e)return!1;throw new Error("Can not parse boolean value from: "+e)}return"date"===t?new Date(e):e}if("array"===t){if(!n.isArray(e))throw new Error("Illegal value type: expected array.");e=i.deepclone(e)}else if("string"===t){if(!n.isString(e))throw new Error("Illegal value type: expected string.")}else if("object"===t){if(!n.isObject(e))throw new Error("Illegal value type: expected object.");e=i.deepclone(e)}else if("number"===t){if(!n.isNumber(e))throw new Error("Illegal value type: expected number.")}else if("boolean"===t){if(!n.isBoolean(e))throw new Error("Illegal value type: expected boolean.")}else{if("date"!==t)throw new Error("Unsupported value type: "+t);e=new Date(e)}return e},this.type=function(t){return this.types[t]},this.typeChain=function(t){var e=this.types[t];if(!e)throw new Error("Type "+t+" not found in schema");var n=e.parent?this.typeChain(e.parent):[];return n.push(t),n},this.isInstanceOf=function(t,e){var n=this.typeChain(t);return n&&n.indexOf(e)>=0?!0:!1},this.baseType=function(t){return this.typeChain(t)[0]},this.properties=function(t){t=n.isObject(t)?t:this.type(t);var e=t.parent?this.properties(t.parent):{};return n.extend(e,t.properties),e},this.propertyType=function(t,e){var i=this.properties(t),r=i[e];if(!r)throw new Error("Property not found for"+t+"."+e);return n.isArray(r)?r:[r]},this.propertyBaseType=function(t,e){return this.propertyType(t,e)[0]}},r.prototype=new r.Prototype,e.exports=r},{"substance-util":144,underscore:151}],35:[function(t,e){"use strict";t("underscore");var n=t("./src/document");n.Annotator=t("./src/annotator"),n.Cursor=t("./src/cursor"),n.Selection=t("./src/selection"),n.Container=t("./src/container"),n.Session=t("./src/document_session"),e.exports=n},{"./src/annotator":36,"./src/container":37,"./src/cursor":38,"./src/document":39,"./src/document_session":40,"./src/selection":42,underscore:151}],36:[function(t,e){"use strict";var n,i=t("underscore"),r=t("substance-util"),o=t("./document"),s=t("substance-operator"),a=function(t){this.config=n(t),t.addIndex("annotations",{types:["annotation"],property:"path"}),this.document=t};a.Prototype=function(){this.update=function(e,n){n=n||{};var r=n.path||e.path,o=this.document.getIndex("annotations"),s=o.get(r);i.each(s,function(i){t(this,i,e,n)},this)},this.copy=function(){throw new Error("FIXME: this must be updated considering the other API changes.")},this.paste=function(){throw new Error("FIXME: this must be updated considering the other API changes.")},this.transferAnnotations=function(t,e,n,o){o=o||0;var s=a(this,t,{start:e});i.each(s,function(t){var s,a=e>t.range[0]||e[1]<t.range[1];if(a){if(this.isSplittable(t.type)){var c=r.clone(t);c.range=[o,o+t.range[1]-e],c.id=r.uuid(),c.path[0]=n.id,this.document.create(c)}s=i.clone(t.range),s[1]=e,s[1]===s[0]?this.document.delete(t.id):this.document.set([t.id,"range"],s)}else{var h=i.clone(t.path);h[0]=n.id,this.document.set([t.id,"path"],h),s=[o+t.range[0]-e,o+t.range[1]-e],this.document.set([t.id,"range"],s)}},this)},this.getAnnotationsForNode=function(t){return this.index.get(t)},this.getAnnotations=function(t){if(!(t instanceof o.Selection))throw new Error("API has changed: now getAnnotations() takes only a selection.");for(var e=[],i=t.getRanges(),r=0;r<i.length;r++){var s=i[r],a=n(this,this.document,s);e=e.concat(a)}return e},this.isExclusive=function(t,e){return this.config.groups[t]===this.config.groups[e]},this.isSplittable=function(t){return this.config.split.indexOf(t)>=0};var t=function(t,e,n,o){var a=o.path||n.path;if(i.isEqual(e.path,a))if("update"===n.type){var c=!1,h=!1,u=t.config.expansion[e.type];u&&(u.left&&(c=u.left(e)),u.right&&(h=u.right(e)));var l=r.clone(e.range),p=s.TextOperation.Range.transform(l,n.diff,c,h);p&&(l[0]===l[1]?t.document.delete(e.id):t.document.set([e.id,"range"],l))}else("delete"===n.type||"set"===n.type)&&t.document.delete(e.id)},e=function(t,e,n){var r=n.start,o=n.end,s=e.range[0],a=e.range[1],c=!1,h=!1,u=t.config.expansion[e.type];u&&(u.left&&(c=u.left(e)),u.right&&(h=u.right(e)));var l;return l=h?a>=r:a>r,i.isNumber(o)&&(l&=c?o>=s:o>s),l},n=function(t,n,r){var o,s=[],a=r.component,c=n.getIndex("annotations");if("node"===a.type){var h=a.node;o=c.get(h.id)}else"property"===a.type?o=c.get(a.path):"custom"===a.type?o=c.get(a.path):console.error("FIXME");return i.each(o,function(n){e(t,n,r)&&s.push(n)}),s},a=function(t,n,r){var o=[],s=t.document.getIndex("annotations"),a=s.get(n.id);return i.each(a,function(n){e(t,n,r)&&o.push(n)}),o}},a.Prototype.prototype=r.Events,a.prototype=new a.Prototype,a.isOnNodeStart=function(t){return 0===t.range[0]},a.isTrue=function(){return!0};var c=function(t,e,n){var i=t.getSchema();return i.isInstanceOf(e.type,n)};a.changesAnnotations=function(t,e,n){var r;r="delete"===e.type?e.val:t.get(e.path[0]);var o=!1;return c(t,r,"annotation")&&(i.isEqual(n,r.path)?o=!0:"set"===e.type&&"path"===e.path[1]&&(i.isEqual(n,e.original)||i.isEqual(n,e.val))&&(o=!0)),o},a.createIndex=function(t){return t.addIndex("annotations",{types:["annotation"],property:"path"})},n=function(t){var e=t.getAnnotationBehavior();if(!e)throw new Error("No Annotation behavior specified.");return e},e.exports=a},{"./document":39,"substance-operator":130,"substance-util":144,underscore:151}],37:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),i=t("substance-util"),r=i.errors,o=r.define("ContainerError"),s=function(t,e,n){this.document=t,this.name=e;var i=this.document.get(e);if(!i||"view"!==i.type)throw new o("Illegal argument: no view with name "+e);this.view=i,this.__components=null,this.__roots=null,this.__children=null,this.__updater=null,this.surfaces=n||new s.DefaultNodeSurfaceProvider(t),this.rebuild(),this.listenTo(this.document,"operation:applied",this.update)};s.Prototype=function(){n.extend(this,i.Events),this.rebuild=function(){for(var t=[],e=[],i={},r=[],s=this.document.get(this.name),a=s.nodes,c=0;c<a.length;c++){var h=a[c],u=this.surfaces.getNodeSurface(h);if(!u)throw new o("Aaaaah! no surface available for node "+h);u.update&&r.push(u.update.bind(u));var l=u.components;if(!l)throw new o("Node Surface did not provide components: "+u.node.type);i[h]=[];for(var p=0;p<l.length;p++){var d=n.clone(l[p]);d.pos=t.length,d.nodePos=c,i[h].push(d),t.push(d),e.push(a[c])}}this.__components=t,this.__roots=e,this.__children=i,this.__updater=r,this.view=s},this.getComponents=function(){return this.__components||this.rebuild(),this.__components},this.lookup=function(t){for(var e=this.getComponents(),i=0;i<e.length;i++){var r=e[i];if(n.isEqual(r.path,t))return r}if(1===t.length)for(var o=t[0],s=this.__roots,a=0;a<s.length;a++)if(s[a]===o)return e[a];return console.error("Could not find a view component for path "+JSON.stringify(t)),null},this.getNodes=function(t){var e=this.view.nodes;if(t)return n.clone(e);for(var i=[],r=0;r<e.length;r++)i.push(this.document.get(e[r]));return i},this.update=function(t){var e=t.path,n=!this.__components||e[0]===this.view.id;if(!n)for(var i=0;i<this.__updater.length;i++)if(this.__updater[i](t)){n=!0;break}n&&this.rebuild()},this.getLength=function(t){var e=this.getComponents();return void 0===t?e.length:e[t].getLength()},this.getRootNodeFromPos=function(t){return this.__roots||this.rebuild(),this.document.get(this.__roots[t])},this.getNodePos=function(t){this.__roots||this.rebuild();var e=this.__roots[t];return this.view.nodes.indexOf(e)},this.lookupRootNode=function(t){for(var e=this.getComponents(),n=0;n<e.length;n++){var i=e[n];switch(i.type){case"node":if(i.node.id===t)return this.__roots[n];break;case"property":if(i.path[0]===t)return this.__roots[n]}}return console.error("Could not find a root node for the given id:"+t),null},this.getComponent=function(t){var e=this.getComponents();return e[t]},this.getNodeComponents=function(t){var e=this.__children[t];if(!e)throw new o("Node is not in this container:"+t);return e},this.dispose=function(){this.stopListening()},this.createContainer=function(t){return new s(t,this.name,this.surfaces.createCopy(t))}},s.prototype=n.extend(new s.Prototype,i.Events.Listener),Object.defineProperties(s.prototype,{id:{get:function(){return this.view.id}},type:{get:function(){return this.view.type}},nodes:{get:function(){return this.view.nodes},set:function(t){this.view.nodes=t}}}),s.DefaultNodeSurfaceProvider=t("./node_surface_provider"),s.ContainerError=o,e.exports=s},{"./node_surface_provider":41,"substance-util":144,underscore:151}],38:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=i.errors,o=r.define("CursorError"),s=function(t,e,i,r){if(this.container=t,this.view=r||"content",this.pos=e,this.charPos=i,null!==e&&!n.isNumber(e))throw new o("Illegal argument: expected pos as number");if(null!==i&&!n.isNumber(i))throw new o("Illegal argument: expected charPos as number")};s.Prototype=function(){this.toJSON=function(){return[this.pos,this.charPos]},this.copy=function(){return new s(this.container,this.pos,this.charPos,this.view)},this.isValid=function(){if(null===this.pos||null===this.charPos)return!1;if(this.pos<0||this.charPos<0)return!1;var t=this.container.getLength(this.pos);return this.charPos>=t?!1:!0},this.isRightBound=function(){return this.charPos===this.container.getLength(this.pos)},this.isLeftBound=function(){return 0===this.charPos},this.isEndOfDocument=function(){return this.isRightBound()&&this.pos===this.container.getLength()-1},this.isBeginOfDocument=function(){return this.isLeftBound()&&0===this.pos},this.prevNode=function(){this.isLeftBound()?this.pos>0&&(this.pos-=1,this.charPos=this.container.getLength(this.pos)):this.charPos=0},this.nextNode=function(){this.isRightBound()?this.pos<this.container.getLength()-1&&(this.pos+=1,this.charPos=0):this.charPos=this.container.getLength(this.pos)},this.prevWord=function(){throw new Error("Not implemented")},this.nextWord=function(){throw new Error("Not implemented")},this.nextChar=function(){this.isRightBound()?this.pos<this.container.getLength()-1&&(this.pos+=1,this.charPos=0):this.charPos+=1},this.prevChar=function(){if(this.charPos<0)throw new o("Invalid char position");this.isLeftBound()?this.pos>0&&(this.pos-=1,this.charPos=this.container.getLength(this.pos)):this.charPos-=1},this.move=function(t,e){"left"===t?"word"===e?this.prevWord():"char"===e?this.prevChar():"node"===e&&this.prevNode():"word"===e?this.nextWord():"char"===e?this.nextChar():"node"===e&&this.nextNode()},this.set=function(t,e){if(null!==t&&!n.isNumber(t))throw new o("Illegal argument: expected pos as number");if(null!==e&&!n.isNumber(e))throw new o("Illegal argument: expected charPos as number");if(null!==t){if(!n.isNumber(t))throw new o("Illegal argument: expected pos as number");var i=this.container.getLength();if(0>t||t>=i)throw new o("Invalid node position: "+t);var r=this.container.getLength(t);if(0>e||e>r)throw new o("Invalid char position: "+e)}this.pos=t,this.charPos=e},this.position=function(){return[this.pos,this.charPos]}},s.prototype=new s.Prototype,e.exports=s},{"substance-util":144,underscore:151}],39:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=i.errors,o=t("substance-data"),s=t("substance-operator"),a=r.define("DocumentError"),c=function(t){o.Graph.call(this,t.schema,t),this.fileData={},this.addIndex("files",{types:["file"]})};c.schema={indexes:{},types:{content:{properties:{}},view:{properties:{nodes:["array","content"]}}}},c.Prototype=function(){var t=i.prototype(this);this.getIndex=function(t){return this.indexes[t]},this.getSchema=function(){return this.schema},this.create=function(e){return t.create.call(this,e),this.get(e.id)},this.get=function(e){var n=t.get.call(this,e);if(!n)return n;var i=this.nodeTypes[n.type],r=void 0!==i?i.Model:null;return!r||n instanceof r||(n=new r(n,this),this.nodes[n.id]=n),n},this.toJSON=function(){var e=t.toJSON.call(this);return e.id=this.id,e},this.hide=function(t,e){var i=this.get(t);if(!i)throw new a("Invalid view id: "+t);n.isString(e)&&(e=[e]);var r=[];if(n.each(e,function(t){var e=i.nodes.indexOf(t);e>=0&&r.push(e)},this),0!==r.length){r=r.sort().reverse(),r=n.uniq(r);var o=n.map(r,function(t){return s.ArrayOperation.Delete(t,i.nodes[t])}),c=s.ObjectOperation.Update([t,"nodes"],s.ArrayOperation.Compound(o));return this.apply(c)}},this.comment=function(t){var e=i.uuid();t.id=e,t.type="comment";var n=s.ObjectOperation.Create([t.id],t);return this.__apply__(n)},this.annotate=function(t,e){t.id=t.type+"_"+i.uuid(),n.extend(t,e),this.create(t)},this.show=function(t,e,i){void 0===i&&(i=-1);var r=this.get(t);if(!r)throw new a("Invalid view id: "+t);n.isString(e)&&(e=[e]);var o=r.nodes.length;i=Math.min(i,o),0>i&&(i=Math.max(0,o+i+1));for(var c=[],h=0;h<e.length;h++){var u=e[h];if(void 0===this.nodes[u])throw new a("Invalid node id: "+u);c.push(s.ArrayOperation.Insert(i+h,u))}if(c.length>0){var l=s.ObjectOperation.Update([t,"nodes"],s.ArrayOperation.Compound(c));return this.apply(l)}},this.startSimulation=function(){var t=this,e=this.fromSnapshot(this.toJSON()),i=[];e.ops=i;var r=e.apply;return e.apply=function(t){return i.push(t),t=r.call(e,t)},e.save=function(e){for(var r=[],o=0;o<i.length;o++)"compound"!==i[o].type?r.push(i[o]):r=r.concat(i[o].ops);if(0!==r.length){var a=s.ObjectOperation.Compound(r);e&&(a.data=n.clone(e)),t.apply(a)}},e},this.fromSnapshot=function(t,e){return c.fromSnapshot(t,e)},this.uuid=function(t){return t+"_"+i.uuid()}},c.Prototype.prototype=o.Graph.prototype,c.prototype=new c.Prototype,c.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new c(e)},c.DocumentError=a,e.exports=c},{"substance-data":28,"substance-operator":130,"substance-util":144,underscore:151}],40:[function(t,e){"use strict";var n=t("./annotator"),i=t("./selection"),r=function(t){this.document=t.document,this.container=t,this.annotator=new n(this.document),this.selection=new i(this.container)};r.Prototype=function(){this.startSimulation=function(){var t=this.document.startSimulation(),e=new n(t),r=this.container.createContainer(t),o=new i(r,this.selection),s={};return o.isNull()||(s.selBefore=o.toJSON()),{document:t,view:r.name,selection:o,annotator:e,container:r,dispose:function(){r.dispose()},save:function(){s.selAfter=o.toJSON(),t.save(s),this.dispose()}}},this.dispose=function(){this.container.dispose()}},r.prototype=new r.Prototype,Object.defineProperties(r.prototype,{view:{get:function(){return this.container.name},set:function(){throw new Error("Immutable.")}}}),e.exports=r},{"./annotator":36,"./selection":42}],41:[function(t,e){"use strict";var n=t("underscore"),i=function(t){this.document=t,this.nodeTypes=this.document.nodeTypes,this.nodeSurfaces={}};i.Prototype=function(){this.getNodeSurface=function(t){var e,i;return n.isString(t)?e=t:(i=t,e=i.id),this.nodeSurfaces[e]||(i=i||this.document.get(e),this.nodeSurfaces[e]=this.createNodeSurface(i)),this.nodeSurfaces[e]},this.createNodeSurface=function(t){var e;if(!t)throw new Error("Unknown node: "+nodeId);var n=this.nodeTypes[t.type].Surface;return e=n?new n(t,this):new i.EmptySurface(t)},this.createCopy=function(t){return new i(t)}},i.prototype=new i.Prototype,i.EmptySurface=function(t){this.node=t,this.view=null,this.components=[]},e.exports=i},{underscore:151}],42:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=i.errors,o=t("./cursor"),s=r.define("SelectionError"),a=function(t,e){this.container=t,this.start=null,this.__cursor=new o(t,null,null),e&&this.set(e)};a.Prototype=function(){this.copy=function(){var t=new a(this.container);return this.isNull()||t.set(this),t},this.set=function(t){var e=this.__cursor;t instanceof a?(this.start=n.clone(t.start),e.set(t.__cursor.pos,t.__cursor.charPos)):n.isArray(t)?(this.start=n.clone(t),e.set(t[0],t[1])):(this.start=n.clone(t.start),e.set(t.end[0],t.end[1]));var i=this.start,r=this.container.getLength();if(i[0]<0||i[0]>=r)throw new s("Invalid node position: "+i[0]);var o=this.container.getLength(i[0]);if(i[1]<0||i[1]>o)throw new s("Invalid char position: "+i[1]);return this.trigger("selection:changed",this.range()),this},this.clear=function(){this.start=null,this.__cursor.set(null,null),this.trigger("selection:changed",null)},this.range=function(){if(this.isNull())return null;var t=this.start,e=this.__cursor.position();return this.isReverse()?{start:e,end:t}:{start:t,end:e}},this.isReverse=function(){var t=this.__cursor;return t.pos<this.start[0]||t.pos===this.start[0]&&t.charPos<this.start[1]},this.setCursor=function(t){return this.__cursor.set(t[0],t[1]),this.start=t,this},this.getCursor=function(){return this.__cursor.copy()},this.getCursorPosition=function(){return[this.__cursor.pos,this.__cursor.charPos]},this.selectNode=function(t){var e=this.container.getNodeComponents(t),n=e[0],i=e[e.length-1],r=this.container.getLength(i.pos);this.set({start:[n.pos,0],end:[i.pos,r]})},this.getPredecessor=function(){throw new Error("Not supported anymore")},this.getSuccessor=function(){throw new Error("Not supported anymore")},this.hasPredecessor=function(t){return t>0},this.hasSuccessor=function(t){var e=this.container.getLength();return e-1>t},this.collapse=function(t){if("right"!==t&&"left"!==t&&"start"!==t&&"cursor"!==t)throw new s("Invalid direction: "+t);if(!this.isCollapsed()&&!this.isNull()){if("start"===t)this.__cursor.set(this.start[0],this.start[1]);else if("cursor"===t)this.start[0]=this.__cursor.pos,this.start[1]=this.__cursor.charPos;else{var e=this.range();this.isReverse()?"left"===t?this.start=e.start:this.__cursor.set(e.end[0],e.end[1]):"left"===t?this.__cursor.set(e.start[0],e.start[1]):this.start=e.end}this.trigger("selection:changed",this.range())}},this.move=function(t,e){this.isCollapsed()||"char"!==e?(this.__cursor.move(t,e),this.start=this.__cursor.position()):this.collapse(t),this.trigger("selection:changed",this.range())},this.expand=function(t,e){this.__cursor.move(t,e),this.trigger("selection:changed",this.range())},this.toJSON=function(){var t=null;return this.isNull()||(t=this.isCollapsed()?this.__cursor.toJSON():{start:n.clone(this.start),end:this.__cursor.toJSON()}),t},this.getNodes=function(){throw new Error("This method has been removed, as it is not valid anymore after the Container refactor.")},this.getRanges=function(){if(this.isNull())return[];for(var t=[],e=this.range(),i=e.start[0];i<=e.end[0];i++){var r=0,o=null;i===e.start[0]&&(r=e.start[1]),i===e.end[0]&&(o=e.end[1]),n.isNumber(o)||(o=this.container.getLength(i)),t.push(new a.Range(this,i,r,o))}return t},this.startNode=function(){return this.isReverse()?this.__cursor.pos:this.start[0]},this.endNode=function(){return this.isReverse()?this.start[0]:this.__cursor.pos},this.startChar=function(){return this.isReverse()?this.__cursor.charPos:this.start[1]},this.endChar=function(){return this.isReverse()?this.start[1]:this.__cursor.charPos},this.isNull=function(){return null===this.start},this.isCollapsed=function(){return this.start[0]===this.__cursor.pos&&this.start[1]===this.__cursor.charPos},this.hasMultipleNodes=function(){return!this.isNull()&&this.startNode()!==this.endNode()}},a.Prototype.prototype=i.Events,a.prototype=new a.Prototype,Object.defineProperties(a.prototype,{cursor:{get:function(){return this.__cursor.copy()},set:function(){throw"immutable property"}}});var c=function(t,e,n,i){this.selection=t,this.pos=e,this.start=n,this.end=i,this.component=t.container.getComponent(e)};c.Prototype=function(){this.isFirst=function(){return this.pos===this.selection.startNode()},this.isLast=function(){return this.pos===this.selection.endNode()},this.hasPredecessor=function(){return!this.isFirst()},this.hasSuccessor=function(){return!this.isLast()},this.isEnclosed=function(){return this.hasPredecessor()&&this.hasSuccessor()},this.isRightBound=function(){return this.end===this.component.getLength()},this.isLeftBound=function(){return 0===this.start},this.length=function(){return this.end-this.start},this.content=function(){throw new Error("Not supported anymore")},this.isFull=function(){return this.isLeftBound()&&this.isRightBound()},this.isPartial=function(){return!this.isFull()}},c.prototype=new c.Prototype,Object.defineProperties(c.prototype,{node:{get:function(){throw new Error("Not supported anymore")},set:function(){throw new Error("Not supported anymore")}}}),a.Range=c,a.SelectionError=s,e.exports=a},{"./cursor":38,"substance-util":144,underscore:151}],43:[function(t,e){"use strict";var n=t("./src/editor");n.EditorController=t("./src/editor_controller"),e.exports=n},{"./src/editor":46,"./src/editor_controller":47}],44:[function(t,e){var n={selection:["up","down","left","right","shift+up","shift+down","shift+left","shift+right","ctrl+up","ctrl+down","ctrl+left","ctrl+right","ctrl+shift+up","ctrl+shift+down","ctrl+shift+left","ctrl+shift+right","alt+up","alt+down","alt+left","alt+right","alt+shift+up","alt+shift+down","alt+shift+left","alt+shift+right","command+up","command+down","command+left","command+right","command+shift+up","command+shift+down","command+shift+left","command+shift+right"],backspace:["backspace"],"delete":["del"],"break":["enter"],"soft-break":["shift+enter"],blank:["space","shift+space"],indent:["tab"],unindent:["shift+tab"],undo:["command+z"],redo:["command+shift+z"],copy:["command+c"],paste:["command+v"],strong:["ctrl+b"],emphasis:["ctrl+i"],heading:["ctrl+command+h"]};e.exports=n},{}],45:[function(t,e){var n={selection:["up","down","left","right","shift+up","shift+down","shift+left","shift+right","ctrl+up","ctrl+down","ctrl+left","ctrl+right","ctrl+shift+up","ctrl+shift+down","ctrl+shift+left","ctrl+shift+right"],backspace:["backspace"],"delete":["del"],"break":["enter"],"soft-break":["shift+enter"],blank:["space","shift+space"],indent:["tab"],unindent:["shift+tab"],undo:["ctrl+z"],redo:["ctrl+shift+z"],copy:["ctrl+c"],paste:["ctrl+v"],strong:["ctrl+b"],emphasis:["ctrl+i"],heading:["ctrl+alt+h"]};e.exports=n},{}],46:[function(t,e){var n=self,i=t("substance-surface"),r=t("substance-commander").ChromeKeyboard,o=function(t,e,n){i.call(this,t,e),n=n||{};var s=n.keymap||o._getDefaultKeyMap();this.keyboard=new r(s);var a=this.keyboard,c=this,h=this.el,u=this.$el,l=t;h.spellcheck=!1;var p=function(t){t.target.isContentEditable&&setTimeout(function(){c.updateSelection(t)},0)},d=function(){c.renderSelection.apply(c,arguments)},f=this.dispose;this.dispose=function(){f.call(this),this.deactivate()},this.onCursorMoved=function(){setTimeout(function(){c.updateSelection()},0)};var g=function(t){return function(e){try{t.call(c,e)}catch(n){console.log("Editor: triggering error",n),l.trigger("error",n)}e.preventDefault(),e.stopPropagation()}};a.pass("selection"),a.bind("selection","keydown",function(){window.setTimeout(function(){c.onCursorMoved()})}),a.pass("copy"),a.pass("cut"),a.pass("paste"),a.bind("backspace","keydown",g(function(){l.delete("left")})),a.bind("delete","keydown",g(function(){l.delete("right")})),a.bind("break","keydown",g(function(){l.breakNode()})),a.bind("soft-break","keydown",g(function(){l.write("\n")})),a.bind("blank","keydown",g(function(){l.write(" ")})),a.bind("indent","keydown",g(function(){l.indent("right")})),a.bind("unindent","keydown",g(function(){l.indent("left")})),a.bind("undo","keydown",g(function(){l.undo()})),a.bind("redo","keydown",g(function(){l.redo()})),a.bind("strong","keydown",g(function(){l.annotate("strong")})),a.bind("emphasis","keydown",g(function(){l.annotate("emphasis")})),a.bind("heading","keydown",g(function(){l.insertNode("heading",{level:1})})),a.bind("codeblock","keydown",g(function(){l.insertNode("codeblock")})),a.bind("list","keydown",g(function(){l.insertList()})),a.setDefaultHandler("keypress",g(function(t){l.write(String.fromCharCode(t.which))}));var v=[];a.setDefaultHandler("keyup",function(t){t.preventDefault(),t.stopPropagation(),v=[]}),a.setDefaultHandler("keydown",function(t){(229===t.keyCode||192===t.keyCode)&&(t.preventDefault(),t.stopPropagation())});var y=new MutationObserver(function(t){t.forEach(function(t){var e={mutation:t,el:t.target,value:t.target.textContent,oldValue:t.oldValue};v.push(e)})}),m={subtree:!0,characterData:!0,characterDataOldValue:!0},w=function(t,e){var n;for(n=0;n<e.length&&e[n]===t[n];n++);return t[n]};this.onTextInput=function(t){var e=t.data;if(!e&&v.length>0){var n=v[0],i=n.value.length-n.oldValue.length;if(1!==i)return console.error("ASSERT: this code assumes that there is a difference of one character."),void 0;e=w(n.value,n.oldValue),setTimeout(function(){try{n.el.textContent=n.oldValue,l.write(e)}catch(t){l.trigger("error",t)}},0)}else t.data&&setTimeout(function(){try{c.updateSelection(),l.write(e)}catch(t){l.trigger("error",t)}},0);v=[],t.preventDefault(),t.stopPropagation()},this.activate=function(){this.listenTo(l.session.selection,"selection:changed",d),h.addEventListener("textInput",this.onTextInput,!0),h.addEventListener("input",this.onTextInput,!0),u.mouseup(p),y.observe(c.el,m),a.connect(h),h.setAttribute("contenteditable","true")},this.deactivate=function(){this.stopListening(),h.removeEventListener("textInput",this.onTextInput,!0),h.removeEventListener("input",this.onTextInput,!0),u.off("mouseup"),y.disconnect(),a.disconnect(),h.setAttribute("contenteditable","true")},this.activate()};o._getDefaultKeyMap=function(){var e=t("./default_keymap_osx");if(void 0!==n.navigator){var i=n.navigator.platform;i.toLowerCase().search("linux")>=0?e=t("./default_keymap_unix"):i.toLowerCase().search("win32")>=0&&(e=t("./default_keymap_unix"))}return e},o.Prototype=function(){},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"./default_keymap_osx":44,"./default_keymap_unix":45,"substance-commander":24,"substance-surface":139}],47:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=t("substance-surface").SurfaceController,o=i.errors,s=o.define("EditingError"),a=function(t,e){this.session=t,this.editorFactory=e,this.editors={}};a.Prototype=function(){n.extend(this,i.Events),this.isEditor=function(){return!0},this.dispose=function(){this.session.dispose()},this.write=function(t){var e=this.session.selection;if(e.isNull())throw new s("Can not write, the current position is not valid.");var n=this.session.startSimulation();c(this,n,t)&&(n.save(),e.set(n.selection),o(this))},this.delete=function(t){var e=this.session.startSimulation(),n=e.selection;n.isNull()||(n.isCollapsed()&&n.expand(t,"char"),u(this,e)&&(e.save(),this.session.selection.set(n),o(this)))},this.breakNode=function(){var t=this.session.selection;if(t.isNull())return console.error("Can not break, as no position has been selected."),void 0;var e=this.session.startSimulation();h(this,e)&&(e.save(),t.set(e.selection),o(this))},this.indent=function(t){var e=this.session.selection;if(e.isNull())return console.error("Nothing is selected."),void 0;if(e.hasMultipleNodes())return console.error("Indenting Multi-Node selection is not supported yet."),void 0;var n=this.session.startSimulation(),i=n.selection,r=i.getCursor(),s=r.pos,c=n.container.getRootNodeFromPos(s),h=n.container.getComponent(s),u=a(this,c);return u.canIndent(n,h,t)?(u.indent(n,h,t),n.save(),o(this),void 0):(console.log("Can not indent at the given position."),void 0)},this.copy=function(){console.log("I am sorry. Currently disabled.")},this.cut=function(){console.log("I am sorry. Currently disabled.")},this.paste=function(){console.log("I am sorry. Currently disabled.")},this.undo=function(){if(this.session.document.chronicle){var t=this.session.document.chronicle.rewind();
t&&t.data&&this.session.selection.set(t.data.selBefore)}},this.redo=function(){if(this.session.document.chronicle){var t=this.session.document.chronicle.forward();t&&t.data&&this.session.selection.set(t.data.selAfter)}},this.annotate=function(t,e){var n=this.session.selection;if(n.isNull())throw new Error("Nothing selected.");if(n.hasMultipleNodes())throw new Error("Can only annotate within a single node/component.");var i=this.session.startSimulation();if("link"===t)e.url="http://example.com";else if("remark_reference"===t||"error_reference"===t){e=e||{};var s=v(this,i,t);e.target=s}r(this,i,t,e),i.save(),this.session.selection.set(i.selection),o(this)},this.deleteAnnotation=function(t){var e=this.session.document,n=e.get(t),i=this.session.container.lookup(n.path);e.delete(t),this.session.selection.set({start:[i.pos,n.range[0]],end:[i.pos,n.range[1]]})},this.updateNode=function(t,e,n){this.session.document.set([t,e],n),o(this)},this.addReference=function(t,e){var n=this.session.selection;if(n.isNull())return console.error("Nothing is selected."),void 0;var i=this.session.startSimulation(),s=i.selection;s.getCursor(),r(this,i,t,e),i.save(),n.set(i.selection),o(this)},this.canInsertNode=function(){var t=this.session.selection,e=this.session.container;if(t.isNull())return!1;var n=t.range().start,i=n[0],r=n[1],o=e.getComponent(i),s=o.node,c=a(this,s);return c.canBreak(this.session,o,r)},this.insertNode=function(e,r){var s=this.session.selection;if(s.isNull())throw new Error("Selection is null!");var a=this.session.startSimulation(),c={id:e+"_"+i.uuid(),type:e};r&&n.extend(c,r),t(this,a,c)&&(a.save(),this.session.selection.set(a.selection),o(this))},this.insertList=function(){var e=this.session.selection;if(e.isNull())throw new Error("Selection is null!");var n=this.session.startSimulation(),r={type:"list_item",id:"list_item_"+i.uuid(),level:1,content:""};n.document.create(r);var s={type:"list",id:"list_"+i.uuid(),items:[r.id]};t(this,n,s)&&(n.save(),this.session.selection.set(n.selection),o(this))};var t=function(t,e,n){var i=e.selection;if(!i.isCollapsed()&&!u(t,e))return console.log("Could not delete the selected content"),!1;var r,o,s=i.getCursor(),a=s.pos,c=s.charPos,l=e.container.getComponent(a);if(c<l.getLength()){var p=h(t,e);if(!p)return!1;r=i.range().start,o=e.container.getNodePos(r[0])}else r=i.range().start,o=e.container.getNodePos(r[0])+1;e.document.create(n),e.document.show(e.view,n.id,o);var d=e.container.getNodeComponents(n.id);return d.length>0&&i.set([d[0].pos,0]),!0};this.createComment=function(t){this.session.document.comment(t)};var e=[{action:"createNode",type:"heading",data:{level:1}},{action:"createNode",type:"codeblock",data:{}}];i.freeze(e),this.getAllowedActions=function(){return this.canInsertNode()?e:[]};var r=function(t,e,n,i){var r=e.selection.range(),o=r.start[0],s=[r.start[1],r.end[1]],c=e.container.getRootNodeFromPos(o),h=e.container.getComponent(o),u=a(t,c);return u.canAnnotate(e,h,n,s)?(u.annotate(e,h,n,s,i),e.selection.set(r),void 0):(console.log("Can not annotate component",h),void 0)},o=function(t){var e=t.session.document;e.chronicle&&e.chronicle.mark("master"),t.trigger("document:edited")},a=function(t,e){return t.editors[e.id]||(t.editors[e.id]=t.editorFactory.createEditor(e)),t.editors[e.id]},c=function(t,e,n){var i=e.selection;if(!i.isCollapsed()&&!u(t,e))return console.log("Could not delete the selected content"),!1;var r=i.getCursor(),o=r.pos,s=r.charPos,c=e.container.getRootNodeFromPos(o),h=e.container.getComponent(o),l=a(t,c);return l.canInsertContent(e,h,s)?(l.insertContent(e,h,s,n),i.set([o,s+n.length]),!0):(console.log("Can not insert at the given position."),!1)},h=function(t,e){var n=e.selection,i=n.range().start,r=i[0],o=i[1],s=e.container.getComponent(r),c=e.container.getRootNodeFromPos(r),h=a(t,c);return h.canBreak(e,s,o)?n.isCollapsed()||u(t,e)?(o=n.getCursor().charPos,h.breakNode(e,s,o),!0):(console.log("Could not delete the selected content"),!1):!1},u=function(t,e){var n,i=e.selection,r=i.range().start;if(i.hasMultipleNodes())n=p(t,e);else{var o=i.start[0],s=e.container.getComponent(o);n=l(t,e,s)}return i.set(r),n},l=function(t,e,n){var i=e.selection,r=e.container.getRootNodeFromPos(n.pos),o=i.startChar(),s=i.endChar(),c=a(t,r);return c.canDeleteContent(e,n,o,s)?(c.deleteContent(e,n,o,s),!0):(console.log("Can not delete content",r.type,o,s),!1)},p=function(t,e){var n,i,r,o=e.selection.getRanges(),s=e.container,c=[],h=a(t,{type:"view",id:s.name});for(n=0;n<o.length;n++){i=o[n],r=i.component.node;var u,l,p=s.getNodeComponents(r.id),f=n,g=f+p.length-1;if(g<o.length&&i.isFull()&&o[g].isFull())l=h,u=l.canDeleteNode(e,r),c.push({type:"node",editor:l,range:i});else{l=a(t,r);for(var v=f;g>=v;v++)i=o[v],u=l.canDeleteContent(e,i.component,i.start,i.end),c.push({type:"content",editor:l,range:i})}if(n=g,!u)return console.log("Can't delete component:",i.component),!1}var y=o.length>0&&o[0].isPartial()&&o[o.length-1].isPartial();for(n=c.length-1;n>=0;n--){var m=c[n];i=m.range,"content"===m.type?m.editor.deleteContent(e,i.component,i.start,i.end):(r=i.component.node,m.editor.deleteNode(e,r),e.document.delete(r.id))}if(y){var w=o[0].component.node,b=o[o.length-1].component.node;d(t,e,w,b)}return!0},d=function(t,e,n,i){var r=a(t,n),o=a(t,{type:"view",id:e.container.name});return r.canJoin(e,n,i)?o.canDeleteNode(e,i)?(r.join(e,n,i),o.deleteNode(e,i),e.document.delete(i.id),!0):!1:!1},f={error_reference:"error",remark_reference:"remark"},g={error:"errors",remark:"remarks"},v=function(t,e,n){var r=f[n],o=g[r];if(!r)throw new Error("Unsupported issue type:"+n);var s=e.document,a={id:r+"_"+i.uuid(),type:r,created_at:new Date,creator:Math.random()>.5?"Michael Aufreiter":"Oliver Buchtala"};return s.create(a),s.show(o,[a.id]),a.id}},a.Prototype.prototype=r.prototype,a.prototype=new a.Prototype,Object.defineProperties(a.prototype,{selection:{get:function(){return this.session.selection},set:function(){throw new Error("Immutable.")}},annotator:{get:function(){return this.session.annotator},set:function(){throw new Error("Immutable.")}},container:{get:function(){return this.session.container},set:function(){throw new Error("Immutable.")}},document:{get:function(){return this.session.document},set:function(){throw new Error("Immutable.")}},view:{get:function(){return console.error("TODO: rename this property."),this.session.container.name},set:function(){throw new Error("Immutable.")}}}),a.EditingError=s,e.exports=a},{"substance-surface":139,"substance-util":144,underscore:151}],48:[function(t,e){"use strict";e.exports={node:t("./src/node"),text:t("./src/text"),heading:t("./src/heading"),codeblock:t("./src/codeblock"),image:t("./src/image"),figure:t("./src/figure"),contributor:t("./src/contributor"),cover:t("./src/cover"),citation:t("./src/citation"),annotation:t("./src/annotation"),emphasis:t("./src/emphasis"),strong:t("./src/strong"),subscript:t("./src/subscript"),superscript:t("./src/superscript"),code:t("./src/code"),link:t("./src/link"),list:t("./src/list"),list_item:t("./src/list_item"),math:t("./src/math"),issue:t("./src/issue"),remark:t("./src/remark"),error:t("./src/error"),file:t("./src/file"),blob_reference:t("./src/blob_reference"),figure_reference:t("./src/figure_reference"),citation_reference:t("./src/citation_reference"),cross_reference:t("./src/cross_reference"),remark_reference:t("./src/remark_reference"),error_reference:t("./src/error_reference"),paragraph:t("./src/paragraph"),table:t("./src/table"),formula:t("./src/formula")}},{"./src/annotation":50,"./src/blob_reference":52,"./src/citation":55,"./src/citation_reference":57,"./src/code":59,"./src/codeblock":62,"./src/contributor":65,"./src/cover":68,"./src/cross_reference":70,"./src/emphasis":72,"./src/error":75,"./src/error_reference":77,"./src/figure":80,"./src/figure_reference":82,"./src/file":84,"./src/formula":87,"./src/heading":90,"./src/image":93,"./src/issue":94,"./src/link":97,"./src/list":99,"./src/list_item":102,"./src/math":105,"./src/node":107,"./src/paragraph":110,"./src/remark":113,"./src/remark_reference":116,"./src/strong":118,"./src/subscript":120,"./src/superscript":122,"./src/table":124,"./src/text":127}],49:[function(t,e){"use strict";var n=t("../node/node");t("underscore");var i=function(t,e){n.call(this,t,e)};i.type={id:"annotation",properties:{path:["array","string"],range:"object"}},i.description={name:"Annotation",remarks:["Abstract type for all available annotations"],properties:{path:"References node and property in the graph.",range:"Tuple describing start and end character offset."}},i.example={type:"emphasis",id:"emphasis_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){this.getContent=function(){var t=this.document.get(this.path);if(t){var e=this.range;return t.substring(e[0],e[1])}return console.error("FIXME: this annotation references a deleted node",this,this.path),"N/A"}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":108,underscore:151}],50:[function(t,e){"use strict";e.exports={Model:t("./annotation")}},{"./annotation":49}],51:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"blob_reference",properties:{path:["array","string"],blob:"string"}},i.description={name:"BlobReference",remarks:["References a blob in the volatile blob store"],properties:{path:"Referenced node/property",blob:"Referenced blob id"}},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":108}],52:[function(t,e){"use strict";e.exports={Model:t("./blob_reference")}},{"./blob_reference":51}],53:[function(t,e){var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"article_citation",parent:"content",properties:{source_id:"string",title:"string",label:"string",authors:["array","string"],doi:"string",source:"string",volume:"string",publisher_name:"string",publisher_location:"string",fpage:"string",lpage:"string",year:"string",citation_urls:["array","string"]}},i.description={name:"Citation",remarks:["A journal citation.","This element can be used to describe all kinds of citations."],properties:{title:"The article's title",label:"Optional label (could be a number for instance)",doi:"DOI reference",source:"Usually the journal name",volume:"Issue number",publisher_name:"Publisher Name",publisher_location:"Publisher Location",fpage:"First page",lpage:"Last page",year:"The year of publication",citation_urls:"A list of links for accessing the article on the web"}},i.example={id:"article_nature08160",type:"article_citation",label:"5",title:"The genome of the blood fluke Schistosoma mansoni",authors:["M Berriman","BJ Haas","PT LoVerde"],doi:"http://dx.doi.org/10.1038/nature08160",source:"Nature",volume:"460",fpage:"352",lpage:"8",year:"1984",citation_urls:["http://www.ncbi.nlm.nih.gov/pubmed/19606141"]},i.Prototype=function(){this.urls=function(){return this.properties.citation_urls.length>0?this.properties.citation_urls:[this.properties.doi]}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),Object.defineProperties(i.prototype,{header:{get:function(){return this.properties.title},set:function(){throw new Error("This is a read-only alias property.")}}}),e.exports=i},{"../node/node":108}],54:[function(t,e){"use strict";var n=t("../node").View,i=t("../text").View,r=t("substance-application").$$,o=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("citation")};o.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=document.createDocumentFragment(),e=this.node;this.titleView=new i(this.node,this.viewFactory,{property:"title"}),t.appendChild(this.titleView.render().el);var o=r(".resource-body");this.authorEls=[];for(var s=r(".authors"),a=0;a<e.authors.length;a++){var c=e.authors[a];this.authorEls.push(r("span.author",{text:c})),s.appendChild(this.authorEls[a]),s.appendChild(document.createTextNode(" "))}o.appendChild(s);var h=[];return e.source&&e.volume&&h.push([e.source,e.volume].join(", ")+": "),e.fpage&&e.lpage&&h.push([e.fpage,e.lpage].join("-")+", "),e.publisher_name&&e.publisher_location&&h.push([e.publisher_name,e.publisher_location].join(", ")+", "),e.year&&h.push(e.year),this.sourceEl=r(".source",{html:h.join("")}),o.appendChild(this.sourceEl),e.doi&&(this.doiEl=r(".doi",{children:[r("b",{text:"DOI: "}),r("a",{href:e.doi,target:"_new",text:e.doi})]}),o.appendChild(this.doiEl)),t.appendChild(o),this.content.appendChild(t),this},this.dispose=function(){n.dispose.call(this),this.titleView.dispose()}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"../node":107,"../text":127,"substance-application":4}],55:[function(t,e){"use strict";e.exports={Model:t("./citation"),View:t("./citation_view")}},{"./citation":53,"./citation_view":54}],56:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"citation_reference",parent:"annotation",properties:{target:"citation"}},i.description={name:"CitationReference",remarks:["References a range in a text-ish node and references a citation."],properties:{}},i.example={type:"citation_reference_1",id:"citation_reference_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":49}],57:[function(t,e){"use strict";e.exports={Model:t("./citation_reference")}},{"./citation_reference":56}],58:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"code",parent:"annotation",properties:{}},i.description={name:"Code",remarks:["References a range in a text-ish node and tags it as subscript"],properties:{}},i.example={type:"code_1",id:"code_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":49}],59:[function(t,e){"use strict";e.exports={Model:t("./code")}},{"./code":58}],60:[function(t,e){"use strict";var n=t("../text/text_node"),i=function(t,e){n.call(this,t,e)};i.type={id:"codeblock",parent:"content",properties:{source_id:"string",content:"string"}},i.config={zoomable:!0},i.description={name:"Codeblock",remarks:["Text in a codeblock is displayed in a fixed-width font, and it preserves both spaces and line breaks"],properties:{content:"Content"}},i.example={type:"codeblock",id:"codeblock_1",content:'var text = "Sun";\nvar op1 = Operator.TextOperation.Delete(2, "n");\ntext = op2.apply(op1.apply(text));\nconsole.log(text);'},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../text/text_node":128}],61:[function(t,e){"use strict";var n=t("../text/text_view"),i=function(t){n.call(this,t),this.$el.addClass("content-node codeblock")};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../text/text_view":129}],62:[function(t,e){"use strict";e.exports={Model:t("./codeblock"),View:t("./codeblock_view")}},{"./codeblock":60,"./codeblock_view":61}],63:[function(t,e){var n=t("underscore"),i=t("../node/node"),r=function(t,e){i.call(this,t,e)};r.type={id:"contributor",parent:"content",properties:{source_id:"string",name:"string",role:"string",organization:"string",image:"blob",image_url:"string",email:"string",contribution:"string"}},r.description={name:"Contributor",remarks:["Describes an article contributor such as an author or editor."],properties:{name:"Full name."}},r.example={id:"contributor_1",type:"contributor",role:"author",name:"John Doe",email:"a@b.com",contribution:"Revising the article, data cleanup"},r.Prototype=function(){this.getAffiliations=function(){return n.map(this.properties.affiliations,function(t){return this.document.get(t)},this)},this.getBlob=function(){if(!this.properties.image)return null;var t=this.document.get(this.properties.image);return t?t.getData():null},this.getUrl=function(){var t=this.getBlob();return t?window.URL.createObjectURL(t):this.properties.image_url}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,r.prototype.defineProperties(),Object.defineProperties(r.prototype,{header:{get:function(){return this.properties.name},set:function(){throw new Error("This is a read-only alias property.")}}}),e.exports=r},{"../node/node":108,underscore:151}],64:[function(t,e){"use strict";var n=t("../node").View,i=t("substance-application").$$,r=t("../text/text_view"),o=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node contributor")};o.Prototype=function(){this.render=function(){n.prototype.render.call(this),this.nameView=new r(this.node,this.viewFactory,{property:"name"}),$(this.nameView.el).addClass("toggle-resource"),this.content.appendChild(this.nameView.render().el);var t=i(".resource-body"),e=this.node.image||this.node.image_url;return e&&(this.imageEl=i(".image",{children:[i("img",{src:e})]}),t.appendChild(this.imageEl)),this.organizationView=new r(this.node,this.viewFactory,{property:"organization"}),t.appendChild(this.organizationView.render().el),this.node.contribution&&(t.appendChild(i(".label",{text:"Contribution"})),this.contribEl=i(".contribution.node-property",{text:this.node.contribution,"data-path":"contribution"}),t.appendChild(this.contribEl)),t.appendChild(i(".label",{text:"Email",contenteditable:!1})),this.emailView=new r(this.node,this.viewFactory,{property:"email"}),t.appendChild(this.emailView.render().el),this.content.appendChild(t),this},this.dispose=function(){n.dispose.call(this),this.nameView.dispose(),this.organization.dispose(),this.emailView.dispose()}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":107,"../text/text_view":129,"substance-application":4}],65:[function(t,e){"use strict";e.exports={Model:t("./contributor"),View:t("./contributor_view")}},{"./contributor":63,"./contributor_view":64}],66:[function(t,e){t("underscore");var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"cover",parent:"content",properties:{source_id:"string",image:"string"}},i.description={name:"Cover",remarks:["Virtual view on the title and authors of the paper."],properties:{}},i.example={id:"cover",type:"cover",image:"http://example.com/image.png"},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),Object.defineProperties(i.prototype,{title:{get:function(){return this.document.title},set:function(){throw new Error("This is a read-only property alias.")}}}),e.exports=i},{"../node/node":108,underscore:151}],67:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-application").$$,r=t("../node/node_view"),o=t("../text/text_view"),s=t("substance-document").Annotator,a=function(t,e){r.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node cover")};a.Prototype=function(){this.render=function(){return r.prototype.render.call(this),this.node.document.published_on&&this.content.appendChild(i(".published-on",{contenteditable:!1,html:new Date(this.node.document.published_on).toDateString()})),this.titleView=new o(this.node,this.viewFactory,{property:"title"}),this.content.appendChild(this.titleView.render().el),this.titleView.el.classList.add("title"),this.authorsEl=i(".authors"),this.renderAuthors(),this.content.appendChild(this.authorsEl),this},this.dispose=function(){r.dispose.call(this),this.titleView.dispose()},this.renderAuthors=function(){this.authorsEl.innerHTML="";var t=this.node.document.getAuthors();n.each(t,function(t){var e=i("a.toggle-author",{id:"toggle_"+t.id,href:"#",text:t.name,"data-id":t.id});this.authorsEl.appendChild(e)},this)},this.onGraphUpdate=function(t){return r.prototype.onGraphUpdate.call(this,t)?!0:n.isEqual(t.path,["document","title"])?(this.titleView.renderContent(),!0):(n.isEqual(t.path,["document","authors"])&&this.renderAuthors(),s.changesAnnotations(this.node.document,t,["cover","title"])?(this.titleView.renderContent(),!0):void 0)}},a.Prototype.prototype=r.prototype,a.prototype=new a.Prototype,e.exports=a},{"../node/node_view":109,"../text/text_view":129,"substance-application":4,"substance-document":35,underscore:151}],68:[function(t,e){"use strict";e.exports={Model:t("./cover"),View:t("./cover_view")}},{"./cover":66,"./cover_view":67}],69:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"cross_reference",parent:"annotation",properties:{target:"content"}},i.description={name:"CrossReference",remarks:["References a range in a text-ish node and references a content node."],properties:{}},i.example={type:"cross_reference_1",id:"cross_reference_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":49}],70:[function(t,e){"use strict";e.exports={Model:t("./cross_reference")}},{"./cross_reference":69}],71:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"emphasis",parent:"annotation",properties:{}},i.description={name:"Emphasis",remarks:["References a range in a text-ish node and tags it as emphasized"],properties:{}},i.example={type:"emphasis",id:"emphasis_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":49}],72:[function(t,e){"use strict";e.exports={Model:t("./emphasis")}},{"./emphasis":71}],73:[function(t,e){"use strict";var n=t("../issue/issue"),i=function(t,e){n.call(this,t,e)};i.type={id:"error",parent:"issue",properties:{}},i.description={name:"Error",remarks:["References a range in a text-ish node and tags it as emphasized"],properties:{}},i.example={type:"error",id:"error_1",title:"Hi I am an a error",description:"An error, yes."},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../issue/issue":95}],74:[function(t,e){"use strict";var n=t("../issue/issue_view"),i=function(t,e){n.call(this,t,e)};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../issue/issue_view":96}],75:[function(t,e){"use strict";e.exports={Model:t("./error"),View:t("./error_view")}},{"./error":73,"./error_view":74}],76:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"error_reference",parent:"annotation",properties:{target:"error"}},i.description={name:"ErrorReference",remarks:["References a range in a text-ish node and references an error"],properties:{target:"Referenced error id"}},i.example={type:"error_reference_1",id:"error_reference_1",path:["text_54","content"],range:[85,95],target:"error_1"},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":49}],77:[function(t,e){"use strict";e.exports={Model:t("./error_reference")}},{"./error_reference":76}],78:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"figure",parent:"content",properties:{image:"blob_reference",image_url:"string",label:"string",caption:"paragraph"}},i.description={name:"Figure",remarks:["A figure is a figure is figure."],properties:{label:"Figure label (e.g. Figure 1)",image:"BlobReference id that has the image blob",image_url:"Image url",caption:"A reference to a paragraph that describes the figure"}},i.example={id:"figure_1",label:"Figure 1",url:"http://example.com/fig1.png",image:"",caption:"paragraph_1"},i.config={zoomable:!0},i.Prototype=function(){this.hasCaption=function(){return!!this.properties.caption},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0},this.getBlob=function(){if(!this.properties.image)return null;var t=this.document.get(this.properties.image);return t?t.getData():null},this.getUrl=function(){var t=this.getBlob();return t?window.URL.createObjectURL(t):this.properties.image_url}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),Object.defineProperties(i.prototype,{header:{get:function(){return this.properties.label},set:function(){throw new Error("This is a read-only alias property.")}}}),i.create=function(t){var e={},n=t.id,i={id:n,type:"figure",label:t.label,image_url:t.image_url};if(t.caption){var r="caption_"+t.id,o={id:r,type:"text",content:t.caption};e[r]=o,i.caption=r}return e[n]=i,e},e.exports=i},{"../node/node":108}],79:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("../node/node_view"),r=t("../text/text_view"),o=function(t,e){i.call(this,t,e)};o.Prototype=function(){this.render=function(){i.prototype.render.call(this),this.labelView=new r(this.node,this.viewFactory,{property:"label"}),$(this.labelView.el).addClass("toggle-resource"),this.content.appendChild(this.labelView.render().el);var t=n(".resource-body"),e=this.node.image||this.node.image_url;this.imgWrapper=n(".image-wrapper",{children:[n("a",{href:e,title:"View image in full size",target:"_blank",children:[n("img",{src:e})]})]}),t.appendChild(this.imgWrapper);var o=this.node.getCaption();if(o){this.captionView=this.viewFactory.createView(o);var s=this.captionView.render().el;s.classList.add("caption"),t.appendChild(s)}return this.content.appendChild(t),this},this.dispose=function(){i.dispose.call(this),this.labelView.dispose(),this.captionView&&this.captionView.dispose()}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node/node_view":109,"../text/text_view":129,"substance-application":4}],80:[function(t,e){"use strict";e.exports={Model:t("./figure"),View:t("./figure_view")}},{"./figure":78,"./figure_view":79}],81:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"figure_reference",parent:"annotation",properties:{target:"figure"}},i.description={name:"FigureReference",remarks:["References a range in a text-ish node and references a figure"],properties:{target:"Referenced figure id"}},i.example={type:"figure_reference_1",id:"figure_reference_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":49}],82:[function(t,e){"use strict";e.exports={Model:t("./figure_reference")}},{"./figure_reference":81}],83:[function(t,e){"use strict";var n=t("../node/node"),i=t("underscore"),r=function(t,e){n.call(this,t,e)};r.type={id:"file",parent:"content",properties:{version:"number",content_type:"string"}},r.description={name:"File",remarks:["A file is a file is a file."],properties:{content_type:"Content MIME type",version:"File version, gets incremented every time the file content changes."}},r.example={id:"figure1.png",version:1,content_type:"image/png"},r.Prototype=function(){this.isText=function(){return i.include(["application/json","text/css","text/plain"],this.properties.content_type)},this.isBinary=function(){return!this.isText()},this.isJSON=function(){return"application/json"===this.properties.content_type},this.getData=function(t){var e=this.properties.id+".v"+(t||this.properties.version);return this.document.fileData[e]},this.updateData=function(t){var e=this.properties.version;e&&!this.getData(e)||(e=e?e+1:1);var n=this.properties.id+".v"+e;this.document.fileData[n]=this.isJSON()?JSON.parse(t):this.isText()?t:new Blob([t],{type:this.properties.content_type}),e!==this.properties.version&&this.document.set([this.properties.id,"version"],e)}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,r.prototype.defineProperties(),e.exports=r},{"../node/node":108,underscore:151}],84:[function(t,e){"use strict";e.exports={Model:t("./file")}},{"./file":83}],85:[function(t,e){"use strict";var n=t("../node/node"),i=function(t){n.call(this,t)};i.type={id:"formula",parent:"content",properties:{source_id:"string",label:"string",data:"string",format:"string",inline:"boolean"}},i.description={name:"Formula",remarks:["Can either be expressed in MathML format or using an image url"],properties:{label:"Formula label (4)",data:"Formula data, either MathML or image url",format:"Can either be `mathml` or `image`"}},i.example={type:"formula",id:"formula_eqn1",label:"(1)",content:"<mml:mrow>...</mml:mrow>",format:"mathml"},i.Prototype=function(){this.inline=!1},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":108}],86:[function(t,e){"use strict";var n=t("../node/node_view"),i=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node formula"),this.node.inline&&this.$el.addClass("inline")};i.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=this.node.format;switch(t){case"mathml":this.$el.html(this.node.data);break;case"image":this.$el.append('<img src="'+this.node.url+'"/>');break;case"latex":this.node.inline?this.$el.html("\\("+this.node.data+"\\)"):this.$el.html("\\["+this.node.data+"\\]");break;default:console.error("Unknown formula format:",t)}return this.node.label&&this.$el.append($('<div class="label">').html(this.node.label)),this}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../node/node_view":109}],87:[function(t,e){"use strict";e.exports={Model:t("./formula"),View:t("./formula_view")}},{"./formula":85,"./formula_view":86}],88:[function(t,e){"use strict";var n=t("../text/text_node"),i=function(t,e){n.call(this,t,e)};i.type={id:"heading",parent:"content",properties:{source_id:"string",content:"string",level:"number"}},i.example={type:"heading",id:"heading_1",content:"Introduction",level:1},i.description={name:"Heading",remarks:["Denotes a section or sub section in your article."],properties:{content:"Heading content",level:"Heading level. Ranges from 1..4"}},i.Prototype=function(){this.splitInto="paragraph"},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../text/text_node":128}],89:[function(t,e){"use strict";var n=t("../text/text_view"),i=function(t){n.call(this,t),this.$el.addClass("heading"),this._level=this.node.level,this.$el.addClass("level-"+this._level)};i.Prototype=function(){var t=n.prototype;this.onNodeUpdate=function(e){t.onNodeUpdate.call(this,e),"level"===e.path[1]&&(this.$el.removeClass("level-"+this._level),this._level=this.node.level,this.$el.addClass("level-"+this._level))}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../text/text_view":129}],90:[function(t,e){"use strict";e.exports={Model:t("./heading"),View:t("./heading_view")}},{"./heading":88,"./heading_view":89}],91:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"image",parent:"content",properties:{source_id:"string",url:"string"}},i.description={name:"Image",remarks:["Represents an image web resource."],properties:{url:"URL to a resource"}},i.example={type:"image",id:"image_1",url:"http://substance.io/image_1.png"},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i
},{"../node/node":108}],92:[function(t,e){"use strict";var n=t("../node/node"),i=t("substance-application").$$,r=function(t,e){n.call(this,t,e),this.$el.addClass("image"),this.$el.attr("id",this.node.id)};r.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=this.imgCharEl=i(".image-char"),e=i("img",{src:this.node.url,alt:"alt text",title:"alt text"});return t.appendChild(e),this.content.appendChild(t),this},this.delete=function(t,e){for(var n=this.$(".content")[0],i=n.childNodes,r=e-1;r>=0;r--)n.removeChild(i[t+r])}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node/node":108,"substance-application":4}],93:[function(t,e){"use strict";e.exports={Model:t("./image"),View:t("./image_view")}},{"./image":91,"./image_view":92}],94:[function(t,e){"use strict";e.exports={Model:t("./issue"),View:t("./issue_view")}},{"./issue":95,"./issue_view":96}],95:[function(t,e){"use strict";var n=t("../node/node"),i=function(t,e){n.call(this,t,e)};i.type={id:"issue",properties:{title:"string",description:"string",creator:"string",created_at:"date"}},i.description={name:"Issue",remarks:["References a range in a text-ish node and tags it as subscript"],properties:{title:"Issue Title",description:"More verbose issue description",creator:"Issue creator",created_at:"Date and time of issue creation."}},i.example={"abstract":"type"},i.Prototype=function(){this.hasDescription=function(){return!!this.properties.caption},this.getDescription=function(){return this.properties.description?this.document.get(this.properties.description):void 0},this.getReferences=function(){var t=this.document.indexes.references;return t?t.get(this.properties.id):(console.error("No index for references."),[])}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../node/node":108}],96:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("../node/node_view"),r=t("../text/text_view"),o=function(t,e){i.call(this,t,e),this.$el.addClass("issue")};o.Prototype=function(){var t=i.prototype;this._updateTitle=function(){this.titleTextEl.innerHTML=this.ref?this.ref.getContent():""},this.render=function(){i.prototype.render.call(this);var t=n("div.issue-title-wrapper");this.titleTextEl=n(".text.title"),t.appendChild(this.titleTextEl),this.content.appendChild(t),n("div.creator",{text:(this.node.creator||"Anonymous")+", "+jQuery.timeago(new Date(this.node.created_at)),contenteditable:!1}),this.descriptionView=new r(this.node,this.viewFactory,{property:"description"}),this.content.appendChild(this.descriptionView.render().el);var e=this.node.getReferences(),o=Object.keys(e);return o.length>0&&(this.ref=e[o[0]],this._updateTitle()),this},this.dispose=function(){i.dispose.call(this),this.descriptionView.dispose()},this.onNodeUpdate=function(t){return"description"===t.path[1]?(this.descriptionView.onNodeUpdate(t),!0):!1},this.onGraphUpdate=function(e){return t.onGraphUpdate.call(this,e)?!0:"create"===e.type&&e.val.target===this.node.id?(this.ref=this.node.document.get(e.val.id),this._updateTitle(),!0):"delete"===e.type&&e.val.target===this.node.id?(this.ref=null,this._updateTitle(),!0):this.ref&&e.path[0]===this.ref.id?(this._updateTitle(),!0):!1}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node/node_view":109,"../text/text_view":129,"substance-application":4}],97:[function(t,e){"use strict";e.exports={Model:t("./link")}},{"./link":98}],98:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"link",parent:"annotation",properties:{url:"string"}},i.description={name:"Link",remarks:["References a range in a text-ish node and tags it as subscript"],properties:{}},i.example={type:"link_1",id:"link_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":49}],99:[function(t,e){"use strict";e.exports={Model:t("./list"),View:t("./list_view")}},{"./list":100,"./list_view":101}],100:[function(t,e){"use strict";var n=t("underscore"),i=t("../node/node"),r=function(t,e){i.call(this,t,e)};r.type={id:"list",parent:"content",properties:{source_id:"string",items:["array","list_item"],ordered:"boolean"}},r.description={name:"List",remarks:["Lists can either be numbered or bullet lists"],properties:{ordered:"Specifies wheter the list is ordered or not",items:"An array of listitem references"}},r.example={type:"list",id:"list_1","items ":["listitem_1","listitem_2"]},r.Prototype=function(){this.getItems=function(){return n.map(this.properties.items,function(t){return this.document.get(t)},this)}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,r.prototype.defineProperties(),e.exports=r},{"../node/node":108,underscore:151}],101:[function(t,e){"use strict";var n=t("../node/node_view"),i=t("underscore"),r=t("substance-application").$$,o=function(t,e){n.call(this,t,e),this.el=t.ordered?r("ol"):r("ul"),this.$el=$(this.el),this.$el.addClass("content-node").addClass(t.type),this.$el.attr("id",this.node.id),this.childViews={}};o.Prototype=function(){var t=n.prototype;this.render=function(){return t.render.call(this),i.each(this.node.getItems(),function(t){var e=this.viewFactory.createView(t,"overwrite");this.content.appendChild(e.render().el),this.childViews[t.id]=e},this),this},this.onNodeUpdate=function(t){t.path[0]===this.node.id&&"items"===t.path[1]&&this.render()},this.dispose=function(){t.dispose.call(this)}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node/node_view":109,"substance-application":4,underscore:151}],102:[function(t,e){"use strict";e.exports={Model:t("./list_item"),View:t("./list_item_view")}},{"./list_item":103,"./list_item_view":104}],103:[function(t,e){"use strict";t("underscore");var n=t("../text/text_node"),i=function(t,e){n.call(this,t,e)};i.type={id:"list_item",parent:"content",properties:{level:"number",content:"string"}},i.description={name:"ListItem",remarks:["ListItems have a level of nesting."],properties:{level:"Specifies the indentation level",content:"The item's content"}},i.example={type:"list_item",id:"list_item_1",level:1,content:"This is item 1"},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../text/text_node":128,underscore:151}],104:[function(t,e){"use strict";var n=t("../text/text_view");t("underscore");var i=t("substance-application").$$,r=function(t){n.call(this,t),this.el=i("li.list-item"),this.$el=$(this.el),this.$el.attr("id",this.node.id),this.$el.attr("data-path",t.id),this._level=this.node.level,this.$el.addClass("level-"+this._level)};r.Prototype=function(){var t=n.prototype;this.onNodeUpdate=function(e){t.onNodeUpdate.call(this,e),"level"===e.path[1]&&(this.$el.removeClass("level-"+this._level),this._level=this.node.level,this.$el.addClass("level-"+this._level))},this.dispose=function(){console.log("Disposing ListItemView..."),t.dispose.call(this)}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../text/text_view":129,"substance-application":4,underscore:151}],105:[function(t,e){"use strict";e.exports={Model:t("./math")}},{"./math":106}],106:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"math",parent:"annotation",properties:{}},i.description={name:"Math",remarks:["References a range in a text-ish node and tags it as subscript"],properties:{}},i.example={type:"math_1",id:"math_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":49}],107:[function(t,e){"use strict";e.exports={Model:t("./node"),View:t("./node_view")}},{"./node":108,"./node_view":109}],108:[function(t,e){"use strict";var n=t("underscore"),i=function(t,e){this.document=e,this.properties=t};i.type={parent:"content",properties:{}},i.Prototype=function(){this.toJSON=function(){return n.clone(this.properties)},this.getAnnotations=function(){return this.document.getIndex("annotations").get(this.properties.id)},this.isInstanceOf=function(t){var e=this.document.getSchema();return e.isInstanceOf(this.type,t)},this.defineProperties=function(t){if(!this.hasOwnProperty("constructor"))throw new Error("Constructor property is not set. E.g.: MyNode.prototype.constructor = MyNode;");var e=this.constructor;i.defineAllProperties(e,t)}},i.prototype=new i.Prototype,i.prototype.constructor=i,i.defineProperties=function(t,e,i){n.each(e,function(e){var n={get:function(){return this.properties[e]}};i||(n.set=function(t){return this.properties[e]=t,this}),Object.defineProperty(t,e,n)})},i.defineAllProperties=function(t,e){i.defineProperties(t.prototype,Object.keys(t.type.properties),e)},i.defineProperties(i.prototype,["id","type"]),e.exports=i},{underscore:151}],109:[function(t,e){"use strict";var n=t("substance-application").View,i=t("underscore"),r=0,o=function(t,e){this.__id__=r++,n.call(this),this.node=t,this.viewFactory=e,this.$el.addClass("content-node").addClass(t.type),this.$el.attr("id",this.node.id)};o.Prototype=function(){this.render=function(){return this.disposeChildViews(),this.el.innerHTML="",this.content=document.createElement("DIV"),this.content.classList.add("content"),this.el.appendChild(this.content),this},this.dispose=function(){this.stopListening()},this.disposeChildViews=function(){this.childViews&&i.each(this.childViews,function(t){t&&t.dispose()})},this.onGraphUpdate=function(t){return t.path[0]!==this.node.id||"update"!==t.type&&"set"!==t.type?!1:(this.onNodeUpdate(t),!0)},this.onNodeUpdate=function(){}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"substance-application":4,underscore:151}],110:[function(t,e){"use strict";e.exports={Model:t("./paragraph"),View:t("./paragraph_view")}},{"./paragraph":111,"./paragraph_view":112}],111:[function(t,e){"use strict";var n=t("underscore"),i=t("../node/node"),r=function(t,e){i.call(this,t,e)};r.type={id:"paragraph",parent:"content",properties:{children:["array","content"]}},r.description={name:"Paragraph",remarks:["A Paragraph can have inline elements such as images."],properties:{children:"An array of content node references"}},r.example={type:"paragraph",id:"paragraph_1","children ":["text_1","image_1","text_2"]},r.Prototype=function(){this.getChildren=function(){return n.map(this.properties.children,function(t){return this.document.get(t)},this)}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,r.prototype.defineProperties(),e.exports=r},{"../node/node":108,underscore:151}],112:[function(t,e){"use strict";var n=t("../node/node_view"),i=function(t,e){n.call(this,t,e)};i.Prototype=function(){this.render=function(){return n.prototype.render.call(this),this},this.onNodeUpdate=function(t){t.path[0]===this.node.id&&"children"===t.path[1]&&this.render()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../node/node_view":109}],113:[function(t,e){"use strict";e.exports={Model:t("./remark"),View:t("./remark_view")}},{"./remark":114,"./remark_view":115}],114:[function(t,e){"use strict";var n=t("../issue/issue"),i=function(t,e){n.call(this,t,e)};i.type={id:"remark",parent:"issue",properties:{}},i.description={name:"Remark",remarks:["References a range in a text-ish node and tags it as emphasized"],properties:{}},i.example={type:"remark",id:"remark_1",title:"Can you explain?",description:"I don't get the argument here."},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../issue/issue":95}],115:[function(t,e){"use strict";var n=t("../issue/issue_view"),i=function(t,e){n.call(this,t,e)};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../issue/issue_view":96}],116:[function(t,e){"use strict";e.exports={Model:t("./remark_reference")}},{"./remark_reference":117}],117:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"remark_reference",parent:"annotation",properties:{target:"remark"}},i.description={name:"RemarkReference",remarks:["References a range in a text-ish node and references a remark"],properties:{target:"Referenced remark id"}},i.example={type:"remark_reference_1",id:"remark_reference_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,i.prototype.defineProperties(),e.exports=i},{"../annotation/annotation":49}],118:[function(t,e){"use strict";e.exports={Model:t("./strong")}},{"./strong":119}],119:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"strong",parent:"annotation",properties:{}},i.description={name:"Strong",remarks:["References a range in a text-ish node and tags it as strong emphasized"],properties:{}},i.example={type:"strong",id:"strong_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":49}],120:[function(t,e){"use strict";e.exports={Model:t("./subscript")}},{"./subscript":121}],121:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"subscript",parent:"annotation",properties:{}},i.description={name:"Subscript",remarks:["References a range in a text-ish node and tags it as subscript"],properties:{}},i.example={type:"subscript",id:"subscript_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":49}],122:[function(t,e){"use strict";e.exports={Model:t("./superscript")}},{"./superscript":123}],123:[function(t,e){"use strict";var n=t("../annotation/annotation"),i=function(t,e){n.call(this,t,e)};i.type={id:"superscript",parent:"annotation",properties:{}},i.description={name:"Superscript",remarks:["References a range in a text-ish node and tags it as strong emphasized"],properties:{}},i.example={type:"strong",id:"superscript_1",path:["text_54","content"],range:[85,95]},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../annotation/annotation":49}],124:[function(t,e){"use strict";e.exports={Model:t("./table"),View:t("./table_view")}},{"./table":125,"./table_view":126}],125:[function(t,e){"use strict";var n=t("underscore"),i=t("../node/node"),r=function(t,e){i.call(this,t,e)};r.type={id:"table",parent:"content",properties:{label:"string",source_id:"string",headers:["array","content"],cells:["array","array","content"],caption:"content"}},r.description={name:"Table",remarks:[],properties:{items:"An array of references which contain the content of each cell"}},r.example={type:"table",id:"table_1",headers:["text_1","text_2"],cells:[["cell_1_1","cell_1_2"],["cell_2_1","cell_2_2"]]},r.Prototype=function(){this.getHeaders=function(){return n.map(this.properties.headers,function(t){return this.document.get(t)},this)},this.getCells=function(){for(var t=[],e=0;e<this.properties.cells.length;e++){for(var n=this.properties.cells[e],i=[],r=0;r<n.length;r++)i.push(this.document.get(n[r]));t.push(i)}return t},this.getCaption=function(){var t;return this.properties.caption&&(t=this.document.get(this.properties.caption)),t}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,r.prototype.defineProperties(),Object.defineProperties(r.prototype,{header:{get:function(){return this.properties.label},set:function(){throw new Error("This is a read-only alias property.")}}}),r.create=function(t){var e,n,i={},r=t.id,o={id:r,type:"table",label:t.label,headers:[],cells:[]};if(t.headers)for(var s=0;s<t.headers.length;s++){var a=t.headers[s];e="th_"+s+"_"+r,n={id:e,type:"text",content:a},i[e]=n,o.headers.push(e)}for(var c=0;c<t.cells.length;c++){for(var h=t.cells[c],u=[],l=0;l<h.length;l++){var p=h[l];e="td__"+c+"_"+l+"_"+r,n={id:e,type:"text",content:p},i[e]=n,u.push(e)}o.cells.push(u)}return t.caption&&(e="caption_"+r,n={id:e,type:"text",content:t.caption},i[e]=n,o.caption=e),i[o.id]=o,i},e.exports=r},{"../node/node":108,underscore:151}],126:[function(t,e){"use strict";var n=t("../node/node_view");t("underscore");var i=function(t,e){n.call(this,t,e)};i.Prototype=function(){this.render=function(){return n.prototype.render.call(this),this},this.onNodeUpdate=function(t){t.path[0]===this.node.id&&("headers"===t.path[1]||"cells"===t.path[1])&&this.render()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"../node/node_view":109,underscore:151}],127:[function(t,e){"use strict";e.exports={Model:t("./text_node"),View:t("./text_view")}},{"./text_node":128,"./text_view":129}],128:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-regexp"),r=t("substance-operator"),o=r.ObjectOperation,s=r.TextOperation,a=t("../node/node"),c=function(t,e){a.call(this,t,e)};c.type={id:"text",parent:"content",properties:{source_id:"string",content:"string"}},c.description={name:"Text",remarks:["A simple text fragement that can be annotated. Usually text nodes are combined in a paragraph."],properties:{source_id:"Text element source id",content:"Content"}},c.example={type:"paragraph",id:"paragraph_1",content:"Lorem ipsum dolor sit amet, adipiscing elit."},c.Prototype=function(){this.getChangePosition=function(t){if("content"===t.path[1]){var e=r.Helpers.last(t.diff);if(e.isInsert())return e.pos+e.length();if(e.isDelete())return e.pos}return-1},this.getLength=function(){return this.properties.content.length},this.insertOperation=function(t,e){return o.Update([this.properties.id,"content"],s.Insert(t,e))},this.deleteOperation=function(t,e){var n=this.properties.content;return o.Update([this.properties.id,"content"],s.Delete(t,n.substring(t,e)),"string")},this.prevWord=function(t){var e=this.properties.content,r=new i(/\b\w/g).match(e),o=n.select(r,function(e){return e.index<t},this);return 0===o.length?0:n.last(o).index},this.nextWord=function(t){var e=this.properties.content,n=new i(/\w\b/g).match(e.substring(t));if(0===n.length)return e.length;var r=n[0];return t+r.index+1},this.canJoin=function(t){return t instanceof c},this.join=function(t,e){var i=this.properties.content.length,r=e.content;t.update([this.id,"content"],[i,r]);var o=t.indexes.annotations.get(e.id);n.each(o,function(e){t.set([e.id,"path"],[this.properties.id,"content"]),t.set([e.id,"range"],[e.range[0]+i,e.range[1]+i])},this)},this.isBreakable=function(){return!0},this.break=function(t,e){var i=this.properties.content.substring(e),r=this.toJSON();r.type=this.splitInto?this.splitInto:this.properties.type,r.id=t.uuid(this.properties.type),r.content=i,t.create(r);var o=t.indexes.annotations.get(this.properties.id);return n.each(o,function(n){n.range[0]>=e&&(t.set([n.id,"path"],[r.id,"content"]),t.set([n.id,"range"],[n.range[0]-e,n.range[1]-e]))}),t.update([this.properties.id,"content"],s.Delete(e,i)),r}},c.Prototype.prototype=a.prototype,c.prototype=new c.Prototype,c.prototype.constructor=c,c.prototype.defineProperties(),e.exports=c},{"../node/node":108,"substance-operator":130,"substance-regexp":137,underscore:151}],129:[function(t,e){"use strict";function n(t){var e=t.getAnnotationBehavior();if(!e)throw new Error("Missing AnnotationBehavior.");return e}var i,r=t("../node/node_view"),o=t("substance-application").$$,s=t("substance-util").Fragmenter,a=t("substance-document").Annotator,c=function(t,e,i){r.call(this,t),i=i||{},this.property=i.property||"content",this.$el.addClass("content-node text"),"text"===t.type&&this.$el.addClass("text-node"),i.property&&(this.$el.removeAttr("id"),this.$el.removeClass("content-node"),this.$el.addClass(i.property)),this.$el.attr("data-path",this.property),this._annotations={},this.annotationBehavior=n(t.document),this._fragments=[]};c.Prototype=function(){this.render=function(t){return r.prototype.render.call(this,t),this.renderContent(),this},this.renderContent=function(){this.content.innerHTML="",this._annotations=this.node.document.getIndex("annotations").get([this.node.id,this.property]),this.renderWithAnnotations(this._annotations)},this.insert=function(t,e){var n=this._lookupPostion(t),i=n[0],r=i.el,o=n[1],s=r.textContent;s=s.substring(0,o)+e+s.substring(o),r.textContent=s;for(var a=i.index+1;a<this._fragments.length;a++)this._fragments[a].charPos+=e.length},this.delete=function(t,e){var n=this._lookupPostion(t,"delete"),i=n[0],r=i.el,o=n[1],s=r.textContent;if(o+e>=s.length)return this.renderContent(),void 0;s=s.substring(0,o)+s.substring(o+e),r.textContent=s;for(var a=i.index+1;a<this._fragments.length;a++)this._fragments[a].charPos-=e},this._lookupPostion=function(t,e){for(var n,i,r=0;r<this._fragments.length;r++){if(n=this._fragments[r],i=n.getLength(),i>t)return[n,t];if(!(t>i)){var o=this._fragments[r+1];return o&&(o.level<n.level||e)?[o,0]:[n,i]}t-=i}return[n,i]},this.onNodeUpdate=function(t){if(t.path[1]===this.property)if("update"===t.type){var e=t.diff;if(e.isInsert())return this.insert(e.pos,e.str),!0;if(e.isDelete())return this.delete(e.pos,e.str.length),!0}else if("set"===t.type)return this.renderContent(),!0;return!1},this.onGraphUpdate=function(t){return r.prototype.onGraphUpdate.call(this,t)?!0:!a.changesAnnotations(this.node.document,t,[this.node.id,this.property])||"create"!==t.type&&"delete"!==t.type?!1:(console.log("Rerendering TextView due to annotation update",t),this.renderContent(),!0)},this.createAnnotationElement=function(t){var e;return e="link"===t.type?o("a.annotation."+t.type,{id:t.id,href:this.node.document.get(t.id).url}):o("span.annotation."+t.type,{id:t.id})},this.renderWithAnnotations=function(t){var e=this,n=this.node[this.property],i=document.createDocumentFragment(),r=new s(this.annotationBehavior.levels);this._fragments=[];var o=null,a=0,h=0,u=0;r.onText=function(t,n){var i=document.createTextNode(n);e._fragments.push(new c.DefaultFragment(i,a++,h,u)),h+=n.length,t.appendChild(i)},r.onEnter=function(t,n){o=t,u++;var i=e.createAnnotationElement(t);return n.appendChild(i),i},r.onExit=function(){u--},r.start(i,n,t),this.content.innerHTML="",this.content.appendChild(i)},this.dispose=function(){this.stopListening()}},c.Prototype.prototype=r.prototype,c.prototype=new c.Prototype;var h=function(t,e){for(var n=0;n<e.length;n++)t.unshift(e[n])};i=function(t,e){var n=[];for(h(n,t.childNodes);n.length;){var i=n.shift();if(i.nodeType===Node.TEXT_NODE){var r=i.textContent;if(r.length>=e)return[i,e];e-=r.length}else h(n,i.childNodes)}},c.Fragment=function(t,e,n,i){this.el=t,this.index=e,this.charPos=n,this.level=i},c.Fragment.Prototype=function(){this.getLength=function(){throw new Error("This method is abstract")}},c.Fragment.prototype=new c.Fragment.Prototype,c.DefaultFragment=function(){c.Fragment.apply(this,arguments)},c.DefaultFragment.Prototype=function(){this.getLength=function(){return this.el.length}},c.DefaultFragment.Prototype.prototype=c.Fragment.prototype,c.DefaultFragment.prototype=new c.DefaultFragment.Prototype,e.exports=c},{"../node/node_view":109,"substance-application":4,"substance-document":35,"substance-util":144}],130:[function(t,e){"use strict";e.exports={Operation:t("./src/operation"),Compound:t("./src/compound"),ArrayOperation:t("./src/array_operation"),TextOperation:t("./src/text_operation"),ObjectOperation:t("./src/object_operation"),Helpers:t("./src/operation_helpers")}},{"./src/array_operation":131,"./src/compound":132,"./src/object_operation":133,"./src/operation":134,"./src/operation_helpers":135,"./src/text_operation":136}],131:[function(t,e){"use strict";function n(t,e,n){t.pos===e.pos?n?e.pos+=1:t.pos+=1:t.pos<e.pos?e.pos+=1:t.pos+=1}function i(t,e){return t.pos===e.pos?(e.type=p,t.type=p,void 0):(t.pos<e.pos?e.pos-=1:t.pos-=1,void 0)}function r(t,e){if(t.type===d){var n=t;t=e,e=n}t.pos<=e.pos?e.pos+=1:t.pos-=1}function o(t,e,n,i){if(t.type!==g)return o(e,t,n,!i);var r={type:d,pos:t.pos},s={type:f,pos:t.target},a={inplace:!0,check:n};e.type===d&&t.pos===e.pos?(t.type=p,e.pos=t.target):e.type===g&&t.pos===e.pos?i?(e.pos=t.target,t.type=p):(t.pos=e.target,e.type=p):(i?(C(r,e,a),C(s,e,a)):(C(e,r,a),C(e,s,a)),t.pos=r.pos,t.target=s.pos)}var s,a=t("underscore"),c=t("substance-util"),h=c.errors,u=t("./operation"),l=t("./compound"),p="NOP",d="delete",f="insert",g="move",v=function(t){if(void 0===t.type)throw new h.OperationError("Illegal argument: insufficient data.");if(this.type=t.type,this.type!==p){if(this.pos=t.pos,this.val=t.val,this.target=t.target,this.type!==p&&this.type!==f&&this.type!==d&&this.type!==g)throw new h.OperationError("Illegal type.");if(this.type===f||this.type===d){if(void 0===this.pos||void 0===this.val)throw new h.OperationError("Illegal argument: insufficient data.");if(!a.isNumber(this.pos)&&this.pos<0)throw new h.OperationError("Illegal argument: expecting positive number as pos.")}else if(this.type===g){if(void 0===this.pos||void 0===this.target)throw new h.OperationError("Illegal argument: insufficient data.");if(!a.isNumber(this.pos)&&this.pos<0)throw new h.OperationError("Illegal argument: expecting positive number as pos.");if(!a.isNumber(this.target)&&this.target<0)throw new h.OperationError("Illegal argument: expecting positive number as target.")}}};v.fromJSON=function(t){if(a.isArray(t))return t[0]===g?new s(t[1],t[2]):new v(t);if(t.type===g)return s.fromJSON(t);if(t.type===l.TYPE){for(var e=[],n=0;n<t.ops.length;n++)e.push(v.fromJSON(t.ops[n]));return v.Compound(e,t.data)}return new v(t)},v.Prototype=function(){this.clone=function(){return new v(this)},this.apply=function(t){if(this.type===p)return t;var e=t instanceof v.ArrayAdapter?t:new v.ArrayAdapter(t);if(this.type===f)e.insert(this.pos,this.val);else{if(this.type!==d)throw new h.OperationError("Illegal state.");e.delete(this.pos,this.val)}return t},this.invert=function(){var t=this.toJSON();if(this.type===f)t.type=d;else if(this.type===d)t.type=f;else{if(this.type!==p)throw new h.OperationError("Illegal state.");t.type=p}return new v(t)},this.hasConflict=function(t){return v.hasConflict(this,t)},this.toJSON=function(){var t={type:this.type};return this.type===p?t:(t.pos=this.pos,t.val=this.val,t)},this.isInsert=function(){return this.type===f},this.isDelete=function(){return this.type===d},this.isNOP=function(){return this.type===p},this.isMove=function(){return this.type===g}},v.Prototype.prototype=u.prototype,v.prototype=new v.Prototype;var y=0,m=1,w=2,b=4,_={};_[p]=y,_[d]=m,_[f]=w,_[g]=b;var x=[];x[m|m]=function(t,e){return t.pos===e.pos},x[m|w]=function(){return!1},x[w|w]=function(t,e){return t.pos===e.pos};var C,P=function(t,e){if(t.type===p||e.type===p)return!1;var n=_[t.type]|_[e.type];return x[n]?x[n](t,e):!1};C=function(t,e,s){if(s=s||{},s.check&&P(t,e))throw u.conflict(t,e);return s.inplace||(t=c.clone(t),e=c.clone(e)),t.type===p||e.type===p||(t.type===f&&e.type===f?n(t,e,!0):t.type===d&&e.type===d?i(t,e,!0):t.type===g||e.type===g?o(t,e,s.check,!0):r(t,e,!0)),[t,e]};var k=function(t,e){return a.isArray(t)?t=t[0]===g?new s(t[1],t[2]):new v(t):t instanceof v||(t=v.fromJSON(t)),t.apply(e)};v.transform=l.createTransform(C),v.hasConflict=P,v.perform=k,v.apply=k;var s=function(t,e){if(this.type=g,this.pos=t,this.target=e,!a.isNumber(this.pos)||!a.isNumber(this.target)||this.pos<0||this.target<0)throw new h.OperationError("Illegal argument")};s.Prototype=function(){this.clone=function(){return new s(this.pos,this.target)},this.apply=function(t){if(this.type===p)return t;var e=t instanceof v.ArrayAdapter?t:new v.ArrayAdapter(t),n=t[this.pos];return e.move(n,this.pos,this.target),t},this.invert=function(){return new s(this.target,this.pos)},this.toJSON=function(){return{type:g,pos:this.pos,target:this.target}}},s.Prototype.prototype=v.prototype,s.prototype=new s.Prototype,s.fromJSON=function(t){return new s(t.pos,t.target)};var E=function(t,e){var n,i,r=[0];for(n=0;n<t.length;n++)for(i=0;i<e.length;i++)r[i+1]=r[i+1]||0,r[i+1]=a.isEqual(t[n],e[i])?Math.max(r[i+1],r[i]+1):Math.max(r[i+1],r[i]);var o=[];for(i=e.length;i>=0;i--)r[i]>r[i-1]&&o.unshift(e[i-1]);return o};v.Insert=function(t,e){return new v({type:f,pos:t,val:e})},v.Delete=function(t,e){var n=t;return a.isArray(n)&&(n=n.indexOf(e)),0>n?new v({type:p}):new v({type:d,pos:n,val:e})},v.Move=function(t,e){return new s(t,e)},v.Push=function(t,e){var n=t.length;return v.Insert(n,e)},v.Pop=function(t){var e=t.length-1;return v.Delete(e,t[e])},v.Update=function(t,e){var n,i,r,o=E(t,e),s=o,a=t,c=e;for(n=0,i=0,r=0,o=[];i<a.length||r<c.length;)s[n]===a[i]&&a[i]===c[r]?(n++,i++,r++,o.push(1)):s[n]===a[i]?o.push(["+",c[r++]]):o.push(["-",a[i++]]);return v.Sequence(o)},v.Compound=function(t,e){return 1!==t.length||e?new l(t,e):t[0]},v.Clear=function(t){for(var e=[],n=0;n<t.length;n++)e.push(v.Delete(0,t[n]));return v.Compound(e)},v.Sequence=function(t){for(var e=0,n=[],i=0;i<t.length;i++){var r=t[i];if(a.isNumber(r)&&r>0)e+=r;else if("+"===r[0])n.push(v.Insert(e,r[1])),e+=1;else{if("-"!==r[0])throw new h.OperationError("Illegal operation.");n.push(v.Delete(e,r[1]))}}return new l(n)},v.create=function(t,e){var n,i,r=e[0];if(r===f||"+"===r)return i=e[1],n=e[2],v.Insert(i,n);if(r===d||"-"===r)return i=e[1],n=t[i],v.Delete(i,n);if(r===g||">>"===r){i=e[1];var o=e[2];return v.Move(i,o)}throw new h.OperationError("Illegal specification.")};var S=function(t){this.array=t};S.prototype={insert:function(t,e){if(this.array.length<t)throw new h.OperationError("Provided array is too small.");this.array.splice(t,0,e)},"delete":function(t,e){if(this.array.length<t)throw new h.OperationError("Provided array is too small.");if(this.array[t]!==e)throw new h.OperationError("Unexpected value at position "+t+". Expected "+e+", found "+this.array[t]);this.array.splice(t,1)},move:function(t,e,n){if(this.array.length<e)throw new h.OperationError("Provided array is too small.");if(this.array.splice(e,1),this.array.length<n)throw new h.OperationError("Provided array is too small.");this.array.splice(n,0,t)}},v.ArrayAdapter=S,v.NOP=p,v.DELETE=d,v.INSERT=f,v.MOVE=g,e.exports=v},{"./compound":132,"./operation":134,"substance-util":144,underscore:151}],132:[function(t,e){"use strict";t("underscore");var n=t("substance-util"),i=t("./operation"),r="compound",o=function(t,e){if(this.type=r,this.ops=t,this.alias=void 0,this.data=e,!t||0===t.length)throw new i.OperationError("No operations given.")};o.Prototype=function(){this.clone=function(){for(var t=[],e=0;e<this.ops.length;e++)t.push(n.clone(this.ops[e]));return new o(t,n.clone(this.data))},this.apply=function(t){for(var e=0;e<this.ops.length;e++)t=this.ops[e].apply(t);return t},this.invert=function(){for(var t=[],e=0;e<this.ops.length;e++)t.unshift(this.ops[e].invert());return new o(t,this.data)},this.toJSON=function(){var t={type:r,ops:this.ops};return this.alias&&(t.alias=this.alias),this.data&&(t.data=this.data),t}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.TYPE=r;var s=function(t,e,n,i,o){var a;if(e.type===r)for(a=0;a<e.ops.length;a++)s(t,e.ops[a],n,i,o);else for(a=0;a<t.ops.length;a++){var c,h;n?(c=t.ops[a],h=e):(c=e,h=t.ops[a]),o(c,h,{inplace:!0,check:i})}};o.createTransform=function(t){return function(e,i,o){return o=o||{},e.type===r||i.type===r?(o.inplace||(e=n.clone(e),i=n.clone(i)),e.type===r?s(e,i,!0,o.check,t):i.type===r&&s(i,e,!1,o.check,t),[e,i]):t(e,i,o)}},e.exports=o},{"./operation":134,"substance-util":144,underscore:151}],133:[function(t,e){"use strict";
function n(t){return t instanceof a?n(t.ops[0]):t instanceof c?"string":t instanceof h?"array":"other"}var i=t("underscore"),r=t("substance-util"),o=r.errors,s=t("./operation"),a=t("./compound"),c=t("./text_operation"),h=t("./array_operation"),u="NOP",l="create",p="delete",d="update",f="set",g=function(t){if(this.type=t.type,this.path=t.path,this.type===l||this.type===p)this.val=t.val;else if(this.type===d){if(void 0===t.diff)throw new o.OperationError("Illegal argument: update by value or by diff must be provided");this.diff=t.diff,this.propertyType=t.propertyType}else this.type===f&&(this.val=t.val,this.original=t.original)};g.fromJSON=function(t){if(t.type===a.TYPE){for(var e=[],n=0;n<t.ops.length;n++)e.push(g.fromJSON(t.ops[n]));return g.Compound(e,t.data)}var i=new g(t);if("update"===t.type)switch(t.propertyType){case"string":i.diff=c.fromJSON(i.diff);break;case"array":i.diff=h.fromJSON(i.diff);break;default:throw new Error("Don't know how to deserialize this operation:"+JSON.stringify(t))}return i},g.Prototype=function(){this.clone=function(){return new g(this)},this.isNOP=function(){return this.type===u?!0:this.type===d?this.diff.isNOP():void 0},this.apply=function(t){if(this.type===u)return t;var e=t instanceof g.Object?t:new g.Object(t);if(this.type===l)return e.create(this.path,r.clone(this.val)),t;var n=e.get(this.path);if(this.type===p){if(void 0===n)throw new o.OperationError("Property "+JSON.stringify(this.path)+" not found.");e.delete(this.path,n)}else if(this.type===d)if("object"===this.propertyType)n=g.apply(this.diff,n),e.inplace()||e.update(this.path,n,this.diff);else if("array"===this.propertyType)n=h.apply(this.diff,n),e.inplace()||e.update(this.path,n,this.diff);else{if("string"!==this.propertyType)throw new o.OperationError("Unsupported type for operational update.");n=c.apply(this.diff,n),e.update(this.path,n,this.diff)}else{if(this.type!==f)throw new o.OperationError("Illegal state.");e.set(this.path,r.clone(this.val))}return t},this.invert=function(){if(this.type===u)return{type:u};var t=new g(this);if(this.type===l)t.type=p;else if(this.type===p)t.type=l;else if(this.type===d){var e;"string"===this.propertyType?e=c.fromJSON(this.diff).invert():"array"===this.propertyType&&(e=h.fromJSON(this.diff).invert()),t.diff=e,t.propertyType=this.propertyType}else{if(this.type!==f)throw new o.OperationError("Illegal state.");t.val=this.original,t.original=this.val}return t},this.hasConflict=function(t){return g.hasConflict(this,t)},this.toJSON=function(){if(this.type===u)return{type:u};var t={type:this.type,path:this.path};return this.type===l||this.type===p?t.val=this.val:this.type===d?(t.diff=this.diff,t.propertyType=this.propertyType):this.type===f&&(t.val=this.val,t.original=this.original),t}},g.Prototype.prototype=s.prototype,g.prototype=new g.Prototype,g.Object=function(t){this.obj=t},g.Object.Prototype=function(){function t(t,e,n,i){for(var r=e,o=0;o<n.length-1;o++){if(void 0===r)throw new Error("Key error: could not find element for path "+JSON.stringify(t.path));void 0===r[n[o]]&&i&&(r[n[o]]={}),r=r[n[o]]}return{parent:r,key:n[o]}}this.get=function(e){var n=t(this,this.obj,e);return n.parent[n.key]},this.create=function(e,n){var i=t(this,this.obj,e,!0);if(void 0!==i.parent[i.key])throw new o.OperationError("Value already exists. path ="+JSON.stringify(e));i.parent[i.key]=n},this.update=function(t,e){this.set(t,e)},this.set=function(e,n){var i=t(this,this.obj,e);i.parent[i.key]=n},this.delete=function(e){var n=t(this,this.obj,e);delete n.parent[n.key]},this.inplace=function(){return!0}},g.Object.prototype=new g.Object.Prototype;var v=function(t,e){return t.type===u||e.type===u?!1:i.isEqual(t.path,e.path)},y=function(t,e){t.type=u,e.type=u},m=function(){throw new o.OperationError("Can not transform two concurring creates of the same property")},w=function(t,e,n){return t.type!==p?w(e,t,!0):(n?(t.val=e.val,e.type=u):t.type=u,void 0)},b=function(t,e,n){if(t.type!==p)return b(e,t,!0);var i;"string"===e.propertyType?i=c.fromJSON(e.diff):"array"===e.propertyType&&(i=h.fromJSON(e.diff)),n?(t.val=i.apply(t.val),e.type=u):(t.type=u,e.type=l,e.val=i.apply(t.val))},_=function(){throw new o.OperationError("Can not transform a concurring create and update of the same property")},x=function(t,e){var n,i,r;"string"===e.propertyType?(n=c.fromJSON(t.diff),i=c.fromJSON(e.diff),r=c.transform(n,i,{inplace:!0})):"array"===e.propertyType?(n=h.fromJSON(t.diff),i=h.fromJSON(e.diff),r=h.transform(n,i,{inplace:!0})):"object"===e.propertyType&&(n=g.fromJSON(t.diff),i=g.fromJSON(e.diff),r=g.transform(n,i,{inplace:!0})),t.diff=r[0],e.diff=r[1]},C=function(t,e,n){return t.type!==l?C(e,t,!0):(n?(t.type=f,t.original=e.val,e.type=u):(t.type=u,e.original=t.val),void 0)},P=function(t,e,n){return t.type!==p?P(e,t,!0):(n?(t.val=e.val,e.type=u):(t.type=u,e.type=l,e.original=void 0),void 0)},k=function(){throw new o.OperationError("Can not transform update/set of the same property.")},E=function(t,e){t.type=u,e.original=t.val},S=0,N=1,O=2,T=4,A=8,I={};I[u]=S,I[l]=N,I[p]=O,I[d]=T,I[f]=A;var V=[];V[O|O]=y,V[O|N]=w,V[O|T]=b,V[N|N]=m,V[N|T]=_,V[T|T]=x,V[N|A]=C,V[O|A]=P,V[T|A]=k,V[A|A]=E;var $=function(t,e,n){n=n||{};var i=v(t,e);if(n.check&&i)throw s.conflict(t,e);return n.inplace||(t=r.clone(t),e=r.clone(e)),i?(V[I[t.type]|I[e.type]](t,e),[t,e]):[t,e]};g.transform=a.createTransform($),g.hasConflict=v;var D=function(t,e){return t instanceof g||(t=g.fromJSON(t)),t.apply(e)};g.apply=D,g.Create=function(t,e){return new g({type:l,path:t,val:e})},g.Delete=function(t,e){return new g({type:p,path:t,val:e})},g.Update=function(t,e,i){return i=i||n(e),new g({type:d,path:t,diff:e,propertyType:i})},g.Set=function(t,e,n){return new g({type:f,path:t,val:r.clone(n),original:r.clone(e)})},g.Compound=function(t,e){return 0===t.length?null:new a(t,e)};var R=function(t,e,n,r,s,a){for(var c=Object.getOwnPropertyNames(e),h=0;h<c.length;h++){var u=c[h],l=n.concat(u);if(void 0===e[u]&&void 0!==t[u])r.push(g.Delete(l,t[u]));else if(i.isObject(e[u])){if(!i.isObject(t[u]))throw new o.OperationError("Incompatible arguments: newVals must have same structure as obj.");R(t[u],e[u],l,r,s,a)}else if(void 0===t[u])s.push(g.Create(l,e[u]));else{var p=t[u],d=e[u];i.isEqual(p,d)||a.push(g.Set(l,p,d))}}};g.Extend=function(t,e){var n=[],i=[],r=[];return R(t,e,[],n,i,r),g.Compound(n.concat(i).concat(r))},g.NOP=u,g.CREATE=l,g.DELETE=p,g.UPDATE=d,g.SET=f,e.exports=g},{"./array_operation":131,"./compound":132,"./operation":134,"./text_operation":136,"substance-util":144,underscore:151}],134:[function(t,e){"use strict";var n=t("substance-util"),i=n.errors,r=i.define("OperationError",-1),o=i.define("Conflict",-1),s=function(){};s.Prototype=function(){this.clone=function(){throw new Error("Not implemented.")},this.apply=function(){throw new Error("Not implemented.")},this.invert=function(){throw new Error("Not implemented.")},this.hasConflict=function(){throw new Error("Not implemented.")}},s.prototype=new s.Prototype,s.conflict=function(t,e){var n=new i.Conflict("Conflict: "+JSON.stringify(t)+" vs "+JSON.stringify(e));return n.a=t,n.b=e,n},s.OperationError=r,s.Conflict=o,e.exports=s},{"substance-util":144}],135:[function(t,e){"use strict";var n=t("./text_operation"),i=t("./array_operation"),r={};r.last=function(t){return"compound"===t.type?t.ops[t.ops.length-1]:t},r.each=function(t,e,n,i){if("compound"===t.type){for(var o=t.ops.length,s=0;o>s;s++){var a=t.ops[s];if(i&&(a=t.ops[o-s-1]),"compound"===a.type){if(r.each(a,e,n,i)===!1)return!1}else if(e.call(n,a)===!1)return!1}return!0}return e.call(n,t)},r.invert=function(t,e){switch(e){case"string":return n.fromJSON(t).invert();case"array":return i.fromJSON(t).invert();default:throw new Error("Don't know how to invert this operation.")}},e.exports=r},{"./array_operation":131,"./text_operation":136}],136:[function(t,e){"use strict";function n(t,e,n){t.pos===e.pos?n?e.pos+=t.str.length:t.pos+=e.str.length:t.pos<e.pos?e.pos+=t.str.length:t.pos+=e.str.length}function i(t,e,n){if(t.pos>e.pos)return i(e,t,!n);if(t.pos===e.pos&&t.str.length>e.str.length)return i(e,t,!n);if(e.pos<t.pos+t.str.length){var r=e.pos-t.pos,o=t.str.length-r,s=r+e.str.length;t.str=t.str.slice(0,r)+t.str.slice(s),e.str=e.str.slice(o),e.pos-=r}else e.pos-=t.str.length}function r(t,e){if(t.type===l)return r(e,t);if(t.pos<=e.pos)e.pos+=t.str.length;else if(t.pos>=e.pos+e.str.length)t.pos-=e.str.length;else{var n=t.pos-e.pos;e.str=e.str.slice(0,n)+t.str+e.str.slice(n),t.str=""}}var o=t("underscore"),s=t("substance-util"),a=s.errors,c=t("./operation"),h=t("./compound"),u="+",l="-",p=function(t){if(o.isArray(t)&&(t={type:t[0],pos:t[1],str:t[2]}),void 0===t.type||void 0===t.pos||void 0===t.str)throw new a.OperationError("Illegal argument: insufficient data.");if(this.type=t.type,this.pos=t.pos,this.str=t.str,!this.isInsert()&&!this.isDelete())throw new a.OperationError("Illegal type.");if(!o.isString(this.str))throw new a.OperationError("Illegal argument: expecting string.");if(!o.isNumber(this.pos)&&this.pos<0)throw new a.OperationError("Illegal argument: expecting positive number as pos.")};p.fromJSON=function(t){if(t.type===h.TYPE){for(var e=[],n=0;n<t.ops.length;n++)e.push(p.fromJSON(t.ops[n]));return p.Compound(e,t.data)}return new p(t)},p.Prototype=function(){this.clone=function(){return new p(this)},this.isNOP=function(){return"NOP"===this.type||0===this.str.length},this.isInsert=function(){return this.type===u},this.isDelete=function(){return this.type===l},this.length=function(){return this.str.length},this.apply=function(t){if(this.isEmpty())return t;var e=t instanceof p.StringAdapter?t:new p.StringAdapter(t);if(this.type===u)e.insert(this.pos,this.str);else{if(this.type!==l)throw new a.OperationError("Illegal operation type: "+this.type);e.delete(this.pos,this.str.length)}return e.get()},this.invert=function(){var t={type:this.isInsert()?"-":"+",pos:this.pos,str:this.str};return new p(t)},this.hasConflict=function(t){return p.hasConflict(this,t)},this.isEmpty=function(){return 0===this.str.length},this.toJSON=function(){return{type:this.type,pos:this.pos,str:this.str}}},p.Prototype.prototype=c.prototype,p.prototype=new p.Prototype;var d=function(t,e){if(t.type===u&&e.type===u)return t.pos===e.pos;if(t.type===l&&e.type===l)return!(t.pos>=e.pos+e.str.length||e.pos>=t.pos+t.str.length);var n,i;return t.type===l?(n=t,i=e):(n=e,i=t),i.pos>=n.pos&&i.pos<n.pos+n.str.length},f=function(t,e,o){if(o=o||{},o.check&&d(t,e))throw c.conflict(t,e);return o.inplace||(t=s.clone(t),e=s.clone(e)),t.type===u&&e.type===u?n(t,e,!0):t.type===l&&e.type===l?i(t,e,!0):r(t,e),[t,e]},g=function(t,e){return o.isArray(t)?t=new p(t):t instanceof p||(t=p.fromJSON(t)),t.apply(e)};p.transform=h.createTransform(f),p.apply=g;var v=function(t){this.str=t};v.prototype={insert:function(t,e){if(this.str.length<t)throw new a.OperationError("Provided string is too short.");this.str=this.str.slice(0,t)+e+this.str.slice(t)},"delete":function(t,e){if(this.str.length<t+e)throw new a.OperationError("Provided string is too short.");this.str=this.str.slice(0,t)+this.str.slice(t+e)},get:function(){return this.str}},p.Insert=function(t,e){return new p(["+",t,e])},p.Delete=function(t,e){return new p(["-",t,e])},p.Compound=function(t,e){return 1!==t.length||e?new h(t,e):t[0]},p.fromOT=function(t,e){var n=[],i=0,r=0;return o.isArray(e)||(e=o.toArray(arguments).slice(1)),o.each(e,function(e){if(o.isString(e))n.push(p.Insert(r,e)),r+=e.length;else if(0>e){var s=-e;n.push(p.Delete(r,t.slice(i,i+s))),i+=s}else i+=e,r+=e}),0===n.length?null:p.Compound(n)},p.fromSequence=p.fromOT;var y=function(t){o.isArray(t)?(this.start=t[0],this.length=t[1]):(this.start=t.start,this.length=t.length)},m=function(t,e,n,i){var r=!1;{if(e.type!==h.TYPE){var s,a;if(o.isArray(t)?(s=t[0],a=t[1]):(s=t.start,a=s+t.length),e.type===l){var c=e.pos,p=e.pos+e.str.length;s>=c&&(s-=Math.min(p-c,s-c),r=!0),a>=c&&(a-=Math.min(p-c,a-c),r=!0)}else if(e.type===u){var d=e.pos,f=e.str.length;(s>d||d===s&&!n)&&(s+=f,r=!0),(a>d||d===a&&i)&&(a+=f,r=!0)}return r&&(o.isArray(t)?(t[0]=s,t[1]=a):(t.start=s,t.length=a-s)),r}for(var g=0;g<e.ops.length;g++){var v=e.ops[g];m(t,v)}}};y.Prototype=function(){this.clone=function(){return new y(this)},this.toJSON=function(){var t={start:this.start,length:this.length};return t},this.transform=function(t,e){return m(this.range,t,e)}},y.prototype=new y.Prototype,y.transform=function(t,e,n,i){return m(t,e,n,i)},y.fromJSON=function(t){return new y(t)},p.StringAdapter=v,p.Range=y,p.INSERT=u,p.DELETE=l,e.exports=p},{"./compound":132,"./operation":134,"substance-util":144,underscore:151}],137:[function(t,e){"use strict";e.exports=t("./src/regexp")},{"./src/regexp":138}],138:[function(t,e){"use strict";var n=function(t){this.index=t.index,this.match=[];for(var e=0;e<t.length;e++)this.match.push(t[e])};n.Prototype=function(){this.captures=function(){return this.match.slice(1)},this.toString=function(){return this.match[0]}},n.prototype=new n.Prototype;var i=function(t){this.exp=t};i.Prototype=function(){this.match=function(t){if(void 0===t)throw new Error("No string given");if(this.exp.global){var e,i=[];for(this.exp.compile(this.exp);null!==(e=this.exp.exec(t));)i.push(new n(e));return i}return this.exp.exec(t)}},i.prototype=new i.Prototype,i.Match=n,e.exports=i},{}],139:[function(t,e){"use strict";var n=t("./src/surface");n.SurfaceController=t("./src/surface_controller"),e.exports=n},{"./src/surface":140,"./src/surface_controller":141}],140:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-application").View,r=t("substance-util"),o=r.errors.define("SurfaceError",500),s=r.errors.define("SelectionError",501,o),a=function(t,e){i.call(this),this.docCtrl=t,this.renderer=e,this.document=t.session.document,this.nodeTypes=this.document.nodeTypes,this.nodeViews=this.renderer.nodeViews,this.$el.addClass("surface"),this.listenTo(this.document,"property:updated",this.onUpdateView),this.listenTo(this.document,"graph:reset",this.reset)};a.Prototype=function(){function t(t,e,n){var i=t.childNodes;if(e<i.length){var r=i[e];t.insertBefore(n,r)}else t.appendChild(n)}var e=function(t){for(var e=[],n=t;n;){if(n.getAttribute){if("false"===n.getAttribute("contenteditable"))return null;var i=n.getAttribute("data-path");i&&e.unshift(i)}if($(n).is(".content-node")){var r=n.getAttribute("id");if(!r)throw new Error("Every element with class 'content-node' must have an 'id' attribute.");return e.unshift(r),e}n=n.parentElement}return null},i=function(t,n){var i,r,o=this.docCtrl.container,s=e(t);if(!s)return null;var a=o.lookup(s);if(!a)return null;if(a.surface.hasView()||this._attachViewToNodeSurface(a),!a.surface.hasView())throw new Error("NodeView.attachView() must propagate down to child views.");return i=a.pos,r=a.surface.getCharPosition(t,n),[i,r]};this.updateSelection=function(){try{var t=window.getSelection();if(null===t.anchorNode)return this.docCtrl.selection.clear(),void 0;if($(t.anchorNode.parentElement).is(".cursor"))return this.docCtrl.selection.collapse("cursor"),void 0;var e,n,r=t.getRangeAt(0);if(e=[r.startContainer,r.startOffset],n=[r.endContainer,r.endOffset],r.endContainer===t.anchorNode&&r.endOffset===t.anchorOffset){var o=e;e=n,n=o}var a=i.call(this,e[0],e[1]);if(!a)return t.removeAllRanges(),this.docCtrl.selection.clear(),void 0;var c;if(r.collapsed)c=a;else if(c=i.call(this,n[0],n[1]),!c)return t.removeAllRanges(),this.docCtrl.selection.clear(),void 0;this.docCtrl.selection.set({start:a,end:c})}catch(h){h=new s("Could not map to model cordinates.",h),this.docCtrl.selection.clear(),this.docCtrl.trigger("error",h)}};var r=function(t){var e=this.docCtrl.container,n=e.getComponent(t[0]);n.surface.hasView()||this._attachViewToNodeSurface(n);var i=n.surface.getDOMPosition(t[1]);return i};this._attachViewToNodeSurface=function(t){var e=t.path[0],n=t.surface.surfaceProvider.getNodeSurface(e),i=this.nodeViews[e];n.attachView(i)},this.renderSelection=function(){try{var t=this.docCtrl.selection;if(t.isNull())return;var e=document.createRange(),n=r.call(this,t.start);e.setStart(n.startContainer,n.startOffset);var i=window.getSelection();if(i.removeAllRanges(),i.addRange(e),!t.isCollapsed()){var o=r.call(this,[t.cursor.pos,t.cursor.charPos]);i.extend(o.endContainer,o.endOffset)}}catch(a){a=new s("Could not map to DOM cordinates.",a),this.docCtrl.selection.clear(),this.docCtrl.trigger("error",a)}},this.render=function(){var t=document.createElement("input");t.className="image-files",t.setAttribute("type","file"),t.setAttribute("name","files[]");var e=document.createElement("div");e.className="controls";var n=document.createElement("div");n.className="nodes";var i=document.createElement("div");return i.className="cursor",this.el.appendChild(t),this.el.appendChild(e),this.el.appendChild(n),this.el.appendChild(i),n.appendChild(this.renderer.render()),this.$("input.image-files").hide(),this.$cursor=this.$(".cursor"),this.$cursor.hide(),this._nodesEl=n,this},this.reset=function(){n.each(this.nodeViews,function(t){t.dispose()}),this.render()},this.dispose=function(){this.stopListening(),n.each(this.nodeViews,function(t){t.dispose()},this),this.keyboard&&this.keyboard.disconnect(this.el)},this.getContainer=function(){return this.docCtrl.container},this.onUpdateView=function(e,n){if(2===e.length&&e[0]===this.docCtrl.session.container.name&&"nodes"===e[1]){var i,r,o,s,a=this._nodesEl;if(n.isInsert()){if(i=n.val,r=this.document.get(i),this.nodeTypes[r.type]){var c=this.renderer.createView(r);this.nodeViews[i]=c,s=c.render().el,t(a,n.pos,s)}}else if(n.isDelete())i=n.val,this.nodeViews[i]&&this.nodeViews[i].dispose(),delete this.nodeViews[i],o=a.children,a.removeChild(o[n.pos]);else if(n.isMove())o=a.children,s=o[n.pos],a.removeChild(s),t(a,n.target,s);else if("NOP"!==n.type)throw new Error("Illegal state.")}}},n.extend(a.Prototype,r.Events.Listener),a.Prototype.prototype=i.prototype,a.prototype=new a.Prototype,e.exports=a},{"substance-application":4,"substance-util":144,underscore:151}],141:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=function(t){this.session=t};r.Prototype=function(){n.extend(this,i.Events),this.isEditor=function(){return!1}},r.prototype=new r.Prototype,Object.defineProperties(r.prototype,{selection:{get:function(){return this.session.selection},set:function(){throw new Error("Immutable.")}},annotator:{get:function(){return this.session.annotator},set:function(){throw new Error("Immutable.")}},container:{get:function(){return this.session.container},set:function(){throw new Error("Immutable.")}},document:{get:function(){return this.session.document},set:function(){throw new Error("Immutable.")}},view:{get:function(){return console.error("TODO: rename this property."),this.session.container.name},set:function(){throw new Error("Immutable.")}}}),e.exports=r},{"substance-util":144,underscore:151}],142:[function(t,e){"use strict";var n=t("./toc_view");e.exports=n},{"./toc_view":143}],143:[function(t,e){"use strict";var n=t("substance-application").View,i=t("substance-application").$$,r=t("substance-data");r.Graph.Index;var o=t("underscore"),s=function(t){n.call(this),this.docCtrl=t,this.$el.addClass("toc")};s.Prototype=function(){this.render=function(){return this.el.innerHTML="",this.headings=o.filter(this.docCtrl.container.getNodes(),function(t){return"heading"===t.type}),this.headings.length<=2&&!this.SHOW_ALWAYS?this:(o.each(this.headings,function(t){this.el.appendChild(i("a.heading-ref.level-"+t.level,{id:"toc_"+t.id,text:t.content,"sbs-click":"jumpToNode("+t.id+")"}))},this),this)},this.setActiveNode=function(t){this.$(".heading-ref.active").removeClass("active"),this.$("#toc_"+t).addClass("active")}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":4,"substance-data":28,underscore:151}],144:[function(t,e){"use strict";var n=t("./src/util");n.async=t("./src/async"),n.errors=t("./src/errors"),n.html=t("./src/html"),n.dom=t("./src/dom"),n.Fragmenter=t("./src/fragmenter"),e.exports=n},{"./src/async":145,"./src/dom":146,"./src/errors":147,"./src/fragmenter":148,"./src/html":149,"./src/util":150}],145:[function(t,e){"use strict";function n(t,e){function n(t){var e=a[c];if(!e)return u.length>0?i(new Error("Multiple errors occurred.",t)):i(null,t);var s=r.once(function(t,e){if(t){if(h)return i(t,null);u.push(t)}c+=1,n(e)});try{0===e.length?(e(),s(null,t)):1===e.length?e(s):e(t,s)}catch(l){console.log("util.async caught error:",l),o.printStackTrace(l),i(l)}}var i=t["finally"]||function(t,n){e(t,n)};i=r.once(i);var s=t.data||{},a=t.functions;if(!r.isFunction(e))return e("Illegal arguments: a callback function must be provided");var c=0,h=void 0===t.stopOnError?!0:t.stopOnError,u=[];n(s)}function i(t){return function(e,i){function o(t,e){return function(n,i){2===l.length?l(t,i):3===l.length?l(t,e,i):l(t,e,n,i)}}function s(t,e){return function(n,i){2===l.length?l(t,i):3===l.length?l(t,e,i):l(t,e,n,i)}}var a=t.selector?t.selector(e):t.items,c=t["finally"]||function(t,e){i(t,e)};if(c=r.once(c),!a)return c(null,e);var h=r.isArray(a);t.before&&t.before(e);var u=[],l=t.iterator;if(h)for(var p=0;p<a.length;p++)u.push(o(a[p],p));else for(var d in a)u.push(s(a[d],d));var f={functions:u,data:e,"finally":c,stopOnError:t.stopOnError};n(f,i)}}var r=t("underscore"),o=t("./util.js"),s={};s.sequential=function(t,e){r.isArray(t)&&(t={functions:t}),n(t,e)},s.iterator=function(t,e){var n;return n=1==arguments.length?t:{items:t,iterator:e},i(n)},s.each=function(t,e){var n=i(t);n(null,e)},e.exports=s},{"./util.js":150,underscore:151}],146:[function(t,e){"use strict";var n=t("underscore"),i={};i.ChildNodeIterator=function(t){this.nodes=n.isArray(t)?t:t.childNodes,this.length=this.nodes.length,this.pos=-1},i.ChildNodeIterator.prototype={hasNext:function(){return this.pos<this.length-1},next:function(){return this.pos+=1,this.nodes[this.pos]},back:function(){return this.pos>=0&&(this.pos-=1),this}},i.getChildren=function(t){if(void 0!==t.children)return t.children;for(var e=[],n=t.firstElementChild;n;)e.push(n),n=n.nextElementSibling;return e},i.getNodeType=function(t){if(t.nodeType===Node.TEXT_NODE)return"text";if(t.nodeType===Node.COMMENT_NODE)return"comment";if(t.tagName)return t.tagName.toLowerCase();throw new Error("Unknown node type")},e.exports=i},{underscore:151}],147:[function(t,e){"use strict";var n=t("./util"),i={},r=function(t,e){e?(Error.call(this,t,e.fileName,e.lineNumber),this.__stack=e instanceof r?e.__stack:e.stack?n.parseStackTrace(e):n.callstack(1)):(Error.call(this,t),this.__stack=n.callstack(1)),this.message=t};r.Prototype=function(){this.name="SubstanceError",this.code=-1,this.toString=function(){return this.name+":"+this.message},this.toJSON=function(){return{name:this.name,message:this.message,code:this.code,stack:this.stack}},this.printStackTrace=function(){n.printStackTrace(this)}},r.Prototype.prototype=Error.prototype,r.prototype=new r.Prototype,Object.defineProperty(r.prototype,"stack",{get:function(){for(var t=[],e=0;e<this.__stack.length;e++){var n=this.__stack[e];t.push(n.file+":"+n.line+":"+n.col+" ("+n.func+")")}return t.join("\n")},set:function(){throw new Error("SubstanceError.stack is read-only.")}}),i.SubstanceError=r;var o=function(t,e,n){return function(i){t.call(this,i),this.name=e,this.code=n}};i.define=function(t,e,n){if(!t)throw new r("Name is required.");void 0===e&&(e=-1),n=n||r;var s=o(n,t,e),a=function(){};return a.prototype=n.prototype,s.prototype=new a,s.prototype.constructor=s,i[t]=s,s},e.exports=i},{"./util":150}],148:[function(t,e){"use strict";var n=t("underscore"),i=1,r=-1,o=function(t){if(!t)throw new Error("Requires a specification of element levels.");this.levels=t};o.Prototype=function(){var t=function(t,e){if(t.pos<e.pos)return-1;if(t.pos>e.pos)return 1;if(t.mode<e.mode)return-1;if(t.mode>e.mode)return 1;if(t.mode===i){if(t.level<e.level)return-1;if(t.level>e.level)return 1}if(t.mode===r){if(t.level>e.level)return-1;if(t.level<e.level)return 1}return 0},e=function(t){var e=[];return n.each(t,function(t){var n=this.levels[t.type];void 0!==n&&(e.push({pos:t.range[0],mode:i,level:n,id:t.id,type:t.type}),e.push({pos:t.range[1],mode:r,level:n,id:t.id,type:t.type}))},this),e};this.onText=function(){},this.onEnter=function(){return null},this.onExit=function(){},this.enter=function(t,e){return this.onEnter(t,e)},this.exit=function(t,e){this.onExit(t,e)},this.createText=function(t,e){this.onText(t,e)},this.start=function(n,o,s){var a=e.call(this,s);a.sort(t.bind(this));for(var c=[{context:n,entry:null}],h=0,u=0;u<a.length;u++){var l=a[u];this.createText(c[c.length-1].context,o.substring(h,l.pos)),h=l.pos;var p,d=1;if(l.mode===i){for(;d<c.length&&!(l.level<c[d].entry.level);d++);c.splice(d,0,{entry:l})}else if(l.mode===r){for(;d<c.length&&c[d].entry.id!==l.id;d++);for(p=d;p<c.length;p++)this.exit(c[p].entry,c[p-1].context);c.splice(d,1)}for(p=d;p<c.length;p++)c[p].context=this.enter(c[p].entry,c[p-1].context)}this.createText(n,o.substring(h))}},o.prototype=new o.Prototype,e.exports=o},{underscore:151}],149:[function(t,e){"use strict";var n={},i=t("underscore");n.templates={},n.renderTemplate=function(t,e){return n.templates[t](e)},"undefined"!=typeof window&&(window.console||(window.console={log:function(){}})),n.tpl=function(t,e){e=e||{};var n=$("script[name="+t+"]").html();return i.template(n,e)},e.exports=n},{underscore:151}],150:[function(t,e,n){"use strict";var i=t("underscore"),r={};r.uuid=function(t,e){var n,i="0123456789abcdefghijklmnopqrstuvwxyz".split(""),r=[],o=16;if(e=e||32)for(n=0;e>n;n++)r[n]=i[0|Math.random()*o];else{var s;for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",n=0;36>n;n++)r[n]||(s=0|16*Math.random(),r[n]=i[19==n?8|3&s:s])}return(t?t:"")+r.join("")},r.uuidGen=function(t){var e=1;return t=void 0!==t?t:"uuid_",function(n){return n=n||t,n+e++}};var o=function(t,e){var n,i=-1,r=t.length,o=e[0],s=e[1],a=e[2];switch(e.length){case 0:for(;++i<r;)(n=t[i]).callback.call(n.ctx);return;case 1:for(;++i<r;)(n=t[i]).callback.call(n.ctx,o);return;case 2:for(;++i<r;)(n=t[i]).callback.call(n.ctx,o,s);return;case 3:for(;++i<r;)(n=t[i]).callback.call(n.ctx,o,s,a);return;default:for(;++i<r;)(n=t[i]).callback.apply(n.ctx,e)}},s=/\s+/,a=function(t,e,n,i){if(!n)return!0;if("object"==typeof n){for(var r in n)t[e].apply(t,[r,n[r]].concat(i));return!1}if(s.test(n)){for(var o=n.split(s),a=0,c=o.length;c>a;a++)t[e].apply(t,[o[a]].concat(i));return!1}return!0};r.Events={on:function(t,e,n){if(!a(this,"on",t,[e,n])||!e)return this;this._events=this._events||{};var i=this._events[t]||(this._events[t]=[]);return i.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,n){if(!a(this,"once",t,[e,n])||!e)return this;var r=this,o=i.once(function(){r.off(t,o),e.apply(this,arguments)});return o._callback=e,this.on(t,o,n)},off:function(t,e,n){var r,o,s,c,h,u,l,p;if(!this._events||!a(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events={},this;for(c=t?[t]:i.keys(this._events),h=0,u=c.length;u>h;h++)if(t=c[h],s=this._events[t]){if(this._events[t]=r=[],e||n)for(l=0,p=s.length;p>l;l++)o=s[l],(e&&e!==o.callback&&e!==o.callback._callback||n&&n!==o.context)&&r.push(o);r.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=Array.prototype.slice.call(arguments,1);if(!a(this,"trigger",t,e))return this;var n=this._events[t],i=this._events.all;return n&&o(n,e),i&&o(i,arguments),this},triggerLater:function(){var t=this,e=arguments;setTimeout(function(){t.trigger.apply(t,e)},0)},stopListening:function(t,e,n){var i=this._listeners;if(!i)return this;var r=!e&&!n;"object"==typeof e&&(n=this),t&&((i={})[t._listenerId]=t);for(var o in i)i[o].off(e,n,this),r&&delete this._listeners[o];return this}};var c={listenTo:"on",listenToOnce:"once"};i.each(c,function(t,e){r.Events[e]=function(e,n,r){var o=this._listeners||(this._listeners={}),s=e._listenerId||(e._listenerId=i.uniqueId("l"));return o[s]=e,"object"==typeof n&&(r=this),e[t](n,r,this),this}}),r.Events.bind=r.Events.on,r.Events.unbind=r.Events.off,r.Events.Listener={listenTo:function(t,e,n){if(!i.isFunction(n))throw new Error("Illegal argument: expecting function as callback, was: "+n);return this._handlers=this._handlers||[],t.on(e,n,this),this._handlers.push({unbind:function(){t.off(e,n)}}),this},stopListening:function(){if(this._handlers)for(var t=0;t<this._handlers.length;t++)this._handlers[t].unbind()}},r.propagate=function(t,e){if(!i.isFunction(e))throw"Illegal argument: provided callback is not a function";return function(n){return n?e(n):(e(null,t),void 0)}};var h=function(){};r.inherits=function(t,e,n){var r;return r=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)},i.extend(r,t),h.prototype=t.prototype,r.prototype=new h,e&&i.extend(r.prototype,e),n&&i.extend(r,n),r.prototype.constructor=r,r.__super__=t.prototype,r},r.getJSON=function(e,i){if("undefined"!=typeof n){var r=t("fs"),o=JSON.parse(r.readFileSync(e,"utf8"));i(null,o)}else $.getJSON(e).done(function(t){i(null,t)}).error(function(t){i(t,null)})},r.prototype=function(t){return Object.getPrototypeOf?Object.getPrototypeOf(t):t.__proto__},r.inherit=function(t,e){var n,r=i.isFunction(t)?new t:t;if(i.isFunction(e))e.prototype=r,n=new e;else{var o=function(){};o.prototype=r,n=i.extend(new o,e)}return n},r.pimpl=function(t){var e=function(t){this.self=t};return e.prototype=t,function(t){return t=t||this,new e(t)}},r.parseStackTrace=function(t){var e,n=/([^@]*)@(.*):(\d+)/,i=/\s*at ([^(]*)[(](.*):(\d+):(\d+)[)]/,r=t.stack.split("\n"),o=[];for(e=0;e<r.length;e++){var s=n.exec(r[e]);if(s||(s=i.exec(r[e])),s){var a={func:s[1],file:s[2],line:s[3],col:s[4]||0};""===a.func&&(a.func="<anonymous>"),o.push(a)}}return o},r.callstack=function(t){var e;try{throw new Error}catch(n){e=n}var i=r.parseStackTrace(e);return t=t||0,i.splice(t+1)},r.stacktrace=function(t){var e=0===arguments.length?r.callstack().splice(1):r.parseStackTrace(t),n=[];return i.each(e,function(t){n.push(t.file+":"+t.line+":"+t.col+" ("+t.func+")")}),n.join("\n")},r.printStackTrace=function(t,e){if(t.stack){var n;if(void 0!==t.__stack)n=t.__stack;else{if(!i.isString(t.stack))return;n=r.parseStackTrace(t)}e=e||n.length,e=Math.min(e,n.length);for(var o=0;e>o;o++){var s=n[o];console.log(s.file+":"+s.line+":"+s.col,"("+s.func+")")}}},r.diff=function(t,e){var n;return i.isArray(t)&&i.isArray(e)?(n=i.difference(e,t),0===n.length?null:n):i.isObject(t)&&i.isObject(e)?(n={},i.each(Object.keys(e),function(i){var o=r.diff(t[i],e[i]);o&&(n[i]=o)}),i.isEmpty(n)?null:n):t!==e?e:void 0},r.deepclone=function(t){return void 0===t?void 0:null===t?null:JSON.parse(JSON.stringify(t))},r.clone=function(t){return null===t||void 0===t?t:i.isFunction(t.clone)?t.clone():r.deepclone(t)},r.freeze=function(t){var e;if(i.isObject(t)){if(Object.isFrozen(t))return t;var n=Object.keys(t);for(e=0;e<n.length;e++){var o=n[e];t[o]=r.freeze(t[o])}return Object.freeze(t)}if(i.isArray(t)){var s=t;for(e=0;e<s.length;e++)s[e]=r.freeze(s[e]);return Object.freeze(s)}return t},r.later=function(t,e){return function(){var n=arguments;setTimeout(function(){t.apply(e,n)},0)}},r.isEmpty=function(t){return!t.match(/\w/)},r.slug=function(t){t=t.replace(/^\s+|\s+$/g,""),t=t.toLowerCase();for(var e="/_,:;",n="aaaaeeeeiiiioooouuuunc------",i=0,r=e.length;r>i;i++)t=t.replace(new RegExp(e.charAt(i),"g"),n.charAt(i));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")},e.exports=r},{fs:217,underscore:151}],151:[function(t,e,n){(function(){var t=this,i=t._,r={},o=Array.prototype,s=Object.prototype,a=Function.prototype,c=o.push,h=o.slice,u=o.concat,l=s.toString,p=s.hasOwnProperty,d=o.forEach,f=o.map,g=o.reduce,v=o.reduceRight,y=o.filter,m=o.every,w=o.some,b=o.indexOf,_=o.lastIndexOf,x=Array.isArray,C=Object.keys,P=a.bind,k=function(t){return t instanceof k?t:this instanceof k?(this._wrapped=t,void 0):new k(t)};"undefined"!=typeof n?("undefined"!=typeof e&&e.exports&&(n=e.exports=k),n._=k):t._=k,k.VERSION="1.5.2";
var E=k.each=k.forEach=function(t,e,n){if(null!=t)if(d&&t.forEach===d)t.forEach(e,n);else if(t.length===+t.length){for(var i=0,o=t.length;o>i;i++)if(e.call(n,t[i],i,t)===r)return}else for(var s=k.keys(t),i=0,o=s.length;o>i;i++)if(e.call(n,t[s[i]],s[i],t)===r)return};k.map=k.collect=function(t,e,n){var i=[];return null==t?i:f&&t.map===f?t.map(e,n):(E(t,function(t,r,o){i.push(e.call(n,t,r,o))}),i)};var S="Reduce of empty array with no initial value";k.reduce=k.foldl=k.inject=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),g&&t.reduce===g)return i&&(e=k.bind(e,i)),r?t.reduce(e,n):t.reduce(e);if(E(t,function(t,o,s){r?n=e.call(i,n,t,o,s):(n=t,r=!0)}),!r)throw new TypeError(S);return n},k.reduceRight=k.foldr=function(t,e,n,i){var r=arguments.length>2;if(null==t&&(t=[]),v&&t.reduceRight===v)return i&&(e=k.bind(e,i)),r?t.reduceRight(e,n):t.reduceRight(e);var o=t.length;if(o!==+o){var s=k.keys(t);o=s.length}if(E(t,function(a,c,h){c=s?s[--o]:--o,r?n=e.call(i,n,t[c],c,h):(n=t[c],r=!0)}),!r)throw new TypeError(S);return n},k.find=k.detect=function(t,e,n){var i;return N(t,function(t,r,o){return e.call(n,t,r,o)?(i=t,!0):void 0}),i},k.filter=k.select=function(t,e,n){var i=[];return null==t?i:y&&t.filter===y?t.filter(e,n):(E(t,function(t,r,o){e.call(n,t,r,o)&&i.push(t)}),i)},k.reject=function(t,e,n){return k.filter(t,function(t,i,r){return!e.call(n,t,i,r)},n)},k.every=k.all=function(t,e,n){e||(e=k.identity);var i=!0;return null==t?i:m&&t.every===m?t.every(e,n):(E(t,function(t,o,s){return(i=i&&e.call(n,t,o,s))?void 0:r}),!!i)};var N=k.some=k.any=function(t,e,n){e||(e=k.identity);var i=!1;return null==t?i:w&&t.some===w?t.some(e,n):(E(t,function(t,o,s){return i||(i=e.call(n,t,o,s))?r:void 0}),!!i)};k.contains=k.include=function(t,e){return null==t?!1:b&&t.indexOf===b?-1!=t.indexOf(e):N(t,function(t){return t===e})},k.invoke=function(t,e){var n=h.call(arguments,2),i=k.isFunction(e);return k.map(t,function(t){return(i?e:t[e]).apply(t,n)})},k.pluck=function(t,e){return k.map(t,function(t){return t[e]})},k.where=function(t,e,n){return k.isEmpty(e)?n?void 0:[]:k[n?"find":"filter"](t,function(t){for(var n in e)if(e[n]!==t[n])return!1;return!0})},k.findWhere=function(t,e){return k.where(t,e,!0)},k.max=function(t,e,n){if(!e&&k.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&k.isEmpty(t))return-1/0;var i={computed:-1/0,value:-1/0};return E(t,function(t,r,o){var s=e?e.call(n,t,r,o):t;s>i.computed&&(i={value:t,computed:s})}),i.value},k.min=function(t,e,n){if(!e&&k.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&k.isEmpty(t))return 1/0;var i={computed:1/0,value:1/0};return E(t,function(t,r,o){var s=e?e.call(n,t,r,o):t;s<i.computed&&(i={value:t,computed:s})}),i.value},k.shuffle=function(t){var e,n=0,i=[];return E(t,function(t){e=k.random(n++),i[n-1]=i[e],i[e]=t}),i},k.sample=function(t,e,n){return arguments.length<2||n?t[k.random(t.length-1)]:k.shuffle(t).slice(0,Math.max(0,e))};var O=function(t){return k.isFunction(t)?t:function(e){return e[t]}};k.sortBy=function(t,e,n){var i=O(e);return k.pluck(k.map(t,function(t,e,r){return{value:t,index:e,criteria:i.call(n,t,e,r)}}).sort(function(t,e){var n=t.criteria,i=e.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(i>n||void 0===i)return-1}return t.index-e.index}),"value")};var T=function(t){return function(e,n,i){var r={},o=null==n?k.identity:O(n);return E(e,function(n,s){var a=o.call(i,n,s,e);t(r,a,n)}),r}};k.groupBy=T(function(t,e,n){(k.has(t,e)?t[e]:t[e]=[]).push(n)}),k.indexBy=T(function(t,e,n){t[e]=n}),k.countBy=T(function(t,e){k.has(t,e)?t[e]++:t[e]=1}),k.sortedIndex=function(t,e,n,i){n=null==n?k.identity:O(n);for(var r=n.call(i,e),o=0,s=t.length;s>o;){var a=o+s>>>1;n.call(i,t[a])<r?o=a+1:s=a}return o},k.toArray=function(t){return t?k.isArray(t)?h.call(t):t.length===+t.length?k.map(t,k.identity):k.values(t):[]},k.size=function(t){return null==t?0:t.length===+t.length?t.length:k.keys(t).length},k.first=k.head=k.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:h.call(t,0,e)},k.initial=function(t,e,n){return h.call(t,0,t.length-(null==e||n?1:e))},k.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:h.call(t,Math.max(t.length-e,0))},k.rest=k.tail=k.drop=function(t,e,n){return h.call(t,null==e||n?1:e)},k.compact=function(t){return k.filter(t,k.identity)};var A=function(t,e,n){return e&&k.every(t,k.isArray)?u.apply(n,t):(E(t,function(t){k.isArray(t)||k.isArguments(t)?e?c.apply(n,t):A(t,e,n):n.push(t)}),n)};k.flatten=function(t,e){return A(t,e,[])},k.without=function(t){return k.difference(t,h.call(arguments,1))},k.uniq=k.unique=function(t,e,n,i){k.isFunction(e)&&(i=n,n=e,e=!1);var r=n?k.map(t,n,i):t,o=[],s=[];return E(r,function(n,i){(e?i&&s[s.length-1]===n:k.contains(s,n))||(s.push(n),o.push(t[i]))}),o},k.union=function(){return k.uniq(k.flatten(arguments,!0))},k.intersection=function(t){var e=h.call(arguments,1);return k.filter(k.uniq(t),function(t){return k.every(e,function(e){return k.indexOf(e,t)>=0})})},k.difference=function(t){var e=u.apply(o,h.call(arguments,1));return k.filter(t,function(t){return!k.contains(e,t)})},k.zip=function(){for(var t=k.max(k.pluck(arguments,"length").concat(0)),e=new Array(t),n=0;t>n;n++)e[n]=k.pluck(arguments,""+n);return e},k.object=function(t,e){if(null==t)return{};for(var n={},i=0,r=t.length;r>i;i++)e?n[t[i]]=e[i]:n[t[i][0]]=t[i][1];return n},k.indexOf=function(t,e,n){if(null==t)return-1;var i=0,r=t.length;if(n){if("number"!=typeof n)return i=k.sortedIndex(t,e),t[i]===e?i:-1;i=0>n?Math.max(0,r+n):n}if(b&&t.indexOf===b)return t.indexOf(e,n);for(;r>i;i++)if(t[i]===e)return i;return-1},k.lastIndexOf=function(t,e,n){if(null==t)return-1;var i=null!=n;if(_&&t.lastIndexOf===_)return i?t.lastIndexOf(e,n):t.lastIndexOf(e);for(var r=i?n:t.length;r--;)if(t[r]===e)return r;return-1},k.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=arguments[2]||1;for(var i=Math.max(Math.ceil((e-t)/n),0),r=0,o=new Array(i);i>r;)o[r++]=t,t+=n;return o};var I=function(){};k.bind=function(t,e){var n,i;if(P&&t.bind===P)return P.apply(t,h.call(arguments,1));if(!k.isFunction(t))throw new TypeError;return n=h.call(arguments,2),i=function(){if(!(this instanceof i))return t.apply(e,n.concat(h.call(arguments)));I.prototype=t.prototype;var r=new I;I.prototype=null;var o=t.apply(r,n.concat(h.call(arguments)));return Object(o)===o?o:r}},k.partial=function(t){var e=h.call(arguments,1);return function(){return t.apply(this,e.concat(h.call(arguments)))}},k.bindAll=function(t){var e=h.call(arguments,1);if(0===e.length)throw new Error("bindAll must be passed function names");return E(e,function(e){t[e]=k.bind(t[e],t)}),t},k.memoize=function(t,e){var n={};return e||(e=k.identity),function(){var i=e.apply(this,arguments);return k.has(n,i)?n[i]:n[i]=t.apply(this,arguments)}},k.delay=function(t,e){var n=h.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},k.defer=function(t){return k.delay.apply(k,[t,1].concat(h.call(arguments,1)))},k.throttle=function(t,e,n){var i,r,o,s=null,a=0;n||(n={});var c=function(){a=n.leading===!1?0:new Date,s=null,o=t.apply(i,r)};return function(){var h=new Date;a||n.leading!==!1||(a=h);var u=e-(h-a);return i=this,r=arguments,0>=u?(clearTimeout(s),s=null,a=h,o=t.apply(i,r)):s||n.trailing===!1||(s=setTimeout(c,u)),o}},k.debounce=function(t,e,n){var i,r,o,s,a;return function(){o=this,r=arguments,s=new Date;var c=function(){var h=new Date-s;e>h?i=setTimeout(c,e-h):(i=null,n||(a=t.apply(o,r)))},h=n&&!i;return i||(i=setTimeout(c,e)),h&&(a=t.apply(o,r)),a}},k.once=function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments),t=null,e)}},k.wrap=function(t,e){return function(){var n=[t];return c.apply(n,arguments),e.apply(this,n)}},k.compose=function(){var t=arguments;return function(){for(var e=arguments,n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},k.after=function(t,e){return function(){return--t<1?e.apply(this,arguments):void 0}},k.keys=C||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)k.has(t,n)&&e.push(n);return e},k.values=function(t){for(var e=k.keys(t),n=e.length,i=new Array(n),r=0;n>r;r++)i[r]=t[e[r]];return i},k.pairs=function(t){for(var e=k.keys(t),n=e.length,i=new Array(n),r=0;n>r;r++)i[r]=[e[r],t[e[r]]];return i},k.invert=function(t){for(var e={},n=k.keys(t),i=0,r=n.length;r>i;i++)e[t[n[i]]]=n[i];return e},k.functions=k.methods=function(t){var e=[];for(var n in t)k.isFunction(t[n])&&e.push(n);return e.sort()},k.extend=function(t){return E(h.call(arguments,1),function(e){if(e)for(var n in e)t[n]=e[n]}),t},k.pick=function(t){var e={},n=u.apply(o,h.call(arguments,1));return E(n,function(n){n in t&&(e[n]=t[n])}),e},k.omit=function(t){var e={},n=u.apply(o,h.call(arguments,1));for(var i in t)k.contains(n,i)||(e[i]=t[i]);return e},k.defaults=function(t){return E(h.call(arguments,1),function(e){if(e)for(var n in e)void 0===t[n]&&(t[n]=e[n])}),t},k.clone=function(t){return k.isObject(t)?k.isArray(t)?t.slice():k.extend({},t):t},k.tap=function(t,e){return e(t),t};var V=function(t,e,n,i){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof k&&(t=t._wrapped),e instanceof k&&(e=e._wrapped);var r=l.call(t);if(r!=l.call(e))return!1;switch(r){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=n.length;o--;)if(n[o]==t)return i[o]==e;var s=t.constructor,a=e.constructor;if(s!==a&&!(k.isFunction(s)&&s instanceof s&&k.isFunction(a)&&a instanceof a))return!1;n.push(t),i.push(e);var c=0,h=!0;if("[object Array]"==r){if(c=t.length,h=c==e.length)for(;c--&&(h=V(t[c],e[c],n,i)););}else{for(var u in t)if(k.has(t,u)&&(c++,!(h=k.has(e,u)&&V(t[u],e[u],n,i))))break;if(h){for(u in e)if(k.has(e,u)&&!c--)break;h=!c}}return n.pop(),i.pop(),h};k.isEqual=function(t,e){return V(t,e,[],[])},k.isEmpty=function(t){if(null==t)return!0;if(k.isArray(t)||k.isString(t))return 0===t.length;for(var e in t)if(k.has(t,e))return!1;return!0},k.isElement=function(t){return!(!t||1!==t.nodeType)},k.isArray=x||function(t){return"[object Array]"==l.call(t)},k.isObject=function(t){return t===Object(t)},E(["Arguments","Function","String","Number","Date","RegExp"],function(t){k["is"+t]=function(e){return l.call(e)=="[object "+t+"]"}}),k.isArguments(arguments)||(k.isArguments=function(t){return!(!t||!k.has(t,"callee"))}),"function"!=typeof/./&&(k.isFunction=function(t){return"function"==typeof t}),k.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},k.isNaN=function(t){return k.isNumber(t)&&t!=+t},k.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==l.call(t)},k.isNull=function(t){return null===t},k.isUndefined=function(t){return void 0===t},k.has=function(t,e){return p.call(t,e)},k.noConflict=function(){return t._=i,this},k.identity=function(t){return t},k.times=function(t,e,n){for(var i=Array(Math.max(0,t)),r=0;t>r;r++)i[r]=e.call(n,r);return i},k.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var $={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};$.unescape=k.invert($.escape);var D={escape:new RegExp("["+k.keys($.escape).join("")+"]","g"),unescape:new RegExp("("+k.keys($.unescape).join("|")+")","g")};k.each(["escape","unescape"],function(t){k[t]=function(e){return null==e?"":(""+e).replace(D[t],function(e){return $[t][e]})}}),k.result=function(t,e){if(null==t)return void 0;var n=t[e];return k.isFunction(n)?n.call(t):n},k.mixin=function(t){E(k.functions(t),function(e){var n=k[e]=t[e];k.prototype[e]=function(){var t=[this._wrapped];return c.apply(t,arguments),F.call(this,n.apply(k,t))}})};var R=0;k.uniqueId=function(t){var e=++R+"";return t?t+e:e},k.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var j=/(.)^/,L={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},M=/\\|'|\r|\n|\t|\u2028|\u2029/g;k.template=function(t,e,n){var i;n=k.defaults({},n,k.templateSettings);var r=new RegExp([(n.escape||j).source,(n.interpolate||j).source,(n.evaluate||j).source].join("|")+"|$","g"),o=0,s="__p+='";t.replace(r,function(e,n,i,r,a){return s+=t.slice(o,a).replace(M,function(t){return"\\"+L[t]}),n&&(s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),i&&(s+="'+\n((__t=("+i+"))==null?'':__t)+\n'"),r&&(s+="';\n"+r+"\n__p+='"),o=a+e.length,e}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{i=new Function(n.variable||"obj","_",s)}catch(a){throw a.source=s,a}if(e)return i(e,k);var c=function(t){return i.call(this,t,k)};return c.source="function("+(n.variable||"obj")+"){\n"+s+"}",c},k.chain=function(t){return k(t).chain()};var F=function(t){return this._chain?k(t).chain():t};k.mixin(k),E(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=o[t];k.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!=t&&"splice"!=t||0!==n.length||delete n[0],F.call(this,n)}}),E(["concat","join","slice"],function(t){var e=o[t];k.prototype[t]=function(){return F.call(this,e.apply(this._wrapped,arguments))}}),k.extend(k.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this)},{}],152:[function(t,e){var n={selection:["up","down","left","right","shift+up","shift+down","shift+left","shift+right","alt+up","alt+down","alt+left","alt+right","alt+shift+up","alt+shift+down","alt+shift+left","alt+shift+right","command+up","command+down","command+left","command+right","command+shift+up","command+shift+down","command+shift+left","command+shift+right","home","end","pagedown","pageup"],backspace:["backspace"],"delete":["del"],"break":["enter"],"soft-break":["shift+enter"],blank:["space","shift+space"],indent:["tab"],unindent:["shift+tab"],undo:["command+z"],redo:["command+shift+z"],copy:["command+c"],paste:["command+v"],cut:["command+x"],strong:["ctrl+b","command+b"],emphasis:["ctrl+i","command+i"],heading:["ctrl+command+h"],list:["ctrl+command+l"],figref:["ctrl+command+f"],codeblock:["ctrl+command+c"],save:["command+s"],"new":["command+n","alt+n"],reload:["command+r"],clear:["command+alt+backspace"]};e.exports=n},{}],153:[function(t,e){var n={selection:["up","down","left","right","shift+up","shift+down","shift+left","shift+right","ctrl+up","ctrl+down","ctrl+left","ctrl+right","ctrl+shift+up","ctrl+shift+down","ctrl+shift+left","ctrl+shift+right","home","end","pageup","pagedown"],backspace:["backspace"],"delete":["del"],"break":["enter"],"soft-break":["shift+enter"],blank:["space","shift+space"],indent:["tab"],unindent:["shift+tab"],undo:["ctrl+z"],redo:["ctrl+shift+z"],copy:["ctrl+c"],paste:["ctrl+v"],cut:["ctrl+x"],strong:["ctrl+b"],emphasis:["ctrl+i"],heading:["ctrl+shift+h"],figref:["ctrl+shift+f"],list:["ctrl+shift+l"],codeblock:["ctrl+shift+c"],save:["ctrl+s"],"new":["ctrl+alt+n"],reload:["ctrl+r"],clear:["ctrl+alt+backspace"]};e.exports=n},{}],154:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-article"),r=function(t){t=t||{},t.nodeTypes=t.nodeTypes||r.nodeTypes,i.call(this,t)};r.Prototype=function(){this.fromSnapshot=function(t,e){return r.fromSnapshot(t,e)}};var o=n.clone(i.nodeTypes),s=t("./nodes");n.each(s,function(t,e){o[e]=n.extend({},o[e],t)}),r.nodeTypes=o,r.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new r(e)},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"./nodes":186,"substance-article":10,underscore:151}],155:[function(t,e){"use strict";var n=t("substance-util"),i=t("substance-operator"),r=i.ObjectOperation,o=i.ArrayOperation,s=function(t){this.factory=t,this.view="content"};s.Prototype=function(){this.canDeleteNode=function(t,e){var n=this._nodePos(t,e.id);return n>=1&&n<this._length(t)},this.deleteNode=function(t,e){var i=this._nodePos(t,e.id),s=o.Delete(i,e.id);if(t.document.apply(r.Update([this.view,"nodes"],s)),1===this._length(t)){var a={type:"text",id:"text_"+n.uuid(),content:""};t.document.create(a),t.document.show(this.view,a.id)}},this._length=function(t){return t.document.nodes[this.view].nodes.length},this._nodeId=function(t,e){return t.document.nodes[this.view].nodes[e]},this._nodePos=function(t,e){return t.document.nodes[this.view].nodes.indexOf(e)}},s.prototype=new s.Prototype,e.exports=s},{"substance-operator":130,"substance-util":144}],156:[function(t,e){"use strict";var n=t("./not_editable"),i=t("substance-operator"),r=i.ObjectOperation,o=i.TextOperation,s=function(t){this.factory=t};s.Prototype=function(){this.canDeleteContent=function(t,e){switch(e.name){case"name":return!0;case"organization":return!0;case"email":return!0;default:return!1}},this.deleteContent=function(t,e,n,i){var s=[e.node.id];switch(e.name){case"name":s.push("name");break;case"organization":s.push("organization");break;case"email":s.push("email");break;default:throw new Error("Nope")}var a=t.document.resolve(s),c=a.get(),h=o.Delete(n,c.substring(n,i)),u=r.Update(s,h,"string");t.document.apply(u),t.annotator.update(u)},this.canInsertContent=function(t,e){switch(e.name){case"name":return!0;case"organization":return!0;case"email":return!0;default:return!1}},this.insertContent=function(t,e,n,i){var s=[e.node.id];switch(e.name){case"name":s.push("name");break;case"organization":s.push("organization");break;case"email":s.push("email");break;default:throw new Error("Nope")}var a=o.Insert(n,i),c=r.Update(s,a,"string");t.document.apply(c),t.annotator.update(c)}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"./not_editable":165,"substance-operator":130}],157:[function(t,e){"use strict";var n=t("./not_editable"),i=t("substance-operator"),r=i.ObjectOperation,o=i.TextOperation,s=function(t){this.factory=t};s.Prototype=function(){this.canDeleteContent=function(t,e,n,i){var r=e.node,o=e.path[1];if("title"===o){var s=r.title;return n<=s.length&&i<=s.length}return console.log("CoverEditor does not support editing:",e),!1},this.deleteContent=function(t,e,n,i){var s=e.node,a=e.path[1];if("title"!==a)throw new Error("CoverEditor does not support editing:",e);var c=s.title,h=o.Delete(n,c.substring(n,i)),u=r.Update(["document","title"],h,"string");t.document.apply(u),t.annotator.update(u,{path:["cover","title"]})},this.canInsertContent=function(t,e,n){var i=e.node,r=e.path[1];if("title"===r){var o=i.title;return n<=o.length}return console.log("CoverEditor does not support editing:",e),!1},this.insertContent=function(t,e,n,i){var s=e.path[1];if("title"!==s)throw new Error("CoverEditor does not support editing:",e);var a=o.Insert(n,i),c=r.Update(["document","title"],a,"string");t.document.apply(c),t.annotator.update(c,{path:["cover","title"]})},this.canAnnotate=function(t,e,n,i){var r=e.node,o=e.path[1];return"title"===o?i[0]<=r.title.length&&i[1]<=r.title.length:!1},this.annotate=function(t,e,n,i,r){var o,s=e.path[1];if("title"!==s)throw new Error("CoverEditor does not support annotations for:",e);if(o=["cover","title"],!o)throw new Error("Could not determine annotation path");t.document.annotate({type:n,path:o,range:i},r)}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"./not_editable":165,"substance-operator":130}],158:[function(t,e){"use strict";var n=t("./not_editable"),i=t("substance-operator"),r=i.ObjectOperation,o=i.TextOperation,s=function(t){this.factory=t};s.Prototype=function(){this.canDeleteContent=function(t,e){return"label"===e.path[1]||"caption"===e.name?!0:!1},this.deleteContent=function(t,e,n,i){var s=e.node;if("label"===e.path[1]){var a=s.label,c=o.Delete(n,a.substring(n,i)),h=r.Update([s.id,"label"],c,"string");t.document.apply(h),t.annotator.update(h)}else{if("caption"!==e.name)throw new Error("Can not delete content here.",e);var u=this.factory.createEditor(e.node);u.deleteContent(t,e,n,i)}},this.canInsertContent=function(t,e){return"label"===e.path[1]||"caption"===e.name?!0:!1},this.insertContent=function(t,e,n,i){var s=e.node;if("label"===e.path[1]){var a=o.Insert(n,i),c=r.Update([s.id,"label"],a,"string");t.document.apply(c),t.annotator.update(c)}else{if("caption"!==e.name)throw new Error("Can not insert content here.",e);var h=this.factory.createEditor(e.node);h.insertContent(t,e,n,i)}},this.canAnnotate=function(t,e){return"label"===e.path[1]||"caption"===e.name?!0:!1},this.annotate=function(t,e,n,i,r){var o=e.node;if("label"===e.path[1]){var s=[o.id,"label"];t.document.annotate({type:n,path:s,range:i},r)}else{if("caption"!==e.name)throw new Error("CoverEditor does not support annotations for:",e);var a=this.factory.createEditor(e.node);a.annotate(t,e,n,i,r)}}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"./not_editable":165,"substance-operator":130}],159:[function(t,e){"use strict";var n=t("./not_editable"),i=t("./figure_editor"),r=t("./text_node_editor"),o=function(){this.createEditor=function(t){switch(t.type){case"figure":return new i(this);case"text":return new r(this);default:return new n(this)}}};e.exports=o},{"./figure_editor":158,"./not_editable":165,"./text_node_editor":168}],160:[function(t,e){"use strict";var n=t("./text_node_editor"),i=t("substance-operator"),r=i.ObjectOperation,o=i.TextOperation,s=t("substance-util"),a=function(t){this.factory=t,this.breakType="text"};a.Prototype=function(){this.breakNode=function(t,e,n){var i,a=e.node,c=a.content,h=e.nodePos,u={id:s.uuid()},l="";0===n&&a.content.length>0?(u.type="heading",u.level=a.level,u.content="",i=h):(l=c.substring(n),u.type="text",u.content=l,i=h+1),t.document.apply(r.Create([u.id],u)),l.length>0&&(t.document.apply(r.Update([a.id,"content"],o.Delete(n,l),"string")),t.annotator.transferAnnotations(a,n,u)),t.document.show(t.view,u.id,i),t.selection.set([e.pos+1,0])},this.canChangeType=function(t,e,n){return"text"===n||"heading"===n},this.changeType=function(t,e,n,i,o){if(e.type!==i||e.level!==o.level){var a={id:s.uuid(),type:i};switch(i){case"list":throw new Error("Not yet implemented, sorry.");case"text":a.content=e.content;break;case"heading":if(e.type===i)return t.document.apply(r.Set([e.id,"level"],e.level,o.level)),void 0;a.content=e.content,a.level=o.level}t.document.hide(t.view,e.id),t.document.apply(r.Create([a.id],a)),t.annotator.transferAnnotations(e,0,a),t.document.apply(r.Delete([e.id],e.toJSON())),t.document.show(t.view,a.id,n)}},this.canIndent=function(t,e,n){var i=e.node;return"right"===n&&i.level<4||"left"===n&&i.level>0},this.indent=function(t,e,n){var i=e.node,r=i.level;"left"===n?r=Math.max(1,r-1):r+=1,t.document.set([i.id,"level"],r)}},a.Prototype.prototype=n.prototype,a.prototype=new a.Prototype,e.exports=a},{"./text_node_editor":168,"substance-operator":130,"substance-util":144}],161:[function(t,e){"use strict";var n=t("./not_editable"),i=t("./contributor_editor"),r=function(){this.createEditor=function(t){switch(t.type){case"contributor":return new i(this);default:return new n(this)}}};e.exports=r},{"./contributor_editor":156,"./not_editable":165}],162:[function(t,e){"use strict";var n=t("./not_editable"),i=t("substance-operator"),r=i.ObjectOperation,o=i.TextOperation,s=function(t){this.factory=t};s.Prototype=function(){this.canDeleteContent=function(t,e){switch(e.name){case"title":return!1;case"description":return!0;default:return!1}},this.deleteContent=function(t,e,n,i){var s=[e.node.id];switch(e.name){case"title":s.push("title");break;case"description":s.push("description");break;default:throw new Error("Nope")}var a=t.document.resolve(s),c=a.get(),h=o.Delete(n,c.substring(n,i)),u=r.Update(s,h,"string");t.document.apply(u),t.annotator.update(u)},this.canInsertContent=function(t,e){switch(e.name){case"title":return!1;case"description":return!0;default:return!1}},this.insertContent=function(t,e,n,i){var s=[e.node.id];switch(e.name){case"title":s.push("title");break;case"description":s.push("description");break;default:throw new Error("Nope")}var a=o.Insert(n,i),c=r.Update(s,a,"string");t.document.apply(c),t.annotator.update(c)}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"./not_editable":165,"substance-operator":130}],163:[function(t,e){"use strict";var n=t("./not_editable"),i=t("./issue_editor"),r=function(){this.createEditor=function(t){switch(t.type){case"error":case"remark":return console.log("Providing IssueEditor..."),new i(this);default:return new n(this)}}};e.exports=r},{"./issue_editor":162,"./not_editable":165}],164:[function(t,e){"use strict";var n=t("substance-util"),i=t("substance-operator"),r=i.ArrayOperation,o=i.TextOperation,s=i.ObjectOperation,a=t("./text_node_editor"),c=t("./heading_editor"),h=function(t){this.factory=t,this.textEditor=new a(t),this.headingEditor=new c(t)};h.Prototype=function(){this.canDeleteContent=function(t,e,n,i){return this.textEditor.canDeleteContent(t,e,n,i)},this.deleteContent=function(t,e,n,i){return this.textEditor.deleteContent(t,e,n,i)},this.canInsertContent=function(t,e,n){return this.textEditor.canInsertContent(t,e,n)},this.insertContent=function(t,e,n,i){return this.textEditor.insertContent(t,e,n,i)},this.canIndent=function(t,e,n){return this.headingEditor.canIndent(t,e,n)},this.indent=function(t,e,n){return this.headingEditor.indent(t,e,n)},this.canAnnotate=function(t,e,n,i){return this.textEditor.canAnnotate(t,e,n,i)},this.annotate=function(t,e,n,i,r){return this.textEditor.annotate(t,e,n,i,r)},this.canBreak=function(t,e){return e.node.content.length>0},this.breakNode=function(t,e,i){if(!(e.node.content.length>0))throw"Splitting lists is not implemented yet.";var a=e.node,c=a.content,h=c.substring(i),u=t.document.get(e.path[0]),l=u.items.indexOf(a.id),p={id:n.uuid(),type:"list_item",level:a.level,content:h};t.document.apply(s.Create([p.id],p)),h.length>0&&(t.document.apply(s.Update([a.id,"content"],o.Delete(i,h),"string")),t.annotator.transferAnnotations(a,i,p)),t.document.apply(s.Update([u.id,"items"],r.Insert(l+1,p.id))),t.selection.set([e.pos+1,0])},this.canChangeType=function(){return!1},this.changeType=function(){throw new Error("Nope.")},this.canJoin=function(){return!1},this.join=function(){throw new Error("Nope.")}},h.prototype=new h.Prototype,e.exports=h},{"./heading_editor":160,"./text_node_editor":168,"substance-operator":130,"substance-util":144}],165:[function(t,e){"use strict";var n=function(t){this.factory=t};n.Prototype=function(){this.canDeleteContent=function(){return!1},this.deleteContent=function(){throw new Error("Nope.")},this.canInsertContent=function(){return!1},this.insertContent=function(){throw new Error("Nope.")},this.canIndent=function(){return!1},this.indent=function(){throw new Error("Nope.")},this.canAnnotate=function(){return!1},this.annotate=function(){throw new Error("Nope.")},this.canBreak=function(){return!1},this.breakNode=function(){throw new Error("Nope.")},this.canChangeType=function(){return!1},this.changeType=function(){throw new Error("Nope.")},this.canJoin=function(){return!1},this.join=function(){throw new Error("Nope.")}},n.prototype=new n.Prototype,e.exports=n},{}],166:[function(t,e){"use strict";var n=t("underscore"),i=function(){};i.Prototype=function(){var t={link:"ref",figure_reference:"ref",citation_reference:"ref",contributor_reference:"ref",emphasis:"expression",strong:"expression",subscript:"expression",superscript:"expression",code:"expression",math:"expression",remark_reference:"marker",error_reference:"marker"},e=[],i={};n.each(t,function(t,n){e.push(n),i[t]=i[t]||[],i[t].push(n)}),this.getAllowedActions=function(r,o){var s=[];if(o.isNull())return s;if(o.hasMultipleNodes())return s;var a=r.annotator.getAnnotations(o),c=0,h={};if(n.each(i,function(t,e){h[e]=[]}),n.each(a,function(e){var n=t[e.type],i=h[n];i.push(e),c++}),c>0)n.each(a,function(e){var n=t[e.type];h[n].length>1||s.push({action:"deleteAnnotation",type:e.type,id:e.id})},this),o.isCollapsed()||0!==h.marker.length||n.each(i.marker,function(t){s.push({action:"createAnnotation",type:t})});else{var u;u=o.isCollapsed()?["figure_reference","citation_reference"]:e,n.each(u,function(t){var e={action:"createAnnotation",type:t};"link"===t&&(e.data={}),s.push(e)})}return s}},i.prototype=new i.Prototype,e.exports=i},{underscore:151}],167:[function(t,e){"use strict";var n=t("./text_node_editor"),i=t("./heading_editor"),r=t("./not_editable"),o=t("./content_view_editor"),s=t("./cover_editor"),a=t("./richtext_annotator"),c=t("./list_editor"),h=function(){this.annotator=new a,this.createEditor=function(t){switch(t.type){case"text":case"codeblock":return new n(this);case"heading":return new i(this);case"cover":return new s(this);case"view":return"content"===t.id?new o(this):new r(this);case"list":return new c(this);default:return new r(this)}},this.getAnnotator=function(){return this.annotator}};e.exports=h},{"./content_view_editor":155,"./cover_editor":157,"./heading_editor":160,"./list_editor":164,"./not_editable":165,"./richtext_annotator":166,"./text_node_editor":168}],168:[function(t,e){"use strict";var n=t("substance-operator"),i=n.ObjectOperation,r=n.TextOperation,o=t("substance-util"),s=function(t){this.factory=t};s.Prototype=function(){this.canDeleteContent=function(t,e,n,i){var r=e.node.content.length;return r>=n&&r>=i},this.deleteContent=function(t,e,n,o){var s=e.node,a=s.content,c=o-n;if(c>0){var h=r.Delete(n,a.substring(n,o)),u=i.Update([s.id,"content"],h,"string");t.document.apply(u),t.annotator.update(u)}},this.canInsertContent=function(t,e,n){var i=e.node.content.length;return i>=n},this.insertContent=function(t,e,n,o){var s=e.node,a=r.Insert(n,o),c=i.Update([s.id,"content"],a,"string");t.document.apply(c),t.annotator.update(c)},this.canAnnotate=function(){return!0},this.annotate=function(t,e,n,i,r){var o=e.node,s=[o.id,"content"];t.document.annotate({type:n,path:s,range:i},r)},this.canBreak=function(t,e,n){var i=e.node.content.length;return i>=n},this.breakNode=function(t,e,n){var s=e.node,a=s.content,c=a.substring(n),h=e.nodePos,u={id:o.uuid(),type:"text",content:c};t.document.apply(i.Create([u.id],u)),c.length>0&&(t.document.apply(i.Update([s.id,"content"],r.Delete(n,c),"string")),t.annotator.transferAnnotations(s,n,u)),t.document.show(t.view,u.id,h+1),t.selection.set([e.pos+1,0])},this.canChangeType=function(){return!1},this.canJoin=function(t,e,n){return n instanceof t.document.nodeTypes.text.Model},this.join=function(t,e,n){if(!n.content)throw new Error("Currently only text and heading nodes can be joined.");var o=n.content,s=e.content.length,a=r.Insert(s,o),c=i.Update([e.id,"content"],a,"string");t.document.apply(c),t.annotator.transferAnnotations(n,0,e,s)}},s.prototype=new s.Prototype,e.exports=s},{"substance-operator":130,"substance-util":144}],169:[function(t,e){"use strict";var n=t("substance-application").Controller,i=t("substance-article"),r=i.ViewFactory,o=t("./focus_view"),s=function(t){this.document=t,this.viewFactory=new r(t)};s.Prototype=function(){this.createView=function(){return this.view||(this.view=new o(this)),this.view},this.initialize=function(t,e){e(null)},this.transition=function(t,e){var n=this.state.contextId===t.contextId&&this.state.resourceId===t.resourceId&&this.state.side===t.side;n?(console.log("FocusViewController: skipping transition."),e(null,n)):e(null)},this.afterTransition=function(){this.view&&(this.view.dispose(),this.view=null),this.createView(),this.view.render()},this.dispose=function(){this.view&&this.view.dispose(),this.view=null}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"./focus_view":170,"substance-application":4,"substance-article":10}],170:[function(t,e){"use strict";var n=t("substance-application").View,i=function(t){n.call(this),this.focusCtrl=t};i.Prototype=function(){this.render=function(){var t=this.focusCtrl.state;
this.nodeView&&this.nodeView.dispose(),this.el=document.createElement("DIV"),this.el.classList.add("focus-view");var e=this.focusCtrl.document,n=this.focusCtrl.viewFactory,i=t.resourceId,r=e.get(i);return this.nodeView=n.createView(r),this.el.appendChild(this.nodeView.render().el),this},this.dispose=function(){this.stopListening()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,e.exports=i},{"substance-application":4}],171:[function(t,e){"use strict";var n=t("../node/node_surface"),i=t("../text/text_surface"),r=function(t,e){n.call(this,t,e),this.components.push(this.titleComponent());for(var i=0;i<t.authors.length;i++)this.components.push(this.authorComponent(i));this.components.push(this.sourceComponent())};r.Prototype=function(){this.titleComponent=function(){var t=this,e=new i(this.node,this.surfaceProvider,{property:"title"}),n=e.components[0];return n.element(function(){return t.view.childViews.title.el}).length(function(){return t.node.title.length+1}),n.name="title",n},this.authorComponent=function(t){var e=this,n=this.customComponent([this.node.id,"author"+t],{name:"author"}).element(function(){return e.view.authorEls[t]}).length(function(){return e.node.authors[t].length}).mapping(function(t){var e=document.createRange();return e.setStart(this.el.childNodes[0],t),e});return n},this.sourceComponent=function(){var t=this,e=this.customComponent([this.node.id,"source"],{name:"source"});return e.element(function(){return t.view.sourceEl}).length(function(){return t.node.source.length+1}).mapping(function(t){var e=document.createRange();return e.setStart(this.el.childNodes[0],t),e}),e}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node/node_surface":196,"../text/text_surface":201}],172:[function(t,e){"use strict";var n=t("../node").View,i=t("../text").View,r=t("substance-application").$$,o=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("citation"),this.childViews={title:null}};o.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=document.createDocumentFragment(),e=this.node,o=this.childViews.title=new i(this.node,this.viewFactory,{property:"title"});t.appendChild(o.render().el);var s=r("a.delete-resource",{href:"#",text:"Delete",contenteditable:!1});o.el.appendChild(s);var a=r(".resource-body");this.authorEls=[];for(var c=r(".authors"),h=0;h<e.authors.length;h++){var u=e.authors[h];this.authorEls.push(r("span.author",{text:u,"data-path":"author"+h})),c.appendChild(this.authorEls[h]),c.appendChild(document.createTextNode(" "))}a.appendChild(c);var l=[];return e.source&&e.volume&&l.push([e.source,e.volume].join(", ")+": "),e.fpage&&e.lpage&&l.push([e.fpage,e.lpage].join("-")+", "),e.publisher_name&&e.publisher_location&&l.push([e.publisher_name,e.publisher_location].join(", ")+", "),e.year&&l.push(e.year),this.sourceEl=r(".source",{html:l.join("")}),a.appendChild(this.sourceEl),e.doi&&(this.doiEl=r(".doi",{children:[r("b",{text:"DOI: "}),r("a",{href:e.doi,target:"_new",text:e.doi})]}),a.appendChild(this.doiEl)),t.appendChild(a),this.content.appendChild(t),this}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"../node":195,"../text":200,"substance-application":4}],173:[function(t,e){"use strict";e.exports={View:t("./editable_citation_view"),Surface:t("./citation_surface")}},{"./citation_surface":171,"./editable_citation_view":172}],174:[function(t,e){"use strict";e.exports={Surface:t("../text/text_surface")}},{"../text/text_surface":201}],175:[function(t,e){"use strict";var n=t("../node/node_surface"),i=t("../text/text_surface");t("../node/surface_components");var r=function(t,e){n.call(this,t,e),this.nameComponent=i.textProperty(this,"name"),this.organizationComponent=i.textProperty(this,"organization"),this.emailComponent=i.textProperty(this,"email"),this.components.push(this.nameComponent),this.components.push(this.organizationComponent),this.components.push(this.emailComponent)};r.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.nameComponent.surface.attachView(this.view.childViews.name),this.organizationComponent.surface.attachView(this.view.childViews.organization),this.emailComponent.surface.attachView(this.view.childViews.email)}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node/node_surface":196,"../node/surface_components":197,"../text/text_surface":201}],176:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("../node").View,r=t("../text").View,o=function(t){i.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node contributor"),this.childViews={name:null,organization:null,email:null}};o.Prototype=function(){this.render=function(){i.prototype.render.call(this);var t=this.childViews.name=new r(this.node,this.viewFactory,{property:"name"});$(t.el).addClass("toggle-resource"),this.content.appendChild(t.render().el);var e=n("a.delete-resource",{href:"#",text:"Delete",contenteditable:!1});t.el.appendChild(e);var o=n(".resource-body");this.imgEl=n("img"),this.updateImage(),this.imageEl=n(".image",{contenteditable:!1,children:[n("input.contributor-image-file",{type:"file",name:"files","data-id":this.node.id}),this.imgEl]}),o.appendChild(this.imageEl);var s=this.childViews.organization=new r(this.node,this.viewFactory,{property:"organization"});o.appendChild(s.render().el),this.node.contribution&&(o.appendChild(n(".label",{text:"Contribution"})),this.contribEl=n(".contribution.node-property",{text:this.node.contribution,"data-path":"contribution"}),o.appendChild(this.contribEl)),o.appendChild(n(".label",{text:"Email",contenteditable:!1}));var a=this.childViews.email=new r(this.node,this.viewFactory,{property:"email"});return o.appendChild(a.render().el),this.content.appendChild(o),this},this.updateImage=function(){var t=this.node.getUrl()||"styles/contributor-image-placeholder.png";this.imgEl.setAttribute("src",t)},this.onNodeUpdate=function(t){return"image"===t.path[1]?(this.updateImage(),!0):"name"===t.path[1]?(this.childViews.name.onNodeUpdate(t),!0):"organization"===t.path[1]?(this.childViews.organization.onNodeUpdate(t),!0):"email"===t.path[1]?(this.childViews.email.onNodeUpdate(t),!0):!1},this.onGraphUpdate=function(t){if(!i.prototype.onGraphUpdate.call(this,t)){var e=this.node.image;t.path[0]===e&&this.updateImage()}}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":195,"../text":200,"substance-application":4}],177:[function(t,e){"use strict";e.exports={View:t("./editable_contributor_view"),Surface:t("./contributor_surface")}},{"./contributor_surface":175,"./editable_contributor_view":176}],178:[function(t,e){"use strict";var n=t("../node/node_surface"),i=t("../text/text_surface"),r=function(t,e){n.call(this,t,e),this.titleComponent=i.textProperty(this,"title",["document","title"]),this.components.push(this.titleComponent)};r.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.titleComponent.surface.attachView(this.view.childViews.title)}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node/node_surface":196,"../text/text_surface":201}],179:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-application").$$,r=t("substance-document").Annotator,o=t("../node").View,s=t("../text").View,a=function(t,e){o.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node cover"),this.childViews={title:null},this.authors={}};a.Prototype=function(){this.render=function(){o.prototype.render.call(this);var t=this.node.document.published_on||this.node.document.created_at;t&&this.content.appendChild(i(".published-on",{contenteditable:!1,html:new Date(t).toDateString()}));var e=this.childViews.title=new s(this.node,this.viewFactory,{property:"title"});return this.content.appendChild(e.render().el),e.el.classList.add("title"),this.authorsEl=i(".authors",{contenteditable:!1}),this.renderAuthors(),this.content.appendChild(this.authorsEl),this},this.renderAuthors=function(){this.authorsEl.innerHTML="",this.authors={};var t=this.node.document.getAuthors();n.each(t,function(t){this.authors[t.id]=t;var e=i("a.toggle-author",{id:"toggle_"+t.id,href:"#",text:t.name,"data-id":t.id});this.authorsEl.appendChild(e)},this)},this.onGraphUpdate=function(t){return o.prototype.onGraphUpdate.call(this,t)?!0:n.isEqual(t.path,["document","title"])?(this.childViews.title.renderContent(),!0):((this.authors[t.path[0]]||n.isEqual(t.path,["document","authors"]))&&this.renderAuthors(),r.changesAnnotations(this.node.document,t,["cover","title"])?(this.childViews.title.renderContent(),!0):void 0)}},a.Prototype.prototype=o.prototype,a.prototype=new a.Prototype,e.exports=a},{"../node":195,"../text":200,"substance-application":4,"substance-document":35,underscore:151}],180:[function(t,e){"use strict";e.exports={View:t("./editable_cover_view"),Surface:t("./cover_surface")}},{"./cover_surface":178,"./editable_cover_view":179}],181:[function(t,e){"use strict";e.exports={View:t("../issue/editable_issue_view"),Surface:t("../issue/issue_surface")}},{"../issue/editable_issue_view":187,"../issue/issue_surface":189}],182:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("../node").View,r=t("../text").View,o=function(t,e){i.call(this,t,e),this.childViews={label:null,caption:null}};o.Prototype=function(){this.render=function(){i.prototype.render.call(this);var t=this.childViews.label=new r(this.node,this.viewFactory,{property:"label"});$(t.el).addClass("toggle-resource"),this.content.appendChild(t.render().el);var e=n("a.delete-resource",{href:"#",text:"Delete",contenteditable:!1});t.el.appendChild(e);var o=n(".resource-body");this.imgEl=n("img",{href:"#"}),this.imgWrapper=n(".image-wrapper",{contenteditable:!1,children:[n("input.figure-image-file",{type:"file",name:"files","data-id":this.node.id}),n("a",{href:"#",title:"View image in full size",target:"_blank",children:[this.imgEl]})]}),o.appendChild(this.imgWrapper),this.updateImage();var s=this.node.getCaption();if(s){var a=this.childViews.caption=this.viewFactory.createView(s),c=a.render().el;c.classList.add("caption"),o.appendChild(c)}return this.content.appendChild(o),this},this.updateImage=function(){var t=this.node.getUrl()||"styles/image-placeholder.png";this.imgEl.setAttribute("src",t),$(this.imgWrapper).find("a").attr({href:t})},this.onNodeUpdate=function(t){this.updateImage(),this.childViews.label.onNodeUpdate(t)},this.onGraphUpdate=function(t){if(!i.prototype.onGraphUpdate.call(this,t)){var e=this.node.image;t.path[0]===e&&this.updateImage()}}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":195,"../text":200,"substance-application":4}],183:[function(t,e){"use strict";t("underscore");var n=t("../node/node_surface"),i=t("../text/text_surface");t("../node/surface_components");var r=function(t,e){if(n.call(this,t,e),this.labelComponent=i.textProperty(this,"label"),this.components.push(this.labelComponent),this.node.caption){var r=this.node.getCaption(),o=this.surfaceProvider.getNodeSurface(r);this.addSubSurface("caption",o)}};r.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.labelComponent.surface.attachView(this.view.childViews.label),this.captionComponent&&this.captionComponent.surface.attachView(this.view.childViews.caption)}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node/node_surface":196,"../node/surface_components":197,"../text/text_surface":201,underscore:151}],184:[function(t,e){"use strict";e.exports={View:t("./editable_figure_view"),Surface:t("./figure_surface")}},{"./editable_figure_view":182,"./figure_surface":183}],185:[function(t,e){e.exports=t(174)},{"../text/text_surface":201}],186:[function(t,e){"use strict";e.exports={node:t("./node"),text:t("./text"),heading:t("./heading"),codeblock:t("./codeblock"),figure:t("./figure"),contributor:t("./contributor"),cover:t("./cover"),citation:t("./citation"),issue:t("./issue"),list:t("./list"),list_item:t("./list_item"),remark:t("./remark"),error:t("./error")}},{"./citation":173,"./codeblock":174,"./contributor":177,"./cover":180,"./error":181,"./figure":184,"./heading":185,"./issue":188,"./list":190,"./list_item":192,"./node":195,"./remark":198,"./text":200}],187:[function(t,e){"use strict";var n=t("substance-application").$$,i=t("../node").View,r=t("../text").View,o=function(t,e){i.call(this,t,e),this.$el.addClass("issue"),this.childViews={title:null,description:null}};o.Prototype=function(){var t=i.prototype;this._updateTitle=function(){this.titleTextEl.innerHTML=this.ref?this.ref.getContent():""},this.render=function(){i.prototype.render.call(this);var t=n("div.issue-title-wrapper");this.titleTextEl=n(".text.title");var e=n("a.delete-resource",{href:"#",text:"Delete",contenteditable:!1});t.appendChild(this.titleTextEl),t.appendChild(e),t.setAttribute("contenteditable","false"),this.content.appendChild(t),n("div.creator",{text:(this.node.creator||"Anonymous")+", "+jQuery.timeago(new Date(this.node.created_at)),contenteditable:!1});var o=this.childViews.description=new r(this.node,this.viewFactory,{property:"description"});this.content.appendChild(o.render().el);var s=this.node.getReferences(),a=Object.keys(s);return a.length>0&&(this.ref=s[a[0]],this._updateTitle()),this},this.onNodeUpdate=function(t){return"title"===t.path[1]?(this.childViews.title.onNodeUpdate(t),!0):"description"===t.path[1]?(this.childViews.description.onNodeUpdate(t),!0):!1},this.onGraphUpdate=function(e){return t.onGraphUpdate.call(this,e)?!0:"create"===e.type&&e.val.target===this.node.id?(this.ref=this.node.document.get(e.val.id),this._updateTitle(),!0):"delete"===e.type&&e.val.target===this.node.id?(this.ref=null,this._updateTitle(),!0):this.ref&&e.path[0]===this.ref.id?(this._updateTitle(),!0):!1}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":195,"../text":200,"substance-application":4}],188:[function(t,e){"use strict";e.exports={View:t("./editable_issue_view"),Surface:t("./issue_surface")}},{"./editable_issue_view":187,"./issue_surface":189}],189:[function(t,e){"use strict";var n=t("../node/node_surface"),i=t("../text/text_surface"),r=function(t,e){n.call(this,t,e),this.descriptionComp=i.textProperty(this,"description"),this.components.push(this.descriptionComp)};r.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e),this.descriptionComp.surface.attachView(this.view.childViews.description)}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node/node_surface":196,"../text/text_surface":201}],190:[function(t,e){"use strict";e.exports={Surface:t("./list_surface")}},{"./list_surface":191}],191:[function(t,e){"use strict";var n=t("../node/node_surface"),i=t("../list_item/list_item_surface"),r=function(t,e){n.call(this,t,e),this.components=null,this._rebuild()};r.Prototype=function(){var t=n.prototype;this.attachView=function(e){t.attachView.call(this,e)},this._rebuild=function(){this.components=[];for(var t=this.node.getItems(),e=0;e<t.length;e++){var n=t[e],r=new i(this,n,n.id);this.components.push(r.getComponent())}},this.update=function(t){return t.path[0]===this.node.id&&"items"===t.path[1]?(this._rebuild(),!0):!1}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../list_item/list_item_surface":193,"../node/node_surface":196}],192:[function(t,e){e.exports=t(174)},{"../text/text_surface":201}],193:[function(t,e){"use strict";var n=t("../text/text_surface"),i=function(t,e){n.call(this,e,t.surfaceProvider,{property:e.id}),this.parent=t;var i=this.getComponent();i.path=[t.node.id,e.id],i.length(function(){return e.content.length}),this.hasView=function(){return this.parent.view?!!this.parent.view.childViews[this.node.id]:!1}};i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,Object.defineProperty(i.prototype,"view",{get:function(){return this.parent.view?this.parent.view.childViews[this.node.id]:null},set:function(){console.log("REFACTOR THIS: NodeSurface.view needs to be evaluated dynamic. Insert an extra level of indirection.")}}),e.exports=i},{"../text/text_surface":201}],194:[function(t,e){"use strict";var n=t("substance-application").View,i=t("underscore"),r=0,o=function(t,e){this.__id__=r++,n.call(this),this.node=t,this.viewFactory=e,this.$el.addClass("content-node").addClass(t.type),this.$el.attr("id",this.node.id)};o.Prototype=function(){this.render=function(){return this.disposeChildViews(),this.el.innerHTML="",this.content=document.createElement("DIV"),this.content.classList.add("content"),this.el.appendChild(this.content),this},this.dispose=function(){this.stopListening(),this.disposeChildViews()},this.disposeChildViews=function(){this.childViews&&i.each(this.childViews,function(t){t&&t.dispose()})},this.onGraphUpdate=function(t){return t.path[0]!==this.node.id||"update"!==t.type&&"set"!==t.type?!1:(this.onNodeUpdate(t),!0)},this.onNodeUpdate=function(){}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"substance-application":4,underscore:151}],195:[function(t,e){"use strict";e.exports={View:t("./editable_node_view"),Node:t("./node_surface")}},{"./editable_node_view":194,"./node_surface":196}],196:[function(t,e){"use strict";var n=t("./surface_components"),i=0,r=function(t,e){this.__id__=i++,this.node=t,this.surfaceProvider=e,this.view=null,this.components=[]};r.Prototype=function(){this.hasView=function(){return null!==this.view},this.attachView=function(t){this.view=t},this.getCharPosition=function(t,e){if(!this.view)throw new Error("No view attached.");var n=this.__getCharPosition__(t,e);return n},this.getDOMPosition=function(t){if(!this.view)throw new Error("No view attached.");var e=this.__getDOMPosition__(t);return e},this.propertyComponent=function(t,e){return new n.PropertyComponent(this,t,e)},this.customComponent=function(t,e){return new n.CustomComponent(this,t,e)},this.__getCharPosition__=function(t,e){var n=document.createRange();n.setStart(t,e);for(var i=0,r=0;r<this.components.length;r++){var o=this.components[r],s=n.compareBoundaryPoints(0,o.getRange());if(0>s)break;var a=n.compareBoundaryPoints(3,o.getRange());i=0>a?e:o.getLength()}return i},this.__getDOMPosition__=function(t){for(var e,n,i=0;i<this.components.length;i++){if(n=this.components[i],!n.getLength)throw new Error("The provided component can not be used with the generic mapper implementation. getLength() missing.");if(!n.mapCharPos)throw new Error("The provided component can not be used with the generic mapper implementation. getRange() missing.");if(e=n.getLength(),e>t)return n.mapCharPos(t);t-=e}return n.mapCharPos(e)},this.__createRange__=function(t){var e=document.createRange();return e.selectNode(t),e},this.addSubSurface=function(t,e){for(var n=0;n<e.components.length;n++){var i=e.components[n];i.name=t,this.components.push(i)}}},r.prototype=new r.Prototype,e.exports=r},{"./surface_components":197}],197:[function(t,e){"use strict";var n=t("underscore"),i=function(t){var e=document.createRange();return e.selectNode(t),e},r=function(t){this.surface=t,this.node=t.node,this.path=null,this.__range__=null};r.Prototype=function(){this.getRange=function(){return this.__range__||(this.__range__=i(this.getElement())),this.__range__},this.element=function(t){return this.__getElement__=t,this},this.length=function(t){return this.__getLength__=t,this},this.mapping=function(t){return this.__mapCharPos__=t,this},this.getElement=function(){if(!this.el&&(this.el=this.__getElement__.call(this),!this.el))throw new Error("You tried to access a component which has not been rendered!");return this.el},this.__getElement__=function(){throw new Error("This method is abstract and must be overridden")},this.getLength=function(){return this.__getLength__.call(this)},this.__getLength__=function(){throw new Error("This is abstract and must be overridden")},this.mapCharPos=function(t){return this.__mapCharPos__.call(this,t)},this.__mapCharPos__=function(){throw new Error("This method is abstract and must be overridden")}},r.prototype=new r.Prototype;var o=function(t,e,n){r.call(this,t),this.type="property",this.path=[t.node.id,e],this.propertyPath=n||this.path};o.Prototype=function(){},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype;var s=function(t,e,i){r.call(this,t),this.type="custom",n.isString(e)&&(e=[t.node.id,e]),this.path=e,n.extend(this,i)};s.Prototype=function(){},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,e.exports={PropertyComponent:o,CustomComponent:s}},{underscore:151}],198:[function(t,e){e.exports=t(181)},{"../issue/editable_issue_view":187,"../issue/issue_surface":189}],199:[function(t,e){"use strict";function n(t){var e=t.getAnnotationBehavior();if(!e)throw new Error("Missing AnnotationBehavior.");return e}var i,r=t("substance-application").$$,o=t("substance-util").Fragmenter,s=t("substance-document").Annotator,a=t("../node").View,c=function(t,e,i){a.call(this,t),i=i||{},this.property=i.property||"content",this.$el.addClass("content-node text"),"text"===t.type&&this.$el.addClass("text-node"),i.property&&(this.$el.removeAttr("id"),this.$el.removeClass("content-node"),this.$el.addClass(i.property)),this.$el.attr("data-path",this.property),this._annotations={},this.annotationBehavior=n(t.document),this._fragments=[]};c.Prototype=function(){var t=a.prototype;this.render=function(e){return t.render.call(this,e),this.renderContent(),this},this.renderContent=function(){this.content.innerHTML="",this._annotations=this.node.document.getIndex("annotations").get([this.node.id,this.property]),this.renderWithAnnotations(this._annotations)},this.insert=function(t,e){var n=this._lookupPostion(t),i=n[0],r=i.el,o=n[1],s=r.textContent;s=s.substring(0,o)+e+s.substring(o),r.textContent=s;for(var a=i.index+1;a<this._fragments.length;a++)this._fragments[a].charPos+=e.length},this.delete=function(t,e){var n=this._lookupPostion(t,"delete"),i=n[0],r=i.el,o=n[1],s=r.textContent;if(o+e>=s.length)return this.renderContent(),void 0;s=s.substring(0,o)+s.substring(o+e),r.textContent=s;for(var a=i.index+1;a<this._fragments.length;a++)this._fragments[a].charPos-=e},this._lookupPostion=function(t,e){for(var n,i,r=0;r<this._fragments.length;r++){if(n=this._fragments[r],i=n.getLength(),i>t)return[n,t];if(!(t>i)){var o=this._fragments[r+1];return o&&o.level<n.level||e?[o,0]:[n,i]}t-=i}return[n,i]},this.onNodeUpdate=function(t){if(t.path[1]===this.property)if("update"===t.type){var e=t.diff;if(e.isInsert())return this.insert(e.pos,e.str),!0;if(e.isDelete())return this.delete(e.pos,e.str.length),!0}else if("set"===t.type)return this.renderContent(),!0;return!1},this.onGraphUpdate=function(e){return t.onGraphUpdate.call(this,e)?!0:!s.changesAnnotations(this.node.document,e,[this.node.id,this.property])||"create"!==e.type&&"delete"!==e.type?!1:(console.log("Rerendering TextView due to annotation update",e),this.renderContent(),!0)},this.createAnnotationElement=function(t){var e;return e="link"===t.type?r("a.annotation."+t.type,{id:t.id,href:this.node.document.get(t.id).url}):r("span.annotation."+t.type,{id:t.id})},this.renderWithAnnotations=function(t){var e=this,n=this.node[this.property],i=document.createDocumentFragment(),r=new o(this.annotationBehavior.levels);this._fragments=[];var s=null,a=0,h=0,u=0;r.onText=function(t,n){var i=document.createTextNode(n);e._fragments.push(new c.DefaultFragment(i,a++,h,u)),h+=n.length,t.appendChild(i)},r.onEnter=function(t,n){s=t,u++;var i=e.createAnnotationElement(t);return n.appendChild(i),i},r.onExit=function(){u--},r.start(i,n,t),this.content.innerHTML="",this.content.appendChild(i)},this.dispose=function(){this.stopListening()}},c.Prototype.prototype=a.prototype,c.prototype=new c.Prototype;var h=function(t,e){for(var n=0;n<e.length;n++)t.unshift(e[n])};i=function(t,e){var n=[];for(h(n,t.childNodes);n.length;){var i=n.shift();if(i.nodeType===Node.TEXT_NODE){var r=i.textContent;if(r.length>=e)return[i,e];e-=r.length}else h(n,i.childNodes)}},c.Fragment=function(t,e,n,i){this.el=t,this.index=e,this.charPos=n,this.level=i},c.Fragment.Prototype=function(){this.getLength=function(){throw new Error("This method is abstract")}},c.Fragment.prototype=new c.Fragment.Prototype,c.DefaultFragment=function(){c.Fragment.apply(this,arguments)},c.DefaultFragment.Prototype=function(){this.getLength=function(){return this.el.length}},c.DefaultFragment.Prototype.prototype=c.Fragment.prototype,c.DefaultFragment.prototype=new c.DefaultFragment.Prototype,e.exports=c},{"../node":195,"substance-application":4,"substance-document":35,"substance-util":144}],200:[function(t,e){"use strict";e.exports={View:t("./editable_text_view"),Surface:t("./text_surface")}},{"./editable_text_view":199,"./text_surface":201}],201:[function(t,e){"use strict";var n=t("../node/node_surface"),i=function(t,e,i){n.call(this,t,e),i=i||{},this.property=i.property||"content";var r=this;i.property?this.components.push(this.propertyComponent(i.property,i.propertyPath)):this.components.push(this.propertyComponent(r.property).length(function(){return r.node[r.property].length}))};i.Prototype=function(){this.getCharPosition=function(t,e){if(!this.view)throw new Error("No view attached.");if(0===this.view._fragments.length||t===this.view._fragments[0].el.parentElement)return 0;for(var n,i=0;i<this.view._fragments.length;i++){var r=this.view._fragments[i];if(r.el===t){n=r;break}}if(!n)throw console.error("AAAAArg",t),new Error("Could not lookup text element.");var o=n.charPos+e;return o},this.getDOMPosition=function(t){if(!this.view)throw new Error("No view attached.");var e=this.view._lookupPostion(t),n=e[0],i=e[1],r=document.createRange();return r.setStart(n.el,i),r},this.getComponent=function(){return this.components[0]}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.textProperty=function(t,e,n){var r={property:e};n&&(r[n]=n);var o=new i(t.node,t.surfaceProvider,r),s=o.components[0];return s.element(function(){return t.view.childViews[e].el}).length(function(){return t.node[e].length+1}),s.name=e,s},e.exports=i},{"../node/node_surface":196}],202:[function(t,e){"use strict";var n=t("substance-application").View,i=t("substance-application").$$,r=function(t){this.publishView=t,n.call(this),this.$el.on("click",".login",this.login.bind(this)),this.$el.on("change","#github_password",this.login.bind(this))};r.Prototype=function(){this.login=function(t){var e=this,n=this.$("#github_user").val(),i=this.$("#github_password").val();this.publishView.publishCtrl.login(n,i,function(t){t&&(e.errorMsg.innerHTML="Authentication failed.")}),t.preventDefault()},this.render=function(){var t=i(".status",{children:[i("div",{html:['<p>We use <a href="http://pages.github.com/" target="_blank">Github Pages</a> for static hosting of your published documents.</p>','<p>If you do not have a Github account yet, you can <a href="https://github.com/join" target="_blank">sign up here</a>.</p>'].join("")})]});this.el.appendChild(t);var e=i(".github-user",{children:[i("div.label",{text:"Github User"}),i("input#github_user",{type:"text",value:""})]});this.el.appendChild(e);var n=i(".github-password",{children:[i("div.label",{text:"Password"}),i("input#github_password",{type:"password"})]});this.el.appendChild(n);var r=i(".actions",{children:[i("a.login",{href:"#",text:"Login"})]});return this.el.appendChild(r),this.errorMsg=i(".error-message"),this.el.appendChild(this.errorMsg),this},this.dispose=function(){this.stopListening()}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"substance-application":4}],203:[function(t,e){"use strict";var n=t("substance-application").View,i=t("substance-application").$$,r=t("substance-util"),o=t("underscore"),s=function(t){this.publishView=t,n.call(this),this.$el.on("click",".publish",this.publish.bind(this)),this.$el.on("click",".create-repo",this.creatRepo.bind(this)),this.$el.on("change","#github_reponame",this.updateRepoStatus.bind(this)),this.$el.on("change","#github_docname",this.updateDocStatus.bind(this))};s.Prototype=function(){this.updateDocStatus=function(){var t=this,e=localStorage.getItem("github_username"),n=this.$("input#github_reponame").val(),i=this.$("#github_docname").val();$(this.publishInfo).html(["Your doc will become available at the following URL:<br/>","<code>","http://",e,".github.com/",n,"/",i,"</code>"].join("")),this.publishView.publishCtrl.checkDocname(n,i,function(e){e?(t.$(".docname-status").removeClass("success").addClass("error").html('<i class="icon-exclamation-sign"></i> '+e),t.$(".publish").addClass("disabled")):(t.$(".publish").removeClass("disabled"),t.$(".docname-status").removeClass("error").addClass("success").html('<i class="icon-check-sign"></i> Looks like a good name'))})},this.updateRepoStatus=function(){var t=this,e=this.$("input#github_reponame").val();e&&(localStorage.setItem("repo_lru",e),this.publishView.publishCtrl.checkRepo(e,function(e){t.$(".publish").addClass("disabled"),t.$(".publish").addClass("disabled"),e?($(t.publishInfo).empty(),"does_not_exist"===e?t.$(".repo-status").removeClass("error success").html('<i class="icon-exclamation-sign"></i> Repo does not exist. <a class="create-repo" href="#">Create</a>'):t.$(".repo-status").addClass("error").html('<i class="icon-exclamation-sign"></i> '+e),t.$(".document-name").hide()):(t.$(".repo-status").removeClass("error").addClass("success").html('<i class="icon-check-sign"></i> We can work with that repo'),t.$(".document-name").show(),t.updateDocStatus())}))},this.creatRepo=function(t){var e=this,n=this.$("input#github_reponame").val();n&&(e.$(".repo-status").removeClass("error").html("Creating repo... Please wait."),this.publishView.publishCtrl.createRepo(n,function(t){return t?(e.$(".repo-status").addClass("error").html("Could not create repository."),void 0):(o.delay(function(){e.updateRepoStatus()},100),void 0)}),t.preventDefault())},this.publish=function(t){var e=this,n=$(t.currentTarget);if(!n.hasClass("disabled")){e.$(".publish").addClass("disabled"),e.$(".publish").html("Uploading... Please wait.");var i=this.$("input#github_reponame").val(),r=this.$("input#github_docname").val();this.publishView.publishCtrl.publish(i,"gh-pages",r,function(){e.$(".error-message").html("An error occured."),e.$(".publish").removeClass("disabled"),e.$(".publish").html("Publish")})}t.preventDefault()},this.render=function(){var t=localStorage.getItem("github_username"),e=localStorage.getItem("repo_lru"),n=this.publishView.publishCtrl.document,o=r.slug(n.title),s=i(".status",{children:[i("div",{html:"Your document has not been published yet."})]});this.el.appendChild(s);var a=i(".github-repo",{children:[i("div.label",{text:"1. Choose a Github Repository"}),i("label",{text:t+" / "}),i("input#github_reponame",{type:"text",value:e||"publications"}),i("span.repo-status",{text:""}),i("input#github_branch",{type:"hidden",value:"gh-pages"})]});this.el.appendChild(a),this.docNameEl=i(".document-name",{children:[i("div.label",{text:"2. Choose a memorable name for your document."}),i("label",{text:t+" / "+"docs / "}),i("input#github_docname",{type:"text",value:o}),i("span.docname-status",{text:""})]}),this.el.appendChild(this.docNameEl),this.publishInfo=i(".publish-info",{text:""}),this.el.appendChild(this.publishInfo);var c=i(".actions",{children:[i("a.publish.green.disabled",{href:"#",text:"Publish"})]});return this.el.appendChild(c),this.errorMsg=i(".error-message"),this.el.appendChild(this.errorMsg),this.updateRepoStatus(),this},this.dispose=function(){this.stopListening()}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":4,"substance-util":144,underscore:151}],204:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-util"),r=t("substance-application").Controller,o=t("./publish_view"),s=function(t,e){this.document=t,this.writerCtrl=e
};s.Prototype=function(){this.createSettings=function(t){var e=this.getSettings();if(e)n.extend(e,t);else{var i=this.document.create({id:"publish_settings.json",type:"file",content_type:"application/json"});i.updateData(JSON.stringify(t))}},this.getSettings=function(){var t=this.document.get("publish_settings.json");return t?t.getData():null},this.destroySettings=function(){this.document.delete("publish_settings.json")},this.createView=function(){return this.view||(this.view=new o(this)),this.view},this.logout=function(){localStorage.setItem("github_username",""),localStorage.setItem("github_password",""),this.switchState({id:"authenticate"})},this.login=function(t,e,n){var i=this;this.authenticate(t,e,function(r){return r?n(r):(localStorage.setItem("github_username",t),localStorage.setItem("github_password",e),i.switchState({id:"create_publication"}),void 0)})},this.authenticate=function(t,e,n){this.github=new Github({username:t,password:e,auth:"basic"}),this.github.getUser().show(n)},this.autoAuthenticate=function(t){var e=localStorage.getItem("github_username"),n=localStorage.getItem("github_password");e&&n||t("not_authorized"),this.github=new Github({username:e,password:n,auth:"basic"}),t(null)},this.checkRepo=function(t,e){var n=localStorage.getItem("github_username"),i=this.github.getRepo(n,t);i.show(function(t,n){return t?e("does_not_exist"):"gh-pages"!==n.default_branch?e("`gh-pages` is not set as the default branch."):(e(null),void 0)})},this.createRepo=function(t,e){function r(t){d.createRepo(p,function(e){n.delay(function(){t(e)},50)})}function o(e){h=l.github.getRepo(u,t),h.getRef("heads/master",function(t,i){c=i,n.delay(function(){e(t)},50)})}function s(t){h.createRef({ref:"refs/heads/gh-pages",sha:c},function(e){n.delay(function(){t(e)},50)})}function a(e){h.editRepo({name:t,default_branch:"gh-pages"},function(t){n.delay(function(){e(t)},50)})}var c,h,u=localStorage.getItem("github_username"),l=this,p={name:t,"private":!1,has_issues:!0,has_wiki:!1,auto_init:!0,has_downloads:!1},d=this.github.getUser();i.async.sequential({functions:[r,o,s,a]},e)},this.checkDocname=function(t,e,n){var i=localStorage.getItem("github_username"),r=this.github.getRepo(i,t);r.contents("gh-pages",e,function(t){return t?t&&404===t.error?n(null):(n("Unknown error"),void 0):n("This folder does already exist")})},this.publishChanges=function(t){var e=this;this.document.setPublishedOn((new Date).toJSON()),this.deleteDoc(function(i){if(i&&404!==i.error)return t(i);var r=e.getSettings();e.writeDocument(r.reponame,r.branch,r.docname,function(i){if(i)return t(i);r.published_on=new Date,app.save();var o=n.clone(e.writerCtrl.state);o.id="main",e.writerCtrl.switchState(o)})})},this.deleteDoc=function(t){var e=this.getSettings(),r=this.github.getRepo(e.username,e.reponame);r.contents(e.branch,e.docname,function(o,s){if(o)return t(o);var a=[];n.each(s,function(t){a.push(function(i){n.delay(function(){r.deleteFile(e.branch,t.path,t.sha,"Delete "+t.path,i)},2e3)})}),i.async.sequential({functions:a},t)})},this.unpublish=function(t){var e=this;this.deleteDoc(function(n){return n&&404!==n.error?t(n):(e.destroySettings(),e.document.setPublishedOn(null),app.save(),e.switchState({id:"create_publication"}),t(null),void 0)})},this.writeDocument=function(t,e,r,o){function s(t){for(var e="",n=new Uint8Array(t),i=n.byteLength,r=0;i>r;r++)e+=String.fromCharCode(n[r]);return window.btoa(e)}var a=localStorage.getItem("github_username"),c=this.github.getRepo(a,t);app.generateZip(function(t,a){var h=[];n.each(a.files,function(t,i){h.push(function(o){var a=s(t.asArrayBuffer());c.createFile(e,r+"/"+i,a,"Created "+r+"/"+i,function(t){n.delay(function(t){o(t)},2e3),console.log("wrote file",r+"/"+i,"err",t)})})}),i.async.sequential({functions:h},o)})},this.publish=function(t,e,n,i){var r=this,o=localStorage.getItem("github_username");this.document.setPublishedOn((new Date).toJSON()),this.writeDocument(t,e,n,function(s){if(console.log("writedocument err",s),s)return i(s);try{var a={target:"github",username:o,reponame:t,branch:e,docname:n,published_on:new Date};r.createSettings(a),app.save()}catch(s){i(s)}r.switchState({id:"update_publication"})})},this.initialize=function(t,e){console.log("initializing publishcontroller",t),this.createView().render(),e(null)},this.transition=function(t,e){var n=this;this.autoAuthenticate(function(i){if(i)t.id="authenticate";else if("default"===t.id){var r=n.document.get("publish_settings.json");console.log("publishsettings",r),t.id=r?"update_publication":"create_publication"}n.state=t,e(null)})},this.afterTransition=function(t){this.view.transition(t)},this.dispose=function(){this.view&&this.view.dispose(),this.view=null}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,e.exports=s},{"./publish_view":205,"substance-application":4,"substance-util":144,underscore:151}],205:[function(t,e){var n=t("substance-application").View,i=t("substance-application").$$;t("underscore"),t("substance-util");var r=t("./authenticate_view"),o=t("./create_publication_view"),s=t("./update_publication_view"),a=function(t){n.call(this),this.publishCtrl=t,this.$el.addClass("publish-settings-view"),this.$el.on("click",".logout",this.logout.bind(this))};a.Prototype=function(){this.logout=function(t){this.publishCtrl.logout(),t.preventDefault()},this.transition=function(t){switch(this.contextView&&this.contextView.dispose(),t.id){case"create_publication":this.contextView=new o(this,t);break;case"authenticate":this.contextView=new r(this);break;case"update_publication":this.contextView=new s(this);break;default:return}var e=localStorage.getItem("github_username");this.contextPanel.innerHTML="",e&&this.contextPanel.appendChild(i(".login-status",{html:"Logged into Github as <code>"+e+'</code>. <a href="#" class="logout">Logout</a>'})),this.contextPanel.appendChild(this.contextView.render().el)},this.render=function(){return this.el.innerHTML="",this.el.appendChild(i(".arrow")),this.contextPanel=i(".context-panel"),this.el.appendChild(this.contextPanel),this}},a.Prototype.prototype=n.prototype,a.prototype=new a.Prototype,a.prototype.constructor=a,e.exports=a},{"./authenticate_view":202,"./create_publication_view":203,"./update_publication_view":206,"substance-application":4,"substance-util":144,underscore:151}],206:[function(t,e){"use strict";var n=t("substance-application").View,i=t("substance-application").$$,r=function(t){this.publishView=t,this.doc=this.publishView.publishCtrl.document,this.settings=this.publishView.publishCtrl.getSettings(),n.call(this),this.$el.on("click",".unpublish",this.unpublish.bind(this)),this.$el.on("click",".publish-changes",this.publishChanges.bind(this))};r.Prototype=function(){this.unpublish=function(t){var e=this,n=$(t.currentTarget);n.hasClass("disabled")||(e.$(".publish-changes").addClass("disabled"),e.$(".unpublish").addClass("disabled"),e.$(".unpublish").html("Unpublishing... Please wait."),this.publishView.publishCtrl.unpublish(function(t){t&&(e.$(".error-message").html("An error occured."),e.$(".unpublish").removeClass("disabled")),e.$(".unpublish").html("Unpublish")})),t.preventDefault()},this.publishChanges=function(t){var e=$(t.currentTarget),n=this;e.hasClass("disabled")||(n.$(".publish-changes").addClass("disabled"),n.$(".unpublish").addClass("disabled"),n.$(".publish-changes").html("Uploading... Please wait."),this.publishView.publishCtrl.publishChanges(function(t){t&&(n.$(".error-message").html("An error occured."),n.$(".publish-changes").removeClass("disabled")),n.$(".unpublish").removeClass("disabled"),n.$(".publish-changes").html("Publish Changes")})),t.preventDefault()},this.render=function(){var t=["http://",this.settings.username,".github.com/",this.settings.reponame,"/",this.settings.docname].join(""),e=i(".status",{children:[i("div",{text:"This document is published at:"}),i("a.publish",{target:"_blank",href:t,text:t}),i(".label",{text:"Keep in mind it may take a while (up to 30 minutes) until the page becomes available."})]});this.el.appendChild(e);var n=new Date(this.doc.updated_at).getTime(),r=new Date(this.settings.published_on).getTime(),o=-500>r-n,s=i("a.publish-changes.green",{href:"#",text:"Publish Changes"});o||$(s).addClass("disabled");var a=i(".actions",{children:[s,i("a.unpublish.red",{href:"#",text:"Unpublish"})]});return this.el.appendChild(a),this.errorMsg=i(".error-message"),this.el.appendChild(this.errorMsg),this},this.dispose=function(){this.stopListening()}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"substance-application":4}],207:[function(t,e){"use strict";function n(){var t=r.uuid();return{id:t,nodes:{document:{id:"document",type:"document",views:["content","figures","citations"],guid:t,creator:"",title:"Untitled",authors:["contributor_1"],"abstract":"",created_at:(new Date).toJSON()},cover:{id:"cover",type:"cover",authors:[]},content:{type:"view",id:"content",nodes:["cover","text1"]},figures:{type:"view",id:"figures",nodes:[]},remarks:{type:"view",id:"remarks",nodes:[]},errors:{type:"view",id:"errors",nodes:[]},info:{type:"view",id:"info",nodes:["contributor_1"]},text1:{type:"text",id:"text1",content:"Start typing"},contributor_1:{type:"contributor",id:"contributor_1",name:"John Doe",role:"author",organization:"ACME",image:"",email:"me@example.com"}}}}var i=t("underscore"),r=t("substance-util"),o=t("substance-application"),s=o.$$,a=t("substance-chronicle"),c=t("./writer_controller"),h=t("./editable_article"),u=t("./substance_router"),l=window.JSZip,p=window.brackets,d=t("substance-commander"),f=d.ChromeKeyboard,g=function(t){o.call(this,t),this.options=t,p?this.newDocument(!0):this.restore(!0);var e=c._getDefaultKeyMap();this.keyboard=new f(e),this.keyboard.setDefaultHandler(this.keyboard.PASS);var n=new u(this);this.setRouter(n)};g.Article=t("substance-article"),g.Outline=t("lens-outline"),g.Prototype=function(){this.initialize=function(){function t(t){s.aboutDocument(),t.preventDefault(),t.stopPropagation()}function e(t){s.newDocument(),t.preventDefault(),t.stopPropagation()}function n(t){s.save(),t.preventDefault(),t.stopPropagation()}function i(t){s.export(),t.preventDefault(),t.stopPropagation()}function r(t){window.location.reload(),t.preventDefault(),t.stopPropagation()}function o(t){s.clear(),t.preventDefault(),t.stopPropagation()}$(document).on("dragover",function(){return!1}),$(document).on("ondragend",function(){return!1}),$(document).on("drop",this.handleDroppedFile.bind(this));var s=this;this.keyboard.bind("save","keydown",n),this.keyboard.bind("new","keydown",e),this.keyboard.bind("reload","keydown",r),this.keyboard.bind("clear","keydown",o),this.keyboard.connect(this.el),$(this.el).on("click",".toggle-annotation.export",i),$(this.el).on("click",".toggle-annotation.save",n),$(this.el).on("click",".new-document",e),$(this.el).on("click",".about",t)},this.initDoc=function(t,e){var n=this;this.doc=t,this.controller&&this.controller.dispose(),this.controller=new c(this.doc,{onAutoSave:function(){},onDocumentEdit:function(){n.updateTitle(n.doc.title)}}),e||this.switchState({id:"main",contextId:"toc"},{updateRoute:!0,replace:!0})},this.updateTitle=function(){document.title=p?this.currentPath?this.currentPath:"untitled *":this.doc.title},this.render=function(){var t=s("#container"),e=s("#main");t.appendChild(e),this.el.appendChild(t)},this.clear=function(){localStorage.clear(),window.location.reload()},this.restore=function(t){var e=localStorage.getItem("autosave");if(!e)return this.aboutDocument(t);var n=new l(e,{base64:!0}),i=this.unzip(n);this.initDoc(i,t)},this.save=function(){var t=this;return!this.currentPath&&p?this.saveDocumentAs():(t.generateZip(function(e,n){var i=n.generate({type:"base64"});try{localStorage.setItem("autosave",i)}catch(e){window.confirm("Quota exceeded. Do you want to clear your cache? To prevent from data loss please export the current document before confirming.")&&t.clear()}$(".control.save").addClass("disable"),p&&t.writeFile(t.currentPath,i,function(t){t?(console.error(t),$(".control.save").addClass("error"),r.printStackTrace(t)):($(".control.save").removeClass("error"),$(".control.save").addClass("disable"))})}),void 0)},this.writeFile=function(t,e,n){p.fs.writeBinaryFile(t,e,function(i){i&&n(i),p.fs.readBinaryFile(t,function(t,i){e===i?n(null):n("error when writing file")})})},this.saveDocumentAs=function(){var t=this;p.fs.showSaveDialog("Save Substance document ..","","untitled.zip",function(e,n){n&&(t.currentPath=n,t.generateZip(function(e,n){var i=n.generate({type:"base64"});t.writeFile(t.currentPath,i,function(t){t?(console.error(t),$(".control.save").addClass("error"),r.printStackTrace(t)):($(".control.save").removeClass("error"),$(".control.save").addClass("disable"))})}))})},this.openFile=function(){var t=this;p.fs.showOpenDialog(!1,!1,"Open Substance document","",["sdf","zip"],function(e,n){n=n[0],t.currentPath=n,p.fs.readBinaryFile(n,function(e,n){if(e)return alert("Could not read file."),console.error("Error in readBinaryFile",e),void 0;var i=new l(n,{base64:!0}),r=t.unzip(i);t.initDoc(r)})})},this.export=function(){var t=this;this.generateZip(function(e,n){if(e)return console.error(e);var i=n.generate({type:"blob"}),o=document.querySelector(".export-zip");o.href=window.URL.createObjectURL(i),o.download=r.slug(t.doc.title)+".sdf.zip",/Chrome/.test(navigator.userAgent)||/Firefox/.test(navigator.userAgent)||alert("Unfortunately, Safari doesn't support downloading of generated zip files. For the time being, please use Google Chrome for storing docs on disk."),$(".export-zip")[0].click()})},this.generateZip=function(t){function e(t,e){var n=new FileReader;n.onload=function(t){e(null,t.target.result)},n.onerror=function(t){e(t.target.error)},n.readAsBinaryString(t)}var n=new l,o=this.doc,s=o.toJSON(),a=[],c={},h=o.getIndex("files"),u={};i.each(h.nodes,function(t){u[t]=o.get(t)}),i.each(u,function(t,n){t.isBinary()&&a.push(function(i){e(t.getData(),function(t,e){c[n]=e,i(null)})})}),r.async.sequential({functions:a},function(e){return e?(r.printStackTrace(e),t(e)):(i.each(u,function(t,e){t.isJSON()?n.file(e,JSON.stringify(t.getData(),null,"  ")):t.isText()?n.file(e,t.getData()):n.file(e,c[e],{binary:!0})}),n.file("content.json",JSON.stringify(s,null,"  ")),$.get("data/reader.tpl.html").done(function(e){e=e.replace("{{{{TITLE}}}}",o.title),n.file("index.html",e),t(null,n)}).fail(t),void 0)})},this.handleDroppedFile=function(t){var e=this,n=t.originalEvent.dataTransfer.files,i=n[0],r=new FileReader;return r.onload=function(t){e.importDocument(t.target.result)},r.readAsArrayBuffer(i),!1},this.unzip=function(t){var e=t.files["content.json"].asText();if(e){var n=JSON.parse(e),r=h.fromSnapshot(n,{chronicle:a.create()}),o=r.getIndex("files");i.each(o.nodes,function(e){var n=r.get(e);n.isText()?n.updateData(t.files[n.id].asText()):n.updateData(t.files[n.id].asArrayBuffer())},this)}return r},this.importDocument=function(t,e){e=e||{};var n=new l(t,e),i=this.unzip(n);this.initDoc(i)},this.aboutDocument=function(t){this.currentPath="";var e=new l(this.options.introDocument),n=this.unzip(e);return this.initDoc(n,t),!1},this.newDocument=function(t){this.currentPath=null;var e=n(),i=new h({seed:e,chronicle:a.create()});return this.initDoc(i,t),!1},this.afterTransition=function(t,e){e||(this.$("#main").html(this.controller.view.el),this.updateTitle(this.doc.title))}},g.Prototype.prototype=o.prototype,g.prototype=new g.Prototype,g.prototype.constructor=g,g.util=t("substance-util"),g.Application=t("substance-application"),g.Commander=t("substance-commander"),g.Document=t("substance-document"),g.Operator=t("substance-operator"),g.Chronicle=t("substance-chronicle"),g.Data=t("substance-data"),g.RegExp=t("substance-regexp"),g.Surface=t("substance-surface"),e.exports=g},{"./editable_article":154,"./substance_router":208,"./writer_controller":215,"lens-outline":2,"substance-application":4,"substance-article":10,"substance-chronicle":15,"substance-commander":24,"substance-data":28,"substance-document":35,"substance-operator":130,"substance-regexp":137,"substance-surface":139,"substance-util":144,underscore:151}],208:[function(t,e){"use strict";var n=t("underscore"),i=t("substance-application").Router,r=function(t){i.call(this),this.app=t,n.each(r.routes,function(t){this[t.command]?this.route(t.route,t.name,n.bind(this[t.command],this)):console.error("Unknown route handler: ",t.command)},this),this.route(/^state=.*$/,"state",n.bind(this.openState,this))};r.Prototype=function(){this.start=function(){i.history.start()};var t={updateRoute:!1,replace:!1};this.openState=function(){var e=i.history.getFragment(),n=this.app.stateFromFragment(e);this.app.switchState(n,t)},this.openWriter=function(){this.app.switchState({id:"main",contextId:"toc"},t)},this.navigate=function(t,e){i.history.navigate(t,e)}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,r.routes=[{route:":context/:node/:resource/:fullscreen",name:"document-resource",command:"openWriter"},{route:":context/:node/:resource",name:"document-resource",command:"openWriter"},{route:":context/:node/:resource",name:"document-resource",command:"openWriter"},{route:":context/:node",name:"document-node",command:"openWriter"},{route:":context",name:"document-context",command:"openWriter"},{route:"",name:"document",command:"openWriter"}],e.exports=r},{"substance-application":4,underscore:151}],209:[function(t){"use strict";var e=t("substance-application").View,n=t("substance-application").$$,i=function(t){this.toolbarView=t,e.call(this)};i.Prototype=function(){this.render=function(){return this.el.innerHTML="",this.el.appendChild(n("span.label",{html:"Choose Resource on the right hand side"})),this.el.appendChild(n("a.end-workflow",{href:"#","sbs-click":"endAddRef()",html:"Cancel"})),this},this.dispose=function(){this.stopListening()}},i.Prototype.prototype=e.prototype,i.prototype=new i.Prototype},{"substance-application":4}],210:[function(t,e){"use strict";var n=t("substance-application").View,i=t("substance-application").$$;t("underscore");var r=function(t){this.toolbarView=t,n.call(this),this.controls={}};r.Prototype=function(){this.render=function(){return this.el.innerHTML='<span class="label">Choose Content Element</span>',this.controls={},this.controls.heading=i("a.control.heading",{href:"#",html:'<i class="icon-align-left"></i> Heading'}),this.el.appendChild(this.controls.heading),this.controls.codeblock=i("a.control.codeblock",{href:"#",html:'<i class="icon-align-left"></i> Codeblock'}),this.el.appendChild(this.controls.codeblock),this.controls.heading.onclick=this.createNode.bind(this,"heading"),this.controls.codeblock.onclick=this.createNode.bind(this,"codeblock"),this},this.createNode=function(t,e){var n=this.toolbarView.actions[t];console.log("InsertContentView.createNode",t,n),n&&"createNode"===n.action&&(this.toolbarView.toolbarCtrl.parentAdapter.insertNode(t,n.data),e.preventDefault())},this.dispose=function(){this.stopListening()}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"substance-application":4,underscore:151}],211:[function(t,e){"use strict";var n=t("substance-application").View,i=t("substance-application").$$,r=t("underscore"),o=function(t){n.call(this),this.toolbarView=t,console.log("constructed linkeditorview"),$(this.el).delegate("#link_submission_form","submit",r.bind(this.saveLink,this)),$(this.el).delegate("#link_url","change",r.bind(this.saveLink,this))};o.Prototype=function(){this.render=function(){this.el.innerHTML="",this.el.appendChild(i("span.label",{text:"Link url"}));var t=this.toolbarView.toolbarCtrl.state.url;this.linkInputEl=i("input#link_url",{placeholder:"Enter Link URL",value:t});var e=i("form#link_submission_form",{children:[this.linkInputEl]});return this.el.appendChild(e),this},this.saveLink=function(){var t=$(this.linkInputEl),e=t.val();return this.toolbarView.toolbarCtrl.saveLink(e),!1},this.dispose=function(){this.stopListening()}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"substance-application":4,underscore:151}],212:[function(t,e){"use strict";var n=t("./toolbar_view"),i=t("substance-application").Controller,r=function(t){this.parentAdapter=t,this.state={id:"initialized"}};r.Prototype=function(){this.createView=function(){return this.view||(this.view=new n(this)),this.view},this.initialize=function(t,e){this.createView(),e(null)},this.dispose=function(){this.view&&this.view.dispose(),this.view=null},this.transition=function(t,e){if(this.view.update(),this.state.id===t.id){if("editlink"!==this.state.id)return;if(this.state.annotation===t.annotation)return}this.state=t,this.view.transition(t),e&&(console.log("who called this method with a callback?"),e(null))},this.update=function(){var t=this.parentAdapter.getActiveAnnotation();if(t&&"link"===t.type){var e=t.url||"";this.transition({id:"editlink",url:e,annotation:t.id})}else this.transition({id:"main"})},this.beginAddRef=function(t){this.parentAdapter.beginAddRef(t)},this.endAddRef=function(){this.parentAdapter.endAddRef(null)},this.getActiveAnnotation=function(){return this.parentAdapter.getActiveAnnotation()},this.saveLink=function(t){var e=this.getActiveAnnotation();e?this.parentAdapter.updateNode(e.id,"url",t):this.annotate("link",{url:t})}},r.Prototype.prototype=i.prototype,r.prototype=new r.Prototype,e.exports=r},{"./toolbar_view":213,"substance-application":4}],213:[function(t,e){var n=t("substance-application").View,i=t("substance-application").$$,r=t("underscore"),o=t("./add_reference_view"),s=t("./link_editor_view"),a=t("./insert_content_view"),c=function(t){n.call(this),this.$el.addClass("toolbar-view"),this.toolbarCtrl=t,this.actions={},this.controls={},this.$el.on("click",".figure_reference",this.createRef.bind(this,"figure"))};c.Prototype=function(){this.transition=function(t){switch(this.toolbarCtrl.state,this.contextView&&this.contextView.dispose(),$(this.el).removeClass().addClass("toolbar-view"),$(this.contextBar).html(""),t.id){case"addref":this.contextView=new o(this,t).render();break;case"editlink":this.contextView=new s(this).render();break;case"insertcontent":this.contextView=new a(this).render();break;default:return}$(this.el).addClass("mode-"+t.id),$(this.contextBar).html(this.contextView.el)},this.render=function(){this.el.innerHTML="",this.toolbarCtrl.parentAdapter.getDocument();var t=i(".annotation-toggles.group");this.controls={},this.controls.emphasis=i("a.control.toggle-annotation.emphasis",{href:"#","sbs-click":"performAction(emphasis)",html:'<i class="icon-italic"></i>',title:"Emphasis"}),t.appendChild(this.controls.emphasis),this.controls.strong=i("a.control.toggle-annotation.strong",{href:"#","sbs-click":"performAction(strong)",html:'<i class="icon-bold"></i>',title:"Strong Emphasis"}),t.appendChild(this.controls.strong),this.controls.subscript=i("a.control.toggle-annotation.subscript",{href:"#","sbs-click":"performAction(subscript)",html:'<i class="icon-subscript"></i>',title:"Subscript"}),t.appendChild(this.controls.subscript),this.controls.superscript=i("a.control.toggle-annotation.superscript",{href:"#","sbs-click":"performAction(superscript)",html:'<i class="icon-superscript"></i>',title:"Superscript"}),t.appendChild(this.controls.superscript),this.controls.code=i("a.control.toggle-annotation.code",{href:"#","sbs-click":"performAction(code)",html:'<i class="icon-code"></i>',title:"Code"}),t.appendChild(this.controls.code),this.controls.link=i("a.control.toggle-annotation.link",{href:"#","sbs-click":"performAction(link)",html:'<i class="icon-external-link"></i>',title:"Hyperlink"}),t.appendChild(this.controls.link),this.controls.figure_reference=i("a.control.toggle-annotation.figure_reference",{href:"#",html:'<i class="icon-picture"></i>'}),t.appendChild(this.controls.figure_reference),this.controls.remark_reference=i("a.control.toggle-annotation.remark_reference",{href:"#","sbs-click":"performAction(remark_reference)",html:'<i class="icon-pencil"></i>'}),t.appendChild(this.controls.remark_reference),this.controls.error_reference=i("a.control.toggle-annotation.error_reference",{href:"#","sbs-click":"performAction(error_reference)",html:'<i class="icon-warning-sign"></i>'}),t.appendChild(this.controls.error_reference);var e=i(".workflows.group");this.controls.new_doc=i("a.new-document",{href:"#",html:'<i class="icon-file-alt"></i><span class="label">New</span>'}),e.appendChild(this.controls.new_doc),this.controls.save=i("a.toggle-annotation.save.control.disable",{href:"#",html:'<i class="icon-save"></i><span class="label">Save</span>'}),e.appendChild(this.controls.save),window.brackets||(this.controls["export"]=i("a.toggle-annotation.export",{href:"#",html:'<i class="icon-download-alt"></i><span class="label">Export</span>'}),e.appendChild(this.controls["export"])),this.controls.publish=i("a.toggle-publish-settings",{href:"#",html:'<i class="icon-github"></i><span class="label">Publish</span>'}),e.appendChild(this.controls.publish),this.controls.about=i("a.about",{href:"#",html:'<i class="icon-info"></i><span class="label">About</span>'}),e.appendChild(this.controls.about);var n=i(".workflows.group");this.controls.insertcontent=i("a.control.add-ref",{href:"#","sbs-click":"toggleContext(insertcontent)",html:'<i class="icon-align-left"></i> <span class="label">Content <i class="icon-caret-down"></i></span>'}),n.appendChild(this.controls.insertcontent),window.brackets||(this.controls.export_zip=i("a.export-zip",{href:"#",html:""}),n.appendChild(this.controls.export_zip));var r=i(".insert-resources.group");this.controls.insertfigure=i("a.toggle-annotation.insert-figure",{href:"#","sbs-click":"addFigure()",html:'<i class="icon-plus"></i><span class="label">Add Figure</span>'}),r.appendChild(this.controls.insertfigure),this.controls.insertcontributor=i("a.toggle-annotation.insert-contributor",{href:"#","sbs-click":"addContributor()",html:'<i class="icon-plus"></i><span class="label">Add Author</span>'}),r.appendChild(this.controls.insertcontributor);var o=i(".toolbar-inner"),s=i(".groups");return s.appendChild(e),s.appendChild(n),s.appendChild(t),s.appendChild(r),o.appendChild(s),this.contextBar=i(".context-bar"),o.appendChild(this.contextBar),this.el.appendChild(o),this.disableControls(),this},this.showError=function(t){this.contextBar.innerHTML="",this.contextBar.appendChild(i(".error",{text:t}))},this.hideError=function(){var t=this.contextBar.querySelector(".error");t&&this.contextBar.removeChild(t)},this.update=function(){var t=this.toolbarCtrl.parentAdapter.getActions(),e=this.toolbarCtrl.parentAdapter.getDocument();this.$(".toggle-annotation.active").removeClass("active"),this.disableControls(),this.actions={};for(var n=0;n<t.length;n++){var i=t[n];this.actions[i.type]=i}this.updateAnnotationToggles(),this.updateAddContentDropDown(),e.__dirty?$(this.controls.save).removeClass("disable"):$(this.controls.save).addClass("disable")},this.updateAddContentDropDown=function(){var t=this.controls.insertcontent;this.actions.heading||this.actions.figure_reference?t.classList.remove("disable"):(t.classList.add("disable"),console.log("NOT heading and figref"))},this.updateAnnotationToggles=function(){r.each(this.actions,function(t){var e=this.controls[t.type];if(e){switch(t.action){case"deleteAnnotation":e.classList.add("active")}e.classList.remove("disable")}},this)},this.annotate=function(t){this.toolbarCtrl.annotate(t)},this.notImplemented=function(){console.error("Callback not implemented",arguments)},this.performAction=function(t){var e=this.actions[t];e?(this.toolbarCtrl.parentAdapter.performAction(e),this.update()):console.error("No action available for",t)},this.toggleContext=function(t){var e=this.toolbarCtrl.state;e.id===t?this.toolbarCtrl.transition({id:"main"}):this.toolbarCtrl.transition({id:t})},this.disableControls=function(){this.$("a.control").addClass("disable")},this.createRef=function(t,e){var n=this.actions[t+"_reference"];if(n)switch(n.action){case"deleteAnnotation":this.performAction(t+"_reference");break;case"createAnnotation":this.toolbarCtrl.beginAddRef(t),e.preventDefault()}},this.beginAddRef=function(t){this.toolbarCtrl.beginAddRef(t)},this.endAddRef=function(){this.toolbarCtrl.endAddRef()},this.endImageUrl=function(){this.toolbarCtrl.endImageUrl()},this.addFigure=function(){this.toolbarCtrl.parentAdapter.addFigure()},this.addContributor=function(){this.toolbarCtrl.parentAdapter.addContributor()},this.dispose=function(){this.stopListening()},this.getState=function(){return this.toolbarCtrl.state}},c.Prototype.prototype=n.prototype,c.prototype=new c.Prototype,c.prototype.constructor=c,e.exports=c},{"./add_reference_view":209,"./insert_content_view":210,"./link_editor_view":211,"substance-application":4,underscore:151}],214:[function(t,e){"use strict";var n=function(t){this.writerCtrl=t,this.el=document.createElement("DIV"),this.el.setAttribute("contenteditable","true"),this.el.classList.add("clipboard"),this.fragment=null,this.el.onpaste=this.onPaste.bind(this)};n.Prototype=function(){this.onPaste=function(){var t=this;window.setTimeout(function(){if(t.fragment);else{var e=window.document.createRange();e.selectNode(t.el);var n=e.toString();try{t.writerCtrl.currentController.write(n)}catch(i){t.writerCtrl.onError(i)}}t.el.innerHTML=""},0)},this.attachSurface=function(t){var e=this,n=t.keyboard;n.bind("copy","keydown",function(){}),n.bind("cut","keydown",function(t){var n=window.getSelection(),i=n.getRangeAt(0),r=i.cloneContents();e.el.innerHTML="",e.el.appendChild(r);try{e.writerCtrl.currentController.delete()}catch(o){return e.writerCtrl.onError(o),t.preventDefault(),t.stopPropagation(),void 0}var s=document.createRange();s.selectNodeContents(e.el),n.removeAllRanges(),n.addRange(s),window.setTimeout(function(){var t=e.writerCtrl.currentController.session.selection;t.set(t)},0)}),n.bind("paste","keydown",function(){e.el.innerHTML="";var t=window.getSelection(),n=document.createRange();n.setStart(e.el,0),t.removeAllRanges(),t.addRange(n)})}},n.prototype=new n.Prototype,e.exports=n},{}],215:[function(t,e){var n=self,i=t("substance-application").Controller,r=t("./writer_view"),o=t("underscore"),s=t("substance-editor").EditorController,a=t("substance-operator").ArrayOperation,c=t("./editors/richtext_editor_factory"),h=t("./editors/figures_editor_factory"),u=t("./editors/infos_editor_factory"),l=t("./editors/issues_editor_factory"),p=t("./editors/richtext_annotator"),d=t("substance-document"),f=d.Session,g=d.Container,v=t("substance-util"),y=t("./focus_controller"),m=t("./publish/publish_controller"),w=function(t,e){this.document=t,this.options=e||{},this.keymap=w._getDefaultKeyMap()};w.Prototype=function(){function t(t){setTimeout(function(){t.view.tocView&&t.view.tocView.render()},0)}var e=i.prototype;this.createView=function(){return this.view||(this.view=new r(this,this.options)),this.view},this.initialize=function(t,e){var n=this.document;this.lastContext="toc";var i=new g.DefaultNodeSurfaceProvider(n);this.contentCtrl=new s(new f(new g(n,"content",i)),new c(n)),this.annotator=new p,n.get("figures")&&(this.figuresCtrl=new s(new f(new g(n,"figures",i)),new h)),n.get("info")&&(this.infoCtrl=new s(new f(new g(n,"info",i)),new u)),n.get("remarks")&&(this.remarksCtrl=new s(new f(new g(n,"remarks",i)),new l)),n.get("errors")&&(this.errorsCtrl=new s(new f(new g(n,"errors",i)),new l)),this.referenceIndex=n.indexes.references||n.addIndex("references",{types:["figure_reference","person_reference","remark_reference","error_reference"],property:"target"});var r=["content","figures","info","errors","remarks"];this.allCtrls=o.map(r,function(t){return this[t+"Ctrl"]},this),o.each(this.allCtrls,function(t){this.listenTo(t.session.selection,"selection:changed",this.onSelectionChange.bind(this,t)),this.listenTo(t,"document:edited",this.onDocumentEdit),this.listenTo(t,"error",this.onError)},this),this.listenTo(this.document,"property:updated",this.onPropertyUpdate),this.createView().render(),e(null)},this.transition=function(t,e){if(t.id===this.state.id){var n=!1;
switch(t.id){case"main":n=t.contextId===this.state.contextId&&t.resourceId===this.state.resourceId&&t.nodeId===this.state.nodeId;break;case"focus":n=!0;break;case"addref":n=!0;break;case"imageurl":n=!0}if(n)return e(null)}switch(o.include(["focus","publish"],this.state.id)&&(this.disposeChildController(),this.focusCtrl=null,this.publishController=null),t.id){case"focus":this.focusCtrl=new y(this.document),this.setChildController(this.focusCtrl);break;case"publish":this.publishCtrl=new m(this.document,this),this.setChildController(this.publishCtrl)}e(null)},this.dispose=function(){if(e.dispose.call(this),this.stopListening(),this.view&&this.view.dispose(),this.contentCtrl&&this.contentCtrl.dispose(),this.figuresCtrl&&this.figuresCtrl.dispose(),this.infoCtrl&&this.infoCtrl.dispose(),this.issueCtrl&&this.issueCtrl.dispose(),this.referenceIndex&&this.referenceIndex.dispose(),this.__saveDocumentThread&&window.clearInterval(this.__saveDocumentThread),this.childController&&this.childController.dispose(),this.document.__backend__){var t=this;this.document.__backend__.save(function(e){e?console.error("Could not save document:",t.document.id):t.document.__backend__.close()})}this.view=null,this.contentCtrl=null,this.figuresCtrl=null,this.infoCtrl=null,this.referenceIndex=null,this.__saveDocumentThread=null},this.afterTransition=function(t){this.view&&this.view.updateState(this.state,t)};var n={figure_reference:"figures",contributor_reference:"info",remark_reference:"remarks",error_reference:"errors"},d=function(t){return void 0!==n[t.type]},w=function(t,e,n){var i,r=t.state,s=[],a="content"===t.getCurrentView()?"right":"left";if("content"===t.getCurrentView())s.push({id:"main",contextId:e,resourceId:n}),t.switchState(s,{updateRoute:!0,replace:!1});else{if("focus"===r.id&&(i=t.focusCtrl.state,i.contextId===e&&i.resourceId===n&&i.side===a))return;var c=o.clone(r);c.id="focus",s.push(c),i={id:"default",contextId:e,resourceId:n,side:"left"},s.push(i),t.switchState(s,{updateRoute:!0,replace:!1,"no-scroll":!0})}};this.onSelectionChange=function(t){this.currentController=t,this.viewName=t.session.container.name,this.currentSession=t.session,this.view.onSelectionUpdate(),this.__lastError&&(this.view.hideError(),this.__lastError=null);var e=this.currentSession.annotator.getAnnotations(this.currentSession.selection);e=o.filter(e,d);var i=Object.keys(e);if(1===i.length){var r=e[i[0]];w(this,n[r.type],r.target)}else if(o.include(["figures","info","errors","remarks"],this.viewName)){if(!this.currentSession.selection.isNull()){var s=this.currentSession.selection.getCursor(),a=this.currentSession.container.getRootNodeFromPos(s.pos);this.switchState({id:"main",contextId:this.state.contextId,resourceId:a.id},{updateRoute:!0,replace:!0,"no-scroll":!0})}}else this.switchState({id:"main",contextId:this.state.contextId},{updateRoute:!0,replace:!0})},this._scheduleSaveDocument=function(){var t=this;!this.document.__backend__&&!t.options.onAutoSave||this.__saveDocumentTask||(this.__saveDocumentTask=window.setTimeout(function(){t.view&&(t.options.onAutoSave&&t.options.onAutoSave(),this.document.__backend__&&t.document.__backend__.save(),t.view.updateOutline()),t.__saveDocumentTask=null},2e3))},this.onDocumentEdit=function(){this.view&&(this.document.__dirty=!0,this.view.toolbarView.update(),this.options.onDocumentEdit&&this.options.onDocumentEdit(),this._scheduleSaveDocument())},this.onError=function(t){console.error(t.message),v.printStackTrace(t),"SelectionError"===t.name||this.view.onError(t),this.__lastError=t},this.onPropertyUpdate=function(e){if(this.view){var n=!1;if("content"===e[0])n=!0;else if("content"===e[1]||"level"===e[1]){var i=this.document.get(e[0]);"heading"===i.type&&(n=!0)}n&&t(this)}},this.getContextId=function(){return this.state.contextId||"toc"},this.getResourceReferenceContainers=function(t){var e=this.referenceIndex.get(t),n=this.contentCtrl.session.container,i=o.uniq(o.map(e,function(t){return n.lookupRootNode(t.path[0])}));return i},this.getCurrentView=function(){return this.viewName||"content"},this.hasFigures=function(){return this.figuresCtrl},this.hasInfo=function(){return this.infoCtrl},this.hasRemarks=function(){return this.remarksCtrl},this.hasErrors=function(){return this.errorsCtrl},this.createAnnotation=function(t,e){this.currentController.annotate(t,e)},this.deleteAnnotation=function(t){this.currentController.deleteAnnotation(t)},this.updateNode=function(t,e,n){this.currentController.updateNode(t,e,n)},this.beginAddRef=function(t){if(!this.currentSession)return console.error("Workflow 'AddRef': nothing selected."),!1;this._oldState=o.clone(this.state);var e;switch(t){case"figure":e="figures";break;default:return console.error("Type not supported for 'AddRef' workflow",t),!1}console.log("Beginning AddRef Workflow",e);var n=this.currentSession.container,i=this.currentSession.selection;if(i.isNull())throw new Error("Selection is null.");var r=this.currentSession.container.id,s=i.getCursor(),a=n.getRootNodeFromPos(s.pos),c=s.charPos;this.switchState({id:"addref",contextId:e,containerId:r,nodeId:a.id,charPos:""+c})},this.endAddRef=function(t){if("addref"!==this.state.id&&console.error("Not in 'addref' workflow"),t){var e;"content"===this.state.containerId?e=this.contentCtrl:"figures"===this.state.containerId&&(e=this.figuresCtrl);var n,i=this.document.get(t);switch(i.type){case"figure":n="figure_reference";break;default:console.error("No reference type for resource",i.type)}n&&e.addReference(n,{target:t})}else console.log("Cancelled 'AddRef'.");var r=this._oldState;this._oldState=null,this.switchState(r)},this.addFigure=function(){var t=this,e=this.document.get("figures").nodes.length+1,n={id:"text_"+v.uuid(),type:"text",content:"Enter caption"},i={type:"figure",id:"figure_"+v.uuid(),url:"",image:"",label:"Figure "+e,caption:n.id};this.document.create(n),this.document.create(i),this.document.show("figures",i.id,-1),this.switchState({id:"main",contextId:"figures",resourceId:i.id},function(){var e=t.figuresCtrl.session.container,n=e.getNodeComponents(i.id)[1].pos;t.figuresCtrl.session.selection.set([n,0]),t.onDocumentEdit()})},this.addContributor=function(){var t={id:"contributor_"+v.uuid(),type:"contributor",role:"author",name:"John Doe",image:"",url:"",organization:"ACME",email:"john@doe.com"};this.document.create(t),this.document.show("info",t.id,-1),this.document.set(["document","authors"],this.document.get("info").nodes),this.switchState({id:"main",contextId:"info",resourceId:t.id})},this.deleteResource=function(t,e){var n=this.document,i=n.get(e),r=this.referenceIndex.get(e);if(o.each(r,function(t){n.delete(t.id)},this),i.image){var s=n.get(i.image);n.delete(s.id),n.deleteBlob(s.blob)}n.hide(t,e);var c=a.Delete(n.authors,e);n.update(["document","authors"],c),n.delete(e),n.chronicle.mark("master"),this._scheduleSaveDocument();var h=o.clone(this.state);"focus"===this.state.id?h.id="main":"main"===this.state.id&&delete h.resourceId,this.switchState(h,{updateRoute:!0,replace:!0})}},w.Prototype.prototype=i.prototype,w.prototype=new w.Prototype,w._getDefaultKeyMap=function(){var e=t("./default_keymap_osx");if(void 0!==n.navigator){var i=n.navigator.platform;i.toLowerCase().search("linux")>=0?e=t("./default_keymap_unix"):i.toLowerCase().search("win32")>=0&&(e=t("./default_keymap_unix"))}return e},e.exports=w},{"./default_keymap_osx":152,"./default_keymap_unix":153,"./editors/figures_editor_factory":159,"./editors/infos_editor_factory":161,"./editors/issues_editor_factory":163,"./editors/richtext_annotator":166,"./editors/richtext_editor_factory":167,"./focus_controller":169,"./publish/publish_controller":204,"./writer_view":216,"substance-application":4,"substance-document":35,"substance-editor":43,"substance-operator":130,"substance-util":144,underscore:151}],216:[function(t,e){"use strict";var n,i,r,o=t("underscore"),s=t("substance-editor"),a=t("lens-outline"),c=t("substance-application").View,h=t("./toolbar/toolbar_controller"),u=t("substance-toc"),l=t("substance-application").$$,p=t("./web_clipboard"),d=-100,f=function(t,e){c.call(this),this.writerCtrl=t,this.options=e||{};var n=this.writerCtrl.document;this.$el.addClass("article"),this.$el.addClass(n.schema.id),this.clipboard=new p(this.writerCtrl),this.contentView=i(this,n,"content"),this.contentView.el.classList.add("content"),this.toolbarCtrl=new h(new f.ToolbarAdapter(this.writerCtrl)),this.toolbarView=this.toolbarCtrl.createView(),this.tocView=new u(this.writerCtrl.contentCtrl),this.tocView.SHOW_ALWAYS=!0,this.tocView.$el.addClass("resource-view"),this.writerCtrl.hasFigures()&&r(this,n,"figures"),this.writerCtrl.hasInfo()&&r(this,n,"info"),this.writerCtrl.hasRemarks()&&r(this,n,"remarks"),this.writerCtrl.hasErrors()&&r(this,n,"errors"),this.resources=this.writerCtrl.referenceIndex,this.outline=new a(this.contentView),this.resourcesOutline=new a(this.figuresView),this.contentView.$el.on("scroll",o.bind(this.onContentScroll,this)),this.selectionState="no-selection",this.figuresView.$el.on("scroll",o.bind(this.onResourceContentScroll,this)),this.infoView.$el.on("scroll",o.bind(this.onResourceContentScroll,this)),this.remarksView.$el.on("scroll",o.bind(this.onResourceContentScroll,this)),this.errorsView.$el.on("scroll",o.bind(this.onResourceContentScroll,this)),this.$el.on("click",".resources .content-node .delete-resource",o.bind(this.deleteResource,this)),this.$el.on("click",".authors .toggle-author",o.bind(this.toggleAuthor,this)),this.$el.on("click",".toggle-publish-settings",o.bind(this.togglePublishSettings,this)),this.$el.on("change",".figure-image-file",o.bind(this.handleFileSelect,this)),this.$el.on("change",".contributor-image-file",o.bind(this.handleFileSelect,this))};f.Prototype=function(){this.togglePublishSettings=function(t){var e=o.clone(this.writerCtrl.state);"publish"===e.id?(e.id="main",this.writerCtrl.switchState([e],{updateRoute:!0,replace:!0})):(e.id="publish",this.writerCtrl.switchState([e,{id:"default"}])),t.preventDefault()},this.handleFileSelect=function(t){var e=this,n=e.writerCtrl.document,i=t.target.files,r=$(t.currentTarget).attr("data-id"),o=i[0],s=new FileReader;return s.onload=function(t){var i,o=n.get(r),s=o.id+".png";console.log("uploading le image",s),o.image&&n.get(o.image)?(i=n.get(s),i.updateData(t.target.result)):(console.log("image for the first tiiime"),i=n.create({id:s,type:"file",content_type:"image/png"}),i.updateData(t.target.result),n.set([r,"image"],i.id),n.set([r,"url"],"")),e.writerCtrl.onDocumentEdit()},s.readAsArrayBuffer(o),!1},this.toggleAuthor=function(t){var e=t.currentTarget.getAttribute("data-id"),n=this.writerCtrl.state;return n.resourceId===e?this.writerCtrl.switchState({id:"main",contextId:"toc"}):this.writerCtrl.switchState({id:"main",contextId:"info",resourceId:e}),!1},this.deleteResource=function(t){var n=e(t.currentTarget,".content-node"),i=e(t.currentTarget,".resource-view"),r=n.getAttribute("id"),o=i.getAttribute("id");return this.writerCtrl.deleteResource(o,r),!1},this.updateImageUrl=function(t){var e=$(t.currentTarget).attr("id");return this.writerCtrl.beginImageUrl(e),!1},this.setAnchor=function(t){this.toggleNode("toc",$(t.currentTarget).attr("id"))},this.toggleFullscreen=function(){var t=this.writerCtrl.state,e=t.fullscreen||!1,n=o.clone(t);n.fullscreen=!e,this.writerCtrl.switchState(n)},this._jumpToNode=function(t){var e=$(t.currentTarget).attr("id").replace("outline_","");return this.jumpToNode(e),!1},this.followCrossReference=function(t){var e=$(t.currentTarget).attr("id"),n=this.writerCtrl.document.get(e);this.jumpToNode(n.target)},this.onContentScroll=function(){var t=this.contentView.$el.scrollTop();this.outline.updateVisibleArea(t),this.markActiveHeading(t)},this.onSelectionUpdate=function(){this.toolbarCtrl.update()},this.onResourceContentScroll=function(){var t=this.resourcesOutline.surface.$el.scrollTop();this.resourcesOutline.updateVisibleArea(t)},this.markActiveHeading=function(t){var e=$(".nodes").height();if(0!==this.tocView.headings.length){var n=o.first(this.tocView.headings).id;this.contentView.$(".content-node.heading").each(function(){t>=$(this).position().top+d&&(n=this.id)}),t+this.contentView.$el.height()>=e&&(n=o.last(this.tocView.headings).id),this.tocView.setActiveNode(n)}},this.jumpToNode=function(t){var e=$("#"+t);if(e.length>0){var n=e.position().top+d;this.contentView.$el.scrollTop(n)}},this.jumpToResource=function(t){var e=$("#"+t);if(e.length>0){var n=e.position().top;this.figuresView&&this.figuresView.$el.scrollTop(n),this.infoView&&this.infoView.$el.scrollTop(n),this.remarksView&&this.remarksView.$el.scrollTop(n),this.errorsView&&this.errorsView.$el.scrollTop(n)}},this.getScroll=function(){return $("body").scrollTop()},this.switchContext=function(t){this.writerCtrl.switchState({id:"main",contextId:t})},this.back=function(){this.options.back&&this.options.back()},this.updateState=function(t,e){if(t){if(this.$el.removeClass(),this.$el.addClass("article substance-article "+this.selectionState),this.contentView.$(".content-node.active").removeClass("active"),this.$(".annotation.active").removeClass("active"),this.$(".context-toggle").removeClass("focus").removeClass("left").removeClass("right"),this.$el.addClass("state-"+t.id),this.$el.addClass(this.writerCtrl.getContextId()),void 0!==t.nodeId&&this.contentView.$("#"+t.nodeId).addClass("active"),"addref"===t.id){console.error("HACK: Attaching click handler....");var n;switch(t.contextId){case"figures":n="figure",this.figuresView.deactivate()}n&&(this.$addRefEls=this.$(".resource-view."+t.contextId+" .content-node."+n),this.$addRefEls.on("click",function(t){var e=t.currentTarget.id;this.writerCtrl.endAddRef(e),t.preventDefault()}.bind(this)))}if("addref"===e.id){switch(e.contextId){case"figures":this.figuresView.activate()}this.$addRefEls.off("click")}if("focus"===e.id&&(this.focusPanelEl.innerHTML="",$(this.focusPanelEl).hide()),"focus"===t.id){var i=this.writerCtrl.focusCtrl;this.focusPanelEl.appendChild(i.view.el),$(this.focusPanelEl).show(),$(this.focusPanelEl).removeClass("left").removeClass("right").addClass(i.state.side);var r=this.$(".context-toggle."+i.state.contextId);r.addClass("focus"),r.addClass(i.state.side)}if("publish"===e.id&&(this.publishPanelEl.innerHTML="",$(this.publishPanelEl).hide(),this.$(".toggle-publish-settings").removeClass("active")),"publish"===t.id){var o=this.writerCtrl.publishCtrl;this.publishPanelEl.appendChild(o.view.el),$(this.publishPanelEl).show(),this.$(".toggle-publish-settings").addClass("active")}this.updateOutline(),this.updateResource()}},this.updateResource=function(){var t=this.writerCtrl.state;if(t){this.$(".resources .content-node.active").removeClass("active fullscreen"),this.$(".toggle-author").removeClass("active");var e;if(void 0!==t.resourceId){var n=this;o.delay(function(){t.nodeId&&n.jumpToNode(t.nodeId),t.resourceId&&!t.options["no-scroll"]&&n.jumpToResource(t.resourceId)},0);var i=this.$("#"+t.resourceId);if(i.addClass("active"),t.fullscreen&&i.addClass("fullscreen"),e=this.resources.get(t.resourceId),o.each(e,function(t){this.contentView.$("#"+t.id).addClass("active")},this),this.$("#toggle_"+t.resourceId).addClass("active"),"focus"===t.id){var r=this.writerCtrl.focusCtrl.state;e=this.resources.get(r.resourceId),o.each(e,function(t){this.$("#"+t.id).addClass("active")},this)}}}},this.updateOutline=function(){var t=this,e=this.writerCtrl.state;if(e){var n,i=this.writerCtrl.getContextId(),r={context:i};if(void 0!==e.resourceId)n=this.writerCtrl.getResourceReferenceContainers(e.resourceId),r.highlightedNodes=n;else if(void 0!==e.nodeId)r.selectedNode=e.nodeId;else if("focus"===e.id){var o=this.writerCtrl.focusCtrl.state;n=this.writerCtrl.getResourceReferenceContainers(o.resourceId),r.highlightedNodes=n,r.context=o.contextId}if(t.outline.update(r),"toc"===e.contextId)return $(t.resourcesOutline.el).addClass("hidden"),void 0;t.resourcesOutline.surface="figures"===e.contextId?this.figuresView:"remarks"===e.contextId?this.remarksView:"errors"===e.contextId?this.errorsView:this.infoView,$(t.resourcesOutline.el).removeClass("hidden"),t.resourcesOutline.update({context:e.contextId,highlightedNodes:[e.resourceId]})}},this.annotate=function(t){return this.writerCtrl.content.annotate(t),!1},this.render=function(){var e=this;this.el.appendChild(t(this)),this.$(".document").append(e.outline.el),this.resourcesEl=this.el.querySelector(".resources"),this.resourcesEl.appendChild(e.resourcesOutline.el);var n=o.debounce(function(){e.updateOutline()},1);return $(window).resize(n),o.delay(function(){e.updateOutline()},0),this},this.dispose=function(){this.stopListening(),this.contentView&&this.contentView.dispose(),this.figuresView&&this.figuresView.dispose(),this.infoView&&this.infoView.dispose()},this.onError=function(t){var e=t.message;this.toolbarView.showError(e)},this.hideError=function(){this.toolbarView.hideError()};var t=function(t){var e=document.createDocumentFragment(),n=l(".document");n.appendChild(t.contentView.render().el);var i=[];t.tocView&&i.push(l("a.context-toggle.toc",{href:"#","sbs-click":"switchContext(toc)",title:"Text",html:'<i class="icon-caret-left left-arrow"></i><i class="icon-align-left"></i><i class="icon-caret-right right-arrow"></i><span> Text</span>'})),t.figuresView&&i.push(l("a.context-toggle.figures",{href:"#","sbs-click":"switchContext(figures)",title:"Figures",html:'<i class="icon-caret-left left-arrow"></i><i class="icon-picture"></i><i class="icon-caret-right right-arrow"></i><span> Figures</span>'})),t.infoView&&i.push(l("a.context-toggle.info",{href:"#","sbs-click":"switchContext(info)",title:"Article Info",html:'<i class="icon-caret-left left-arrow"></i><i class="icon-info-sign"></i><i class="icon-caret-right right-arrow"></i><span>Info</span>'})),t.remarksView&&i.push(l("a.context-toggle.remarks",{href:"#","sbs-click":"switchContext(remarks)",title:"Remarks",html:'<i class="icon-caret-left left-arrow"></i><i class="icon-pencil"></i><i class="icon-caret-right right-arrow"></i><span> Remarks</span>'})),t.errorsView&&i.push(l("a.context-toggle.errors",{href:"#","sbs-click":"switchContext(errors)",title:"Errors",html:'<i class="icon-caret-left left-arrow"></i><i class="icon-warning-sign"></i><i class="icon-caret-right right-arrow"></i><span> Errors</span>'}));var r=l(".context-toggles",{children:i}),o=l(".medial-strip");if(t.options.back){var s=l("a.back-nav",{href:"#",title:"Go back",html:'<i class=" icon-chevron-up"></i>'});s.onclick=function(e){t.options.back(),e.preventDefault()},o.appendChild(s)}o.appendChild(l(".separator-line")),o.appendChild(r);var a=l(".resources");a.appendChild(o),a.appendChild(t.tocView.render().el),t.figuresView&&a.appendChild(t.figuresView.render().el),t.infoView&&a.appendChild(t.infoView.render().el),t.remarksView&&a.appendChild(t.remarksView.render().el),t.errorsView&&a.appendChild(t.errorsView.render().el);var c=t.toolbarView.render().el;return t.publishPanelEl=l(".publish-panel"),t.focusPanelEl=l(".focus-panel"),e.appendChild(c),e.appendChild(t.publishPanelEl),e.appendChild(n),e.appendChild(a),e.appendChild(t.focusPanelEl),e.appendChild(t.clipboard.el),e},e=function(t,e){for(var n=t;void 0!==n;){if($(n).is(e))return n;n=n.parentElement}return null}},f.ToolbarAdapter=function(t){this.getDocument=function(){return t.document},this.endImageUrl=function(){t.endImageUrl()},this.beginAddRef=function(e){t.beginAddRef(e)},this.endAddRef=function(){t.endAddRef(null)},this.addFigure=function(){t.addFigure()},this.addContributor=function(){t.addContributor()},this.addCitation=function(){t.addCitation()},this.updateNode=function(e,n,i){t.updateNode(e,n,i)},this.insertNode=function(e,n){t.currentController.insertNode(e,n)},this.createIssue=function(e,n){t.createIssue(e,n)},this.createNode=function(e){return t.document.create(e)},this.showNodes=function(e,n){return t.document.show(e,n)},this.getActions=function(){var e=t.currentSession;if(!e)return[];var n=t.annotator.getAllowedActions(e,e.selection);return n=n.concat(t.currentController.getAllowedActions())},this.getAnnotations=function(){var e=t.currentSession;return e.annotator.getAnnotations(e.selection)},this.getActiveAnnotation=function(){var t=this.getAnnotations();return t.length>1?null:t[0]},this.performAction=function(e){switch(e.action){case"createAnnotation":t.createAnnotation(e.type,e.data);break;case"deleteAnnotation":t.deleteAnnotation(e.id);break;default:return console.error("Action not implemented: ",e),void 0}}},f.Prototype.prototype=c.prototype,f.prototype=new f.Prototype,f.prototype.constructor=f,n=function(t,e){return t.createRenderer(e)},i=function(t,e,i){var r=t.writerCtrl[i+"Ctrl"],o=n(e,i),a=new s(r,o,{keymap:t.writerCtrl.keymap});t.clipboard.attachSurface(a),a.keyboard.bind("figref","keypress",function(e){t.writerCtrl.beginAddRef("figure"),e.preventDefault(),e.stopPropagation()});var c=o.render;return o.render=function(){var t=c.apply(o,arguments);return r.session.container.rebuild(),t},r.session.container.renderer=o,a},r=function(t,e,n){var r=n+"View";t[r]=i(t,e,n);var o=t[r].el;o.classList.add(n),o.classList.add("resource-view"),o.setAttribute("id",n)},e.exports=f},{"./toolbar/toolbar_controller":212,"./web_clipboard":214,"lens-outline":2,"substance-application":4,"substance-editor":43,"substance-toc":142,underscore:151}],217:[function(){},{}]},{},[1]);